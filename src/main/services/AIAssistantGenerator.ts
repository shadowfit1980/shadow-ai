/**
 * ðŸ¤– AIAssistantGenerator
 * 
 * AI Assistants:
 * - Function calling, tools, agents
 */

import { EventEmitter } from 'events';

export class AIAssistantGenerator extends EventEmitter {
    private static instance: AIAssistantGenerator;
    private constructor() { super(); }
    static getInstance(): AIAssistantGenerator {
        if (!AIAssistantGenerator.instance) {
            AIAssistantGenerator.instance = new AIAssistantGenerator();
        }
        return AIAssistantGenerator.instance;
    }

    generate(): string {
        return `// AI Assistant Generator - Function calling, tools, agents
// Generated by Shadow AI

import OpenAI from 'openai';

// Tool Definition
interface Tool {
    name: string;
    description: string;
    parameters: {
        type: 'object';
        properties: Record<string, any>;
        required?: string[];
    };
    execute: (args: any) => Promise<any>;
}

// AI Assistant
class AIAssistant {
    private openai: OpenAI;
    private tools: Map<string, Tool> = new Map();
    private systemPrompt: string;
    private conversationHistory: any[] = [];
    
    constructor(systemPrompt: string) {
        this.openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });
        this.systemPrompt = systemPrompt;
    }
    
    registerTool(tool: Tool) {
        this.tools.set(tool.name, tool);
    }
    
    async chat(userMessage: string): Promise<string> {
        this.conversationHistory.push({ role: 'user', content: userMessage });
        
        const response = await this.openai.chat.completions.create({
            model: 'gpt-4-turbo-preview',
            messages: [
                { role: 'system', content: this.systemPrompt },
                ...this.conversationHistory
            ],
            tools: this.getToolDefinitions(),
            tool_choice: 'auto'
        });
        
        const message = response.choices[0].message;
        
        // Handle tool calls
        if (message.tool_calls) {
            const toolResults = await Promise.all(
                message.tool_calls.map(async (call) => {
                    const tool = this.tools.get(call.function.name);
                    if (!tool) throw new Error(\`Unknown tool: \${call.function.name}\`);
                    
                    const args = JSON.parse(call.function.arguments);
                    const result = await tool.execute(args);
                    
                    return {
                        tool_call_id: call.id,
                        role: 'tool' as const,
                        content: JSON.stringify(result)
                    };
                })
            );
            
            this.conversationHistory.push(message);
            this.conversationHistory.push(...toolResults);
            
            // Get final response after tool execution
            const finalResponse = await this.openai.chat.completions.create({
                model: 'gpt-4-turbo-preview',
                messages: [
                    { role: 'system', content: this.systemPrompt },
                    ...this.conversationHistory
                ]
            });
            
            const finalMessage = finalResponse.choices[0].message.content!;
            this.conversationHistory.push({ role: 'assistant', content: finalMessage });
            return finalMessage;
        }
        
        const assistantMessage = message.content!;
        this.conversationHistory.push({ role: 'assistant', content: assistantMessage });
        return assistantMessage;
    }
    
    private getToolDefinitions() {
        return Array.from(this.tools.values()).map(tool => ({
            type: 'function' as const,
            function: {
                name: tool.name,
                description: tool.description,
                parameters: tool.parameters
            }
        }));
    }
}

// Pre-built Tools
const builtInTools: Tool[] = [
    {
        name: 'search_web',
        description: 'Search the web for information',
        parameters: {
            type: 'object',
            properties: { query: { type: 'string', description: 'Search query' } },
            required: ['query']
        },
        execute: async ({ query }) => searchWeb(query)
    },
    {
        name: 'get_weather',
        description: 'Get current weather for a location',
        parameters: {
            type: 'object',
            properties: { location: { type: 'string', description: 'City name' } },
            required: ['location']
        },
        execute: async ({ location }) => getWeather(location)
    },
    {
        name: 'create_task',
        description: 'Create a new task in the task manager',
        parameters: {
            type: 'object',
            properties: {
                title: { type: 'string' },
                dueDate: { type: 'string', description: 'ISO date string' }
            },
            required: ['title']
        },
        execute: async ({ title, dueDate }) => createTask(title, dueDate)
    }
];

export { AIAssistant, builtInTools };
`;
    }
}

export const aiAssistantGenerator = AIAssistantGenerator.getInstance();
