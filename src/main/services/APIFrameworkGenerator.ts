/**
 * ðŸš€ API Framework Generator
 * 
 * Generate backend API code for:
 * - Express, Fastify, NestJS, Hono, Koa
 */

import { EventEmitter } from 'events';

export type APIFramework = 'express' | 'fastify' | 'nestjs' | 'hono' | 'koa';

export interface Route {
    method: 'GET' | 'POST' | 'PUT' | 'PATCH' | 'DELETE';
    path: string;
    handler: string;
    middleware?: string[];
}

export class APIFrameworkGenerator extends EventEmitter {
    private static instance: APIFrameworkGenerator;

    private constructor() { super(); }

    static getInstance(): APIFrameworkGenerator {
        if (!APIFrameworkGenerator.instance) {
            APIFrameworkGenerator.instance = new APIFrameworkGenerator();
        }
        return APIFrameworkGenerator.instance;
    }

    getSupportedFrameworks(): APIFramework[] {
        return ['express', 'fastify', 'nestjs', 'hono', 'koa'];
    }

    generateServer(framework: APIFramework): string {
        switch (framework) {
            case 'express': return this.generateExpress();
            case 'fastify': return this.generateFastify();
            case 'nestjs': return this.generateNestJS();
            case 'hono': return this.generateHono();
            case 'koa': return this.generateKoa();
            default: return '';
        }
    }

    private generateExpress(): string {
        return `// Express Server
// Generated by Shadow AI

import express from 'express';
import cors from 'cors';
import helmet from 'helmet';
import morgan from 'morgan';
import { rateLimit } from 'express-rate-limit';

const app = express();
const PORT = process.env.PORT || 3000;

// Middleware
app.use(cors());
app.use(helmet());
app.use(morgan('dev'));
app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// Rate limiting
const limiter = rateLimit({
    windowMs: 15 * 60 * 1000, // 15 minutes
    max: 100
});
app.use('/api/', limiter);

// Health check
app.get('/health', (req, res) => {
    res.json({ status: 'ok', timestamp: new Date().toISOString() });
});

// API Routes
app.use('/api/users', require('./routes/users'));
app.use('/api/auth', require('./routes/auth'));

// Error handling
app.use((err, req, res, next) => {
    console.error(err.stack);
    res.status(err.status || 500).json({
        error: err.message || 'Internal Server Error',
        ...(process.env.NODE_ENV === 'development' && { stack: err.stack })
    });
});

// 404 handler
app.use((req, res) => {
    res.status(404).json({ error: 'Not Found' });
});

app.listen(PORT, () => {
    console.log(\`Server running on port \${PORT}\`);
});

export default app;
`;
    }

    private generateFastify(): string {
        return `// Fastify Server
// Generated by Shadow AI

import Fastify from 'fastify';
import cors from '@fastify/cors';
import helmet from '@fastify/helmet';
import rateLimit from '@fastify/rate-limit';

const fastify = Fastify({ logger: true });

// Plugins
await fastify.register(cors);
await fastify.register(helmet);
await fastify.register(rateLimit, {
    max: 100,
    timeWindow: '15 minutes'
});

// Schema validation
const userSchema = {
    type: 'object',
    properties: {
        id: { type: 'string' },
        email: { type: 'string', format: 'email' },
        name: { type: 'string' }
    }
};

// Routes
fastify.get('/health', async () => {
    return { status: 'ok', timestamp: new Date().toISOString() };
});

fastify.get('/api/users', {
    schema: {
        response: { 200: { type: 'array', items: userSchema } }
    }
}, async (request, reply) => {
    return [];
});

fastify.post('/api/users', {
    schema: {
        body: userSchema,
        response: { 201: userSchema }
    }
}, async (request, reply) => {
    reply.code(201);
    return request.body;
});

// Error handler
fastify.setErrorHandler((error, request, reply) => {
    fastify.log.error(error);
    reply.status(error.statusCode || 500).send({
        error: error.message
    });
});

// Start server
const start = async () => {
    try {
        await fastify.listen({ port: 3000, host: '0.0.0.0' });
    } catch (err) {
        fastify.log.error(err);
        process.exit(1);
    }
};

start();
`;
    }

    private generateNestJS(): string {
        return `// NestJS Application
// Generated by Shadow AI

// main.ts
import { NestFactory } from '@nestjs/core';
import { ValidationPipe } from '@nestjs/common';
import { SwaggerModule, DocumentBuilder } from '@nestjs/swagger';
import helmet from 'helmet';
import { AppModule } from './app.module';

async function bootstrap() {
    const app = await NestFactory.create(AppModule);
    
    app.use(helmet());
    app.enableCors();
    app.useGlobalPipes(new ValidationPipe({ transform: true }));
    
    const config = new DocumentBuilder()
        .setTitle('API')
        .setVersion('1.0')
        .addBearerAuth()
        .build();
    
    const document = SwaggerModule.createDocument(app, config);
    SwaggerModule.setup('docs', app, document);
    
    await app.listen(3000);
}
bootstrap();

// app.module.ts
import { Module } from '@nestjs/common';
import { ConfigModule } from '@nestjs/config';
import { UsersModule } from './users/users.module';
import { AuthModule } from './auth/auth.module';

@Module({
    imports: [
        ConfigModule.forRoot({ isGlobal: true }),
        UsersModule,
        AuthModule
    ]
})
export class AppModule {}

// users/users.controller.ts
import { Controller, Get, Post, Body, Param, Put, Delete } from '@nestjs/common';
import { ApiTags, ApiOperation } from '@nestjs/swagger';

@ApiTags('users')
@Controller('users')
export class UsersController {
    @Get()
    @ApiOperation({ summary: 'Get all users' })
    findAll() {
        return [];
    }
    
    @Get(':id')
    findOne(@Param('id') id: string) {
        return { id };
    }
    
    @Post()
    create(@Body() createUserDto: any) {
        return createUserDto;
    }
    
    @Put(':id')
    update(@Param('id') id: string, @Body() updateUserDto: any) {
        return { id, ...updateUserDto };
    }
    
    @Delete(':id')
    remove(@Param('id') id: string) {
        return { deleted: id };
    }
}
`;
    }

    private generateHono(): string {
        return `// Hono Server (Edge-ready)
// Generated by Shadow AI

import { Hono } from 'hono';
import { cors } from 'hono/cors';
import { logger } from 'hono/logger';
import { prettyJSON } from 'hono/pretty-json';
import { secureHeaders } from 'hono/secure-headers';
import { validator } from 'hono/validator';
import { z } from 'zod';

const app = new Hono();

// Middleware
app.use('*', logger());
app.use('*', cors());
app.use('*', secureHeaders());
app.use('*', prettyJSON());

// Validation schemas
const userSchema = z.object({
    email: z.string().email(),
    name: z.string().min(1),
    password: z.string().min(8)
});

// Health check
app.get('/health', (c) => {
    return c.json({ status: 'ok', timestamp: new Date().toISOString() });
});

// Users API
app.get('/api/users', (c) => {
    return c.json([]);
});

app.post('/api/users',
    validator('json', (value, c) => {
        const parsed = userSchema.safeParse(value);
        if (!parsed.success) {
            return c.json({ error: parsed.error }, 400);
        }
        return parsed.data;
    }),
    (c) => {
        const user = c.req.valid('json');
        return c.json(user, 201);
    }
);

app.get('/api/users/:id', (c) => {
    const id = c.req.param('id');
    return c.json({ id });
});

// Error handling
app.onError((err, c) => {
    console.error(err);
    return c.json({ error: err.message }, 500);
});

app.notFound((c) => {
    return c.json({ error: 'Not Found' }, 404);
});

export default app;
`;
    }

    private generateKoa(): string {
        return `// Koa Server
// Generated by Shadow AI

import Koa from 'koa';
import Router from '@koa/router';
import bodyParser from 'koa-bodyparser';
import cors from '@koa/cors';
import helmet from 'koa-helmet';
import logger from 'koa-logger';

const app = new Koa();
const router = new Router();

// Middleware
app.use(logger());
app.use(helmet());
app.use(cors());
app.use(bodyParser());

// Error handling
app.use(async (ctx, next) => {
    try {
        await next();
    } catch (err) {
        ctx.status = err.status || 500;
        ctx.body = { error: err.message };
        ctx.app.emit('error', err, ctx);
    }
});

// Routes
router.get('/health', (ctx) => {
    ctx.body = { status: 'ok', timestamp: new Date().toISOString() };
});

router.get('/api/users', (ctx) => {
    ctx.body = [];
});

router.post('/api/users', (ctx) => {
    ctx.status = 201;
    ctx.body = ctx.request.body;
});

router.get('/api/users/:id', (ctx) => {
    ctx.body = { id: ctx.params.id };
});

// Apply routes
app.use(router.routes());
app.use(router.allowedMethods());

// 404 handler
app.use((ctx) => {
    ctx.status = 404;
    ctx.body = { error: 'Not Found' };
});

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
    console.log(\`Server running on port \${PORT}\`);
});

export default app;
`;
    }

    generateRESTRoutes(resource: string): string {
        const plural = resource.toLowerCase() + 's';
        return `// ${resource} Routes
import { Router } from 'express';
const router = Router();

router.get('/', async (req, res) => {
    const ${plural} = await ${resource}Service.findAll(req.query);
    res.json(${plural});
});

router.get('/:id', async (req, res) => {
    const ${resource.toLowerCase()} = await ${resource}Service.findById(req.params.id);
    if (!${resource.toLowerCase()}) return res.status(404).json({ error: 'Not found' });
    res.json(${resource.toLowerCase()});
});

router.post('/', async (req, res) => {
    const ${resource.toLowerCase()} = await ${resource}Service.create(req.body);
    res.status(201).json(${resource.toLowerCase()});
});

router.put('/:id', async (req, res) => {
    const ${resource.toLowerCase()} = await ${resource}Service.update(req.params.id, req.body);
    res.json(${resource.toLowerCase()});
});

router.delete('/:id', async (req, res) => {
    await ${resource}Service.delete(req.params.id);
    res.status(204).send();
});

export default router;
`;
    }
}

export const apiFrameworkGenerator = APIFrameworkGenerator.getInstance();
