/**
 * ðŸšª API Gateway Generator
 * 
 * Generate API gateway patterns:
 * - Kong, AWS API Gateway
 */

import { EventEmitter } from 'events';

export class APIGateway extends EventEmitter {
    private static instance: APIGateway;

    private constructor() { super(); }

    static getInstance(): APIGateway {
        if (!APIGateway.instance) {
            APIGateway.instance = new APIGateway();
        }
        return APIGateway.instance;
    }

    generateKong(): string {
        return `// Kong API Gateway
// Generated by Shadow AI

// === Kong Docker Compose ===
version: '3.8'
services:
  kong-database:
    image: postgres:15
    environment:
      POSTGRES_USER: kong
      POSTGRES_DB: kong
      POSTGRES_PASSWORD: kongpass
    volumes:
      - kong-data:/var/lib/postgresql/data

  kong-migration:
    image: kong:latest
    command: kong migrations bootstrap
    depends_on:
      - kong-database
    environment:
      KONG_DATABASE: postgres
      KONG_PG_HOST: kong-database
      KONG_PG_PASSWORD: kongpass

  kong:
    image: kong:latest
    depends_on:
      - kong-migration
    environment:
      KONG_DATABASE: postgres
      KONG_PG_HOST: kong-database
      KONG_PG_PASSWORD: kongpass
      KONG_PROXY_ACCESS_LOG: /dev/stdout
      KONG_ADMIN_ACCESS_LOG: /dev/stdout
      KONG_PROXY_ERROR_LOG: /dev/stderr
      KONG_ADMIN_ERROR_LOG: /dev/stderr
      KONG_ADMIN_LISTEN: 0.0.0.0:8001
    ports:
      - "8000:8000"   # Proxy
      - "8443:8443"   # Proxy SSL
      - "8001:8001"   # Admin API
      - "8444:8444"   # Admin SSL

volumes:
  kong-data:

// === Kong Declarative Config (kong.yml) ===
_format_version: "3.0"
_transform: true

services:
  - name: users-service
    url: http://users:3000
    routes:
      - name: users-route
        paths:
          - /api/users
        strip_path: false
    plugins:
      - name: rate-limiting
        config:
          minute: 100
          policy: local
      - name: jwt
        config:
          key_claim_name: kid
          claims_to_verify: [exp]

  - name: products-service
    url: http://products:3000
    routes:
      - name: products-route
        paths:
          - /api/products
    plugins:
      - name: cors
        config:
          origins: ["*"]
          methods: [GET, POST, PUT, DELETE]
          headers: [Content-Type, Authorization]
      - name: response-transformer
        config:
          add:
            headers: [X-Kong-Proxy:true]

  - name: orders-service
    url: http://orders:3000
    routes:
      - name: orders-route
        paths:
          - /api/orders
    plugins:
      - name: request-transformer
        config:
          add:
            headers: [X-Request-ID:\$(uuid)]

plugins:
  - name: prometheus
    config:
      per_consumer: true
  - name: file-log
    config:
      path: /tmp/kong.log

consumers:
  - username: mobile-app
    keyauth_credentials:
      - key: mobile-app-key
  - username: web-app
    jwt_secrets:
      - key: web-app
        algorithm: HS256
        secret: your-secret-key

upstreams:
  - name: users-upstream
    targets:
      - target: users-1:3000
        weight: 100
      - target: users-2:3000
        weight: 100
    healthchecks:
      active:
        http_path: /health
        healthy:
          interval: 5
          successes: 2
        unhealthy:
          interval: 5
          http_failures: 3
`;
    }

    generateAWS(): string {
        return `// AWS API Gateway (Terraform)
// Generated by Shadow AI

resource "aws_api_gateway_rest_api" "main" {
  name        = "my-api"
  description = "Main API Gateway"

  endpoint_configuration {
    types = ["REGIONAL"]
  }
}

# /users resource
resource "aws_api_gateway_resource" "users" {
  rest_api_id = aws_api_gateway_rest_api.main.id
  parent_id   = aws_api_gateway_rest_api.main.root_resource_id
  path_part   = "users"
}

# GET /users
resource "aws_api_gateway_method" "get_users" {
  rest_api_id   = aws_api_gateway_rest_api.main.id
  resource_id   = aws_api_gateway_resource.users.id
  http_method   = "GET"
  authorization = "COGNITO_USER_POOLS"
  authorizer_id = aws_api_gateway_authorizer.cognito.id
}

resource "aws_api_gateway_integration" "get_users" {
  rest_api_id             = aws_api_gateway_rest_api.main.id
  resource_id             = aws_api_gateway_resource.users.id
  http_method             = aws_api_gateway_method.get_users.http_method
  integration_http_method = "POST"
  type                    = "AWS_PROXY"
  uri                     = aws_lambda_function.users.invoke_arn
}

# Cognito Authorizer
resource "aws_api_gateway_authorizer" "cognito" {
  name          = "cognito-authorizer"
  type          = "COGNITO_USER_POOLS"
  rest_api_id   = aws_api_gateway_rest_api.main.id
  provider_arns = [aws_cognito_user_pool.main.arn]
}

# Usage Plan & API Key
resource "aws_api_gateway_usage_plan" "standard" {
  name = "standard"

  api_stages {
    api_id = aws_api_gateway_rest_api.main.id
    stage  = aws_api_gateway_stage.prod.stage_name
  }

  throttle_settings {
    burst_limit = 100
    rate_limit  = 50
  }

  quota_settings {
    limit  = 10000
    period = "MONTH"
  }
}

resource "aws_api_gateway_api_key" "mobile" {
  name = "mobile-app-key"
}

resource "aws_api_gateway_usage_plan_key" "mobile" {
  key_id        = aws_api_gateway_api_key.mobile.id
  key_type      = "API_KEY"
  usage_plan_id = aws_api_gateway_usage_plan.standard.id
}

# Stage
resource "aws_api_gateway_stage" "prod" {
  deployment_id = aws_api_gateway_deployment.main.id
  rest_api_id   = aws_api_gateway_rest_api.main.id
  stage_name    = "prod"

  xray_tracing_enabled = true

  access_log_settings {
    destination_arn = aws_cloudwatch_log_group.api_logs.arn
    format          = jsonencode({
      requestId        = "\$context.requestId"
      ip               = "\$context.identity.sourceIp"
      caller           = "\$context.identity.caller"
      user             = "\$context.identity.user"
      requestTime      = "\$context.requestTime"
      httpMethod       = "\$context.httpMethod"
      resourcePath     = "\$context.resourcePath"
      status           = "\$context.status"
      protocol         = "\$context.protocol"
      responseLength   = "\$context.responseLength"
      integrationLatency = "\$context.integrationLatency"
    })
  }
}

# WAF
resource "aws_wafv2_web_acl_association" "api" {
  resource_arn = aws_api_gateway_stage.prod.arn
  web_acl_arn  = aws_wafv2_web_acl.api.arn
}
`;
    }
}

export const apiGateway = APIGateway.getInstance();
