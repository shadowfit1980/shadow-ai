/**
 * ðŸ”Œ APIGatewayGenerator
 * 
 * API Gateway:
 * - Rate limiting, auth, routing
 */

import { EventEmitter } from 'events';

export class APIGatewayGenerator extends EventEmitter {
    private static instance: APIGatewayGenerator;
    private constructor() { super(); }
    static getInstance(): APIGatewayGenerator {
        if (!APIGatewayGenerator.instance) {
            APIGatewayGenerator.instance = new APIGatewayGenerator();
        }
        return APIGatewayGenerator.instance;
    }

    generate(): string {
        return `// API Gateway Generator - Rate limiting, auth, routing
// Generated by Shadow AI

import express from 'express';
import rateLimit from 'express-rate-limit';
import helmet from 'helmet';
import cors from 'cors';

// Gateway Configuration
const gatewayConfig = {
    services: {
        users: { url: 'http://users-service:3001', prefix: '/api/users' },
        orders: { url: 'http://orders-service:3002', prefix: '/api/orders' },
        products: { url: 'http://products-service:3003', prefix: '/api/products' }
    },
    rateLimit: { windowMs: 15 * 60 * 1000, max: 100 },
    auth: { secret: process.env.JWT_SECRET }
};

// Rate Limiter
const limiter = rateLimit({
    windowMs: gatewayConfig.rateLimit.windowMs,
    max: gatewayConfig.rateLimit.max,
    message: { error: 'Too many requests, please try again later' },
    standardHeaders: true,
    legacyHeaders: false
});

// Auth Middleware
function authMiddleware(req: any, res: any, next: Function) {
    const token = req.headers.authorization?.replace('Bearer ', '');
    
    if (!token) {
        return res.status(401).json({ error: 'No token provided' });
    }
    
    try {
        const decoded = jwt.verify(token, gatewayConfig.auth.secret);
        req.user = decoded;
        next();
    } catch (error) {
        return res.status(401).json({ error: 'Invalid token' });
    }
}

// Proxy Middleware
function createProxy(serviceUrl: string) {
    return async (req: any, res: any) => {
        try {
            const response = await fetch(\`\${serviceUrl}\${req.path}\`, {
                method: req.method,
                headers: {
                    'Content-Type': 'application/json',
                    'X-User-Id': req.user?.id,
                    'X-Request-Id': req.headers['x-request-id']
                },
                body: ['POST', 'PUT', 'PATCH'].includes(req.method) 
                    ? JSON.stringify(req.body) 
                    : undefined
            });
            
            const data = await response.json();
            res.status(response.status).json(data);
        } catch (error) {
            res.status(502).json({ error: 'Service unavailable' });
        }
    };
}

// Setup Gateway
function setupGateway(app: express.Application) {
    app.use(helmet());
    app.use(cors());
    app.use(express.json());
    app.use(limiter);
    
    // Health check
    app.get('/health', (req, res) => res.json({ status: 'ok' }));
    
    // Service routes
    for (const [name, config] of Object.entries(gatewayConfig.services)) {
        app.use(config.prefix, authMiddleware, createProxy(config.url));
    }
    
    // Error handler
    app.use((err: any, req: any, res: any, next: Function) => {
        console.error(err);
        res.status(500).json({ error: 'Internal server error' });
    });
}

// Request ID Middleware
function requestIdMiddleware(req: any, res: any, next: Function) {
    req.headers['x-request-id'] = req.headers['x-request-id'] || crypto.randomUUID();
    res.setHeader('X-Request-Id', req.headers['x-request-id']);
    next();
}

export { setupGateway, authMiddleware, createProxy, limiter };
`;
    }
}

export const apiGatewayGenerator = APIGatewayGenerator.getInstance();
