/**
 * ðŸŽ­ API Mocking Generator
 * 
 * Generate API mocks:
 * - MSW (Mock Service Worker)
 */

import { EventEmitter } from 'events';

export class APIMockingGenerator extends EventEmitter {
    private static instance: APIMockingGenerator;

    private constructor() { super(); }

    static getInstance(): APIMockingGenerator {
        if (!APIMockingGenerator.instance) {
            APIMockingGenerator.instance = new APIMockingGenerator();
        }
        return APIMockingGenerator.instance;
    }

    generate(): string {
        return `// API Mocking with MSW
// Generated by Shadow AI

import { http, HttpResponse, delay } from 'msw';
import { setupServer } from 'msw/node';
import { setupWorker } from 'msw/browser';

// === Mock Data ===
const mockUsers = [
    { id: '1', name: 'John Doe', email: 'john@example.com', role: 'admin' },
    { id: '2', name: 'Jane Smith', email: 'jane@example.com', role: 'user' }
];

const mockPosts = [
    { id: '1', title: 'First Post', content: 'Hello world', authorId: '1' },
    { id: '2', title: 'Second Post', content: 'Testing', authorId: '2' }
];

// === Handlers ===
export const handlers = [
    // GET /api/users
    http.get('/api/users', async () => {
        await delay(100); // Simulate network delay
        return HttpResponse.json(mockUsers);
    }),

    // GET /api/users/:id
    http.get('/api/users/:id', async ({ params }) => {
        const user = mockUsers.find(u => u.id === params.id);
        if (!user) {
            return new HttpResponse(null, { status: 404 });
        }
        return HttpResponse.json(user);
    }),

    // POST /api/users
    http.post('/api/users', async ({ request }) => {
        const body = await request.json() as any;
        const newUser = {
            id: String(mockUsers.length + 1),
            ...body
        };
        mockUsers.push(newUser);
        return HttpResponse.json(newUser, { status: 201 });
    }),

    // PUT /api/users/:id
    http.put('/api/users/:id', async ({ params, request }) => {
        const body = await request.json() as any;
        const index = mockUsers.findIndex(u => u.id === params.id);
        if (index === -1) {
            return new HttpResponse(null, { status: 404 });
        }
        mockUsers[index] = { ...mockUsers[index], ...body };
        return HttpResponse.json(mockUsers[index]);
    }),

    // DELETE /api/users/:id
    http.delete('/api/users/:id', async ({ params }) => {
        const index = mockUsers.findIndex(u => u.id === params.id);
        if (index === -1) {
            return new HttpResponse(null, { status: 404 });
        }
        mockUsers.splice(index, 1);
        return new HttpResponse(null, { status: 204 });
    }),

    // Auth endpoints
    http.post('/api/auth/login', async ({ request }) => {
        const { email, password } = await request.json() as any;
        if (email === 'test@example.com' && password === 'password') {
            return HttpResponse.json({
                token: 'mock-jwt-token',
                user: mockUsers[0]
            });
        }
        return HttpResponse.json({ error: 'Invalid credentials' }, { status: 401 });
    }),

    // Simulate errors
    http.get('/api/error', () => {
        return HttpResponse.json({ error: 'Something went wrong' }, { status: 500 });
    }),

    // Simulate slow response
    http.get('/api/slow', async () => {
        await delay(3000);
        return HttpResponse.json({ message: 'Finally!' });
    }),

    // Upload handler
    http.post('/api/upload', async ({ request }) => {
        const formData = await request.formData();
        const file = formData.get('file');
        return HttpResponse.json({
            filename: (file as File).name,
            size: (file as File).size,
            url: 'https://example.com/uploads/mock-file.jpg'
        });
    })
];

// === Server Setup (Node.js / Jest) ===
export const server = setupServer(...handlers);

// Jest setup
beforeAll(() => server.listen({ onUnhandledRequest: 'error' }));
afterEach(() => server.resetHandlers());
afterAll(() => server.close());

// Override handler in test
test('handle error', async () => {
    server.use(
        http.get('/api/users', () => {
            return HttpResponse.json({ error: 'Server error' }, { status: 500 });
        })
    );
    // Your test here
});

// === Browser Setup ===
export const worker = setupWorker(...handlers);

// In your app entry point
if (process.env.NODE_ENV === 'development') {
    worker.start({
        onUnhandledRequest: 'bypass',
        serviceWorker: { url: '/mockServiceWorker.js' }
    });
}

// === Vitest Setup ===
// vitest.setup.ts
import { beforeAll, afterAll, afterEach } from 'vitest';
import { server } from './mocks/server';

beforeAll(() => server.listen());
afterEach(() => server.resetHandlers());
afterAll(() => server.close());

// === Factory Functions ===
import { faker } from '@faker-js/faker';

function createMockUser(overrides = {}) {
    return {
        id: faker.string.uuid(),
        name: faker.person.fullName(),
        email: faker.internet.email(),
        avatar: faker.image.avatar(),
        role: faker.helpers.arrayElement(['admin', 'user', 'editor']),
        createdAt: faker.date.past().toISOString(),
        ...overrides
    };
}

function createMockPost(overrides = {}) {
    return {
        id: faker.string.uuid(),
        title: faker.lorem.sentence(),
        content: faker.lorem.paragraphs(3),
        authorId: faker.string.uuid(),
        tags: faker.helpers.arrayElements(['tech', 'news', 'tutorial'], 2),
        createdAt: faker.date.past().toISOString(),
        ...overrides
    };
}

export { handlers, server, worker, createMockUser, createMockPost };
`;
    }
}

export const apiMockingGenerator = APIMockingGenerator.getInstance();
