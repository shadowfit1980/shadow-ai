/**
 * üîê AdminPanel Generator
 * 
 * Admin dashboards:
 * - CRUD, users, roles, settings
 */

import { EventEmitter } from 'events';

export class AdminPanelGenerator extends EventEmitter {
    private static instance: AdminPanelGenerator;

    private constructor() { super(); }

    static getInstance(): AdminPanelGenerator {
        if (!AdminPanelGenerator.instance) {
            AdminPanelGenerator.instance = new AdminPanelGenerator();
        }
        return AdminPanelGenerator.instance;
    }

    generate(): string {
        return `// Admin Panel Generator
// Generated by Shadow AI

/**
 * ADMIN PANEL GENERATOR
 * 
 * Generate admin dashboards with CRUD operations.
 */

// === Data Table ===
class DataTableGenerator {
    generateDataTable(): string {
        return \`
import { useReactTable, getCoreRowModel, getPaginationRowModel, getSortedRowModel, getFilteredRowModel, flexRender } from '@tanstack/react-table';

interface DataTableProps<T> {
    data: T[];
    columns: ColumnDef<T>[];
    onRowClick?: (row: T) => void;
    pagination?: boolean;
    searchable?: boolean;
}

export function DataTable<T>({ data, columns, onRowClick, pagination = true, searchable = true }: DataTableProps<T>) {
    const [sorting, setSorting] = useState([]);
    const [globalFilter, setGlobalFilter] = useState('');
    
    const table = useReactTable({
        data,
        columns,
        state: { sorting, globalFilter },
        onSortingChange: setSorting,
        onGlobalFilterChange: setGlobalFilter,
        getCoreRowModel: getCoreRowModel(),
        getSortedRowModel: getSortedRowModel(),
        getFilteredRowModel: getFilteredRowModel(),
        getPaginationRowModel: pagination ? getPaginationRowModel() : undefined
    });
    
    return (
        <div className="data-table">
            {searchable && (
                <input
                    type="text"
                    placeholder="Search..."
                    value={globalFilter}
                    onChange={(e) => setGlobalFilter(e.target.value)}
                    className="search-input"
                />
            )}
            
            <table>
                <thead>
                    {table.getHeaderGroups().map(headerGroup => (
                        <tr key={headerGroup.id}>
                            {headerGroup.headers.map(header => (
                                <th key={header.id} onClick={header.column.getToggleSortingHandler()}>
                                    {flexRender(header.column.columnDef.header, header.getContext())}
                                    {header.column.getIsSorted() && (header.column.getIsSorted() === 'asc' ? ' ‚Üë' : ' ‚Üì')}
                                </th>
                            ))}
                        </tr>
                    ))}
                </thead>
                <tbody>
                    {table.getRowModel().rows.map(row => (
                        <tr key={row.id} onClick={() => onRowClick?.(row.original)}>
                            {row.getVisibleCells().map(cell => (
                                <td key={cell.id}>
                                    {flexRender(cell.column.columnDef.cell, cell.getContext())}
                                </td>
                            ))}
                        </tr>
                    ))}
                </tbody>
            </table>
            
            {pagination && (
                <div className="pagination">
                    <button onClick={() => table.previousPage()} disabled={!table.getCanPreviousPage()}>Previous</button>
                    <span>Page {table.getState().pagination.pageIndex + 1} of {table.getPageCount()}</span>
                    <button onClick={() => table.nextPage()} disabled={!table.getCanNextPage()}>Next</button>
                </div>
            )}
        </div>
    );
}
        \`;
    }
}

// === CRUD Operations ===
class CRUDGenerator {
    generateCRUDPage(): string {
        return \`
export function ResourcePage<T extends { id: string }>({ 
    resourceName,
    columns,
    formFields
}: {
    resourceName: string;
    columns: ColumnDef<T>[];
    formFields: FormFieldDef[];
}) {
    const [isModalOpen, setModalOpen] = useState(false);
    const [editingItem, setEditingItem] = useState<T | null>(null);
    
    const { data, isLoading, refetch } = useQuery([resourceName], () => api.list(resourceName));
    
    const createMutation = useMutation((data: Partial<T>) => api.create(resourceName, data), {
        onSuccess: () => { refetch(); setModalOpen(false); }
    });
    
    const updateMutation = useMutation((data: T) => api.update(resourceName, data.id, data), {
        onSuccess: () => { refetch(); setModalOpen(false); setEditingItem(null); }
    });
    
    const deleteMutation = useMutation((id: string) => api.delete(resourceName, id), {
        onSuccess: () => refetch()
    });
    
    return (
        <div className="resource-page">
            <div className="page-header">
                <h1>{resourceName}</h1>
                <button onClick={() => setModalOpen(true)}>Add New</button>
            </div>
            
            <DataTable
                data={data || []}
                columns={[
                    ...columns,
                    {
                        id: 'actions',
                        cell: ({ row }) => (
                            <DropdownMenu>
                                <DropdownMenuItem onClick={() => { setEditingItem(row.original); setModalOpen(true); }}>
                                    Edit
                                </DropdownMenuItem>
                                <DropdownMenuItem onClick={() => deleteMutation.mutate(row.original.id)} className="danger">
                                    Delete
                                </DropdownMenuItem>
                            </DropdownMenu>
                        )
                    }
                ]}
            />
            
            <Modal open={isModalOpen} onClose={() => { setModalOpen(false); setEditingItem(null); }}>
                <ResourceForm
                    fields={formFields}
                    initialValues={editingItem}
                    onSubmit={(data) => editingItem ? updateMutation.mutate(data) : createMutation.mutate(data)}
                />
            </Modal>
        </div>
    );
}
        \`;
    }
}

// === Admin Layout ===
class AdminLayoutGenerator {
    generateLayout(): string {
        return \`
export function AdminLayout({ children }: { children: React.ReactNode }) {
    const [sidebarOpen, setSidebarOpen] = useState(true);
    
    return (
        <div className="admin-layout">
            <Sidebar open={sidebarOpen} onToggle={() => setSidebarOpen(!sidebarOpen)}>
                <SidebarItem icon={<DashboardIcon />} label="Dashboard" href="/admin" />
                <SidebarItem icon={<UsersIcon />} label="Users" href="/admin/users" />
                <SidebarItem icon={<OrdersIcon />} label="Orders" href="/admin/orders" />
                <SidebarItem icon={<ProductsIcon />} label="Products" href="/admin/products" />
                <SidebarItem icon={<SettingsIcon />} label="Settings" href="/admin/settings" />
            </Sidebar>
            
            <div className="admin-main">
                <AdminHeader />
                <main className="admin-content">
                    {children}
                </main>
            </div>
        </div>
    );
}
        \`;
    }
}

export { DataTableGenerator, CRUDGenerator, AdminLayoutGenerator };
`;
    }
}

export const adminPanelGenerator = AdminPanelGenerator.getInstance();
