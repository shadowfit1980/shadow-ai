/**
 * ðŸ“Š Analytics Generator
 * 
 * Generate analytics systems:
 * - Google Analytics, Mixpanel
 */

import { EventEmitter } from 'events';

export class AnalyticsGenerator extends EventEmitter {
    private static instance: AnalyticsGenerator;

    private constructor() { super(); }

    static getInstance(): AnalyticsGenerator {
        if (!AnalyticsGenerator.instance) {
            AnalyticsGenerator.instance = new AnalyticsGenerator();
        }
        return AnalyticsGenerator.instance;
    }

    generateGA4(): string {
        return `// Google Analytics 4
// Generated by Shadow AI

// Next.js setup
// app/layout.tsx
import Script from 'next/script';

const GA_ID = process.env.NEXT_PUBLIC_GA_ID;

function RootLayout({ children }) {
    return (
        <html>
            <head>
                <Script src={\`https://www.googletagmanager.com/gtag/js?id=\${GA_ID}\`} strategy="afterInteractive" />
                <Script id="gtag-init" strategy="afterInteractive">
                    {\`
                        window.dataLayer = window.dataLayer || [];
                        function gtag(){dataLayer.push(arguments);}
                        gtag('js', new Date());
                        gtag('config', '\${GA_ID}', {
                            page_path: window.location.pathname,
                            send_page_view: false
                        });
                    \`}
                </Script>
            </head>
            <body>{children}</body>
        </html>
    );
}

// Analytics service
declare global {
    interface Window {
        gtag: (...args: any[]) => void;
    }
}

const analytics = {
    pageView(url: string) {
        window.gtag('config', GA_ID, { page_path: url });
    },

    event(action: string, params: Record<string, any> = {}) {
        window.gtag('event', action, params);
    },

    // E-commerce events
    viewItem(item: { id: string; name: string; price: number; category?: string }) {
        window.gtag('event', 'view_item', {
            currency: 'USD',
            value: item.price,
            items: [{ item_id: item.id, item_name: item.name, price: item.price, item_category: item.category }]
        });
    },

    addToCart(item: { id: string; name: string; price: number; quantity: number }) {
        window.gtag('event', 'add_to_cart', {
            currency: 'USD',
            value: item.price * item.quantity,
            items: [{ item_id: item.id, item_name: item.name, price: item.price, quantity: item.quantity }]
        });
    },

    purchase(orderId: string, items: any[], total: number) {
        window.gtag('event', 'purchase', {
            transaction_id: orderId,
            currency: 'USD',
            value: total,
            items: items.map(i => ({ item_id: i.id, item_name: i.name, price: i.price, quantity: i.quantity }))
        });
    },

    // User engagement
    login(method: string) {
        window.gtag('event', 'login', { method });
    },

    signUp(method: string) {
        window.gtag('event', 'sign_up', { method });
    },

    search(term: string) {
        window.gtag('event', 'search', { search_term: term });
    },

    // User properties
    setUserProperties(properties: Record<string, any>) {
        window.gtag('set', 'user_properties', properties);
    },

    setUserId(userId: string) {
        window.gtag('config', GA_ID, { user_id: userId });
    }
};

// React hook for page tracking
function usePageTracking() {
    const pathname = usePathname();
    
    useEffect(() => {
        analytics.pageView(pathname);
    }, [pathname]);
}

export { analytics, usePageTracking };
`;
    }

    generateMixpanel(): string {
        return `// Mixpanel Analytics
// Generated by Shadow AI

import mixpanel from 'mixpanel-browser';

mixpanel.init(process.env.NEXT_PUBLIC_MIXPANEL_TOKEN!, {
    debug: process.env.NODE_ENV === 'development',
    track_pageview: true,
    persistence: 'localStorage'
});

const analytics = {
    identify(userId: string, traits?: Record<string, any>) {
        mixpanel.identify(userId);
        if (traits) mixpanel.people.set(traits);
    },

    alias(userId: string) {
        mixpanel.alias(userId);
    },

    track(event: string, properties?: Record<string, any>) {
        mixpanel.track(event, properties);
    },

    // User profile
    setUserProfile(properties: Record<string, any>) {
        mixpanel.people.set(properties);
    },

    incrementProperty(property: string, by = 1) {
        mixpanel.people.increment(property, by);
    },

    // Time events
    timeEvent(eventName: string) {
        mixpanel.time_event(eventName);
    },

    // Common events
    pageView(page: string, properties?: Record<string, any>) {
        mixpanel.track('Page View', { page, ...properties });
    },

    buttonClick(buttonName: string, properties?: Record<string, any>) {
        mixpanel.track('Button Click', { button: buttonName, ...properties });
    },

    formSubmit(formName: string, properties?: Record<string, any>) {
        mixpanel.track('Form Submit', { form: formName, ...properties });
    },

    purchase(orderId: string, amount: number, items: any[]) {
        mixpanel.track('Purchase', { order_id: orderId, amount, items_count: items.length });
        mixpanel.people.track_charge(amount, { order_id: orderId });
    },

    signUp(method: string) {
        mixpanel.track('Sign Up', { method });
    },

    login(method: string) {
        mixpanel.track('Login', { method });
    },

    // Reset on logout
    reset() {
        mixpanel.reset();
    }
};

// React context
const AnalyticsContext = createContext(analytics);

function AnalyticsProvider({ children }) {
    return (
        <AnalyticsContext.Provider value={analytics}>
            {children}
        </AnalyticsContext.Provider>
    );
}

function useAnalytics() {
    return useContext(AnalyticsContext);
}

export { analytics, AnalyticsProvider, useAnalytics };
`;
    }
}

export const analyticsGenerator = AnalyticsGenerator.getInstance();
