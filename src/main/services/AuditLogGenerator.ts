/**
 * ðŸ” AuditLogGenerator
 * 
 * Audit logging:
 * - Activity logs, compliance, exports
 */

import { EventEmitter } from 'events';

export class AuditLogGenerator extends EventEmitter {
    private static instance: AuditLogGenerator;
    private constructor() { super(); }
    static getInstance(): AuditLogGenerator {
        if (!AuditLogGenerator.instance) {
            AuditLogGenerator.instance = new AuditLogGenerator();
        }
        return AuditLogGenerator.instance;
    }

    generate(): string {
        return `// Audit Log Generator - Activity logs, compliance
// Generated by Shadow AI

// Audit Log Schema
model AuditLog {
    id          String   @id @default(cuid())
    userId      String
    action      String
    resource    String
    resourceId  String?
    details     Json?
    ip          String?
    userAgent   String?
    timestamp   DateTime @default(now())
}

// Audit Logger Service
class AuditLogger {
    async log(event: AuditEvent) {
        await prisma.auditLog.create({
            data: {
                userId: event.userId,
                action: event.action,
                resource: event.resource,
                resourceId: event.resourceId,
                details: event.details,
                ip: event.ip,
                userAgent: event.userAgent
            }
        });
        
        // Send to external SIEM if configured
        if (process.env.SIEM_ENDPOINT) {
            await this.sendToSIEM(event);
        }
    }
    
    async getActivityLog(options: { userId?: string; resource?: string; from?: Date; to?: Date; limit?: number }) {
        return prisma.auditLog.findMany({
            where: {
                userId: options.userId,
                resource: options.resource,
                timestamp: {
                    gte: options.from,
                    lte: options.to
                }
            },
            orderBy: { timestamp: 'desc' },
            take: options.limit || 100
        });
    }
    
    async getUserActivity(userId: string) {
        return this.getActivityLog({ userId, limit: 50 });
    }
}

// Express Middleware
function auditMiddleware(logger: AuditLogger) {
    return async (req: any, res: any, next: Function) => {
        const originalSend = res.send;
        
        res.send = function(body: any) {
            res.body = body;
            return originalSend.call(this, body);
        };
        
        res.on('finish', async () => {
            if (req.method !== 'GET') {
                await logger.log({
                    userId: req.user?.id,
                    action: \`\${req.method} \${req.path}\`,
                    resource: req.path.split('/')[2] || 'unknown',
                    resourceId: req.params.id,
                    details: { statusCode: res.statusCode },
                    ip: req.ip,
                    userAgent: req.headers['user-agent']
                });
            }
        });
        
        next();
    };
}

// Compliance Report Generator
class ComplianceReporter {
    async generateGDPRReport(userId: string) {
        const userData = await prisma.user.findUnique({
            where: { id: userId },
            include: { orders: true, subscriptions: true }
        });
        
        const auditLogs = await prisma.auditLog.findMany({
            where: { userId }
        });
        
        return {
            userData,
            activityLog: auditLogs,
            exportedAt: new Date()
        };
    }
    
    async generateSOC2Report(period: { from: Date; to: Date }) {
        const accessLogs = await prisma.auditLog.findMany({
            where: {
                action: { contains: 'access' },
                timestamp: { gte: period.from, lte: period.to }
            }
        });
        
        const securityEvents = await prisma.auditLog.findMany({
            where: {
                action: { in: ['login_failed', 'permission_denied', 'password_changed'] },
                timestamp: { gte: period.from, lte: period.to }
            }
        });
        
        return { accessLogs, securityEvents, period };
    }
}

export { AuditLogger, auditMiddleware, ComplianceReporter };
`;
    }
}

export const auditLogGenerator = AuditLogGenerator.getInstance();
