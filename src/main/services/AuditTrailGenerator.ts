/**
 * ðŸ“ AuditTrailGenerator
 * 
 * Audit trails:
 * - Activity logs, compliance, history
 */

import { EventEmitter } from 'events';

export class AuditTrailGenerator extends EventEmitter {
    private static instance: AuditTrailGenerator;
    private constructor() { super(); }
    static getInstance(): AuditTrailGenerator {
        if (!AuditTrailGenerator.instance) {
            AuditTrailGenerator.instance = new AuditTrailGenerator();
        }
        return AuditTrailGenerator.instance;
    }

    generate(): string {
        return `// Audit Trail Generator - Activity logs, compliance
// Generated by Shadow AI

// Audit Log Schema
model AuditLog {
    id          String   @id @default(cuid())
    userId      String?
    action      String
    resource    String
    resourceId  String?
    oldValue    Json?
    newValue    Json?
    ipAddress   String?
    userAgent   String?
    metadata    Json?
    createdAt   DateTime @default(now())
}

// Audit Service
class AuditService {
    async log(event: AuditEvent) {
        await prisma.auditLog.create({
            data: {
                userId: event.userId,
                action: event.action,
                resource: event.resource,
                resourceId: event.resourceId,
                oldValue: event.oldValue,
                newValue: event.newValue,
                ipAddress: event.ipAddress,
                userAgent: event.userAgent,
                metadata: event.metadata
            }
        });
    }
    
    async getHistory(resource: string, resourceId: string) {
        return prisma.auditLog.findMany({
            where: { resource, resourceId },
            orderBy: { createdAt: 'desc' }
        });
    }
    
    async getUserActivity(userId: string, options?: { from?: Date; to?: Date }) {
        return prisma.auditLog.findMany({
            where: {
                userId,
                createdAt: {
                    gte: options?.from,
                    lte: options?.to
                }
            },
            orderBy: { createdAt: 'desc' }
        });
    }
    
    async search(query: {
        action?: string;
        resource?: string;
        userId?: string;
        from?: Date;
        to?: Date;
    }) {
        return prisma.auditLog.findMany({
            where: {
                action: query.action,
                resource: query.resource,
                userId: query.userId,
                createdAt: {
                    gte: query.from,
                    lte: query.to
                }
            },
            orderBy: { createdAt: 'desc' },
            take: 100
        });
    }
}

// Audit Middleware
function auditMiddleware(auditService: AuditService) {
    return async (req: any, res: any, next: Function) => {
        const originalSend = res.send;
        
        res.send = function(body: any) {
            // Log after response
            auditService.log({
                userId: req.user?.id,
                action: req.method,
                resource: req.path,
                resourceId: req.params.id,
                ipAddress: req.ip,
                userAgent: req.headers['user-agent'],
                metadata: { statusCode: res.statusCode }
            });
            
            return originalSend.call(this, body);
        };
        
        next();
    };
}

// Prisma Middleware for Auto-Audit
function prismaAuditMiddleware(auditService: AuditService) {
    return async (params: any, next: any) => {
        if (['create', 'update', 'delete'].includes(params.action)) {
            const before = params.action !== 'create' ? await prisma[params.model].findUnique({ where: params.args.where }) : null;
            const result = await next(params);
            
            await auditService.log({
                action: params.action,
                resource: params.model,
                resourceId: result?.id,
                oldValue: before,
                newValue: params.action !== 'delete' ? result : null
            });
            
            return result;
        }
        
        return next(params);
    };
}

export { AuditService, auditMiddleware, prismaAuditMiddleware };
`;
    }
}

export const auditTrailGenerator = AuditTrailGenerator.getInstance();
