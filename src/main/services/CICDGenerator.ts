/**
 * ðŸš€ CI/CD Generator
 * 
 * Generate CI/CD pipelines:
 * - GitHub Actions, GitLab CI, Jenkins
 */

import { EventEmitter } from 'events';

export type CIPlatform = 'github' | 'gitlab' | 'jenkins' | 'circleci';

export class CICDGenerator extends EventEmitter {
    private static instance: CICDGenerator;

    private constructor() { super(); }

    static getInstance(): CICDGenerator {
        if (!CICDGenerator.instance) {
            CICDGenerator.instance = new CICDGenerator();
        }
        return CICDGenerator.instance;
    }

    getPlatforms(): CIPlatform[] {
        return ['github', 'gitlab', 'jenkins', 'circleci'];
    }

    generate(platform: CIPlatform): string {
        switch (platform) {
            case 'github': return this.githubActions();
            case 'gitlab': return this.gitlabCI();
            case 'jenkins': return this.jenkinsfile();
            case 'circleci': return this.circleCI();
            default: return '';
        }
    }

    private githubActions(): string {
        return `# GitHub Actions CI/CD
# Generated by Shadow AI

name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  NODE_VERSION: '20'
  REGISTRY: ghcr.io
  IMAGE_NAME: \${{ github.repository }}

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: \${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Lint
        run: npm run lint
      
      - name: Type check
        run: npm run type-check

  test:
    runs-on: ubuntu-latest
    needs: lint
    strategy:
      matrix:
        node-version: [18, 20, 22]
    
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js \${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: \${{ matrix.node-version }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run tests
        run: npm test -- --coverage
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test
      
      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage/lcov.info

  build:
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'
    
    permissions:
      contents: read
      packages: write
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Login to Container Registry
        uses: docker/login-action@v3
        with:
          registry: \${{ env.REGISTRY }}
          username: \${{ github.actor }}
          password: \${{ secrets.GITHUB_TOKEN }}
      
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: \${{ env.REGISTRY }}/\${{ env.IMAGE_NAME }}
          tags: |
            type=sha
            type=ref,event=branch
      
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: \${{ steps.meta.outputs.tags }}
          labels: \${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    environment: production
    
    steps:
      - name: Deploy to production
        uses: appleboy/ssh-action@v1
        with:
          host: \${{ secrets.DEPLOY_HOST }}
          username: \${{ secrets.DEPLOY_USER }}
          key: \${{ secrets.DEPLOY_KEY }}
          script: |
            cd /app
            docker compose pull
            docker compose up -d
            docker system prune -f
`;
    }

    private gitlabCI(): string {
        return `# GitLab CI/CD
# Generated by Shadow AI

stages:
  - lint
  - test
  - build
  - deploy

variables:
  NODE_VERSION: "20"
  DOCKER_TLS_CERTDIR: "/certs"

cache:
  key: \${CI_COMMIT_REF_SLUG}
  paths:
    - node_modules/

lint:
  stage: lint
  image: node:\${NODE_VERSION}-alpine
  script:
    - npm ci
    - npm run lint
    - npm run type-check
  only:
    - merge_requests
    - main

test:
  stage: test
  image: node:\${NODE_VERSION}
  services:
    - postgres:16
  variables:
    POSTGRES_PASSWORD: postgres
    DATABASE_URL: postgresql://postgres:postgres@postgres:5432/test
  script:
    - npm ci
    - npm test -- --coverage
  coverage: '/All files.*?(\d+\.\d+%)/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
  only:
    - merge_requests
    - main

build:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build -t $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA .
    - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
    - |
      if [ "$CI_COMMIT_BRANCH" == "main" ]; then
        docker tag $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA $CI_REGISTRY_IMAGE:latest
        docker push $CI_REGISTRY_IMAGE:latest
      fi
  only:
    - main

deploy:
  stage: deploy
  image: alpine
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | ssh-add -
  script:
    - ssh -o StrictHostKeyChecking=no $DEPLOY_USER@$DEPLOY_HOST "
        cd /app &&
        docker compose pull &&
        docker compose up -d"
  environment:
    name: production
    url: https://example.com
  only:
    - main
  when: manual
`;
    }

    private jenkinsfile(): string {
        return `// Jenkinsfile
// Generated by Shadow AI

pipeline {
    agent any
    
    environment {
        NODE_VERSION = '20'
        DOCKER_REGISTRY = 'registry.example.com'
        IMAGE_NAME = 'myapp'
    }
    
    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }
        
        stage('Install') {
            agent {
                docker { image "node:\${NODE_VERSION}" }
            }
            steps {
                sh 'npm ci'
            }
        }
        
        stage('Lint') {
            agent {
                docker { image "node:\${NODE_VERSION}" }
            }
            steps {
                sh 'npm run lint'
                sh 'npm run type-check'
            }
        }
        
        stage('Test') {
            agent {
                docker { image "node:\${NODE_VERSION}" }
            }
            steps {
                sh 'npm test -- --coverage'
            }
            post {
                always {
                    junit 'coverage/junit.xml'
                    publishHTML([
                        reportDir: 'coverage/lcov-report',
                        reportFiles: 'index.html',
                        reportName: 'Coverage Report'
                    ])
                }
            }
        }
        
        stage('Build') {
            when {
                branch 'main'
            }
            steps {
                script {
                    docker.withRegistry("https://\${DOCKER_REGISTRY}", 'docker-credentials') {
                        def image = docker.build("\${IMAGE_NAME}:\${BUILD_NUMBER}")
                        image.push()
                        image.push('latest')
                    }
                }
            }
        }
        
        stage('Deploy') {
            when {
                branch 'main'
            }
            steps {
                sshagent(['deploy-key']) {
                    sh '''
                        ssh deploy@server.example.com "
                            cd /app
                            docker compose pull
                            docker compose up -d
                        "
                    '''
                }
            }
        }
    }
    
    post {
        success {
            slackSend(color: 'good', message: "Build succeeded: \${JOB_NAME} #\${BUILD_NUMBER}")
        }
        failure {
            slackSend(color: 'danger', message: "Build failed: \${JOB_NAME} #\${BUILD_NUMBER}")
        }
    }
}
`;
    }

    private circleCI(): string {
        return `# CircleCI Configuration
# Generated by Shadow AI

version: 2.1

orbs:
  node: circleci/node@5
  docker: circleci/docker@2

executors:
  node-executor:
    docker:
      - image: cimg/node:20.10

jobs:
  lint:
    executor: node-executor
    steps:
      - checkout
      - node/install-packages
      - run: npm run lint
      - run: npm run type-check

  test:
    executor: node-executor
    docker:
      - image: cimg/node:20.10
      - image: cimg/postgres:16.0
        environment:
          POSTGRES_PASSWORD: postgres
    steps:
      - checkout
      - node/install-packages
      - run:
          name: Wait for DB
          command: dockerize -wait tcp://localhost:5432 -timeout 1m
      - run:
          name: Run tests
          command: npm test -- --coverage
      - store_test_results:
          path: coverage
      - store_artifacts:
          path: coverage

  build:
    executor: docker/docker
    steps:
      - checkout
      - setup_remote_docker
      - docker/check
      - docker/build:
          image: \$DOCKER_IMAGE
          tag: \$CIRCLE_SHA1
      - docker/push:
          image: \$DOCKER_IMAGE
          tag: \$CIRCLE_SHA1

  deploy:
    executor: node-executor
    steps:
      - run:
          name: Deploy
          command: |
            ssh deploy@\$DEPLOY_HOST "cd /app && docker compose pull && docker compose up -d"

workflows:
  version: 2
  build-and-deploy:
    jobs:
      - lint
      - test:
          requires:
            - lint
      - build:
          requires:
            - test
          filters:
            branches:
              only: main
      - deploy:
          requires:
            - build
          filters:
            branches:
              only: main
`;
    }
}

export const cicdGenerator = CICDGenerator.getInstance();
