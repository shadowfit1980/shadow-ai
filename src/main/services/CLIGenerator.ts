/**
 * ðŸ’» CLI Generator
 * 
 * Generate CLI tools:
 * - Commander, Inquirer
 */

import { EventEmitter } from 'events';

export class CLIGenerator extends EventEmitter {
    private static instance: CLIGenerator;

    private constructor() { super(); }

    static getInstance(): CLIGenerator {
        if (!CLIGenerator.instance) {
            CLIGenerator.instance = new CLIGenerator();
        }
        return CLIGenerator.instance;
    }

    generateCLI(): string {
        return `#!/usr/bin/env node
// CLI Tool
// Generated by Shadow AI

import { Command } from 'commander';
import inquirer from 'inquirer';
import chalk from 'chalk';
import ora from 'ora';
import boxen from 'boxen';
import { createWriteStream } from 'fs';
import { mkdir, readFile, writeFile } from 'fs/promises';
import path from 'path';

const program = new Command();

program
    .name('mycli')
    .description('A powerful CLI tool')
    .version('1.0.0');

// Simple command
program
    .command('init')
    .description('Initialize a new project')
    .option('-t, --template <template>', 'Project template', 'default')
    .option('-n, --name <name>', 'Project name')
    .option('--no-git', 'Skip git initialization')
    .action(async (options) => {
        console.log(boxen(chalk.bold.blue('Project Initializer'), { padding: 1, borderColor: 'blue' }));

        // Interactive prompts if options not provided
        const answers = await inquirer.prompt([
            {
                type: 'input',
                name: 'name',
                message: 'Project name:',
                default: options.name || 'my-project',
                validate: (input) => /^[a-z0-9-]+$/.test(input) || 'Use lowercase letters, numbers, and hyphens only'
            },
            {
                type: 'list',
                name: 'template',
                message: 'Select a template:',
                choices: ['default', 'react', 'vue', 'node-api', 'fullstack'],
                default: options.template
            },
            {
                type: 'checkbox',
                name: 'features',
                message: 'Select features:',
                choices: [
                    { name: 'TypeScript', value: 'typescript', checked: true },
                    { name: 'ESLint', value: 'eslint', checked: true },
                    { name: 'Prettier', value: 'prettier', checked: true },
                    { name: 'Testing', value: 'testing' },
                    { name: 'Docker', value: 'docker' },
                    { name: 'CI/CD', value: 'cicd' }
                ]
            },
            {
                type: 'confirm',
                name: 'initGit',
                message: 'Initialize git repository?',
                default: options.git
            }
        ]);

        const spinner = ora('Creating project...').start();

        try {
            await mkdir(answers.name, { recursive: true });
            spinner.text = 'Generating files...';
            
            // Create package.json
            const pkg = {
                name: answers.name,
                version: '0.1.0',
                scripts: { dev: 'node index.js', build: 'echo build', test: 'echo test' }
            };
            await writeFile(path.join(answers.name, 'package.json'), JSON.stringify(pkg, null, 2));

            spinner.succeed(chalk.green('Project created successfully!'));
            
            console.log('\\n' + chalk.cyan('Next steps:'));
            console.log(chalk.white(\`  cd \${answers.name}\`));
            console.log(chalk.white('  npm install'));
            console.log(chalk.white('  npm run dev'));
        } catch (error) {
            spinner.fail(chalk.red('Failed to create project'));
            console.error(error);
            process.exit(1);
        }
    });

// Command with subcommands
const config = program.command('config').description('Manage configuration');

config
    .command('get <key>')
    .description('Get a config value')
    .action((key) => {
        console.log(\`Getting config: \${key}\`);
    });

config
    .command('set <key> <value>')
    .description('Set a config value')
    .action((key, value) => {
        console.log(\`Setting \${key} = \${value}\`);
    });

// Generate command
program
    .command('generate <type> <name>')
    .alias('g')
    .description('Generate a component')
    .option('-d, --dir <directory>', 'Target directory', '.')
    .action(async (type, name, options) => {
        const types = ['component', 'page', 'hook', 'service', 'model'];
        
        if (!types.includes(type)) {
            console.error(chalk.red(\`Invalid type. Choose from: \${types.join(', ')}\`));
            process.exit(1);
        }

        const spinner = ora(\`Generating \${type}...\`).start();
        
        const template = \`// \${name}.\${type === 'component' ? 'tsx' : 'ts'}
// Generated by mycli

export function \${name}() {
    return null;
}
\`;
        
        const filePath = path.join(options.dir, \`\${name}.\${type === 'component' ? 'tsx' : 'ts'}\`);
        await writeFile(filePath, template);
        
        spinner.succeed(chalk.green(\`Created \${filePath}\`));
    });

// Interactive mode
program
    .command('interactive')
    .alias('i')
    .description('Interactive mode')
    .action(async () => {
        const { action } = await inquirer.prompt([
            {
                type: 'list',
                name: 'action',
                message: 'What would you like to do?',
                choices: ['Create project', 'Generate component', 'Run build', 'Exit']
            }
        ]);

        switch (action) {
            case 'Create project':
                await program.parseAsync(['node', 'cli', 'init']);
                break;
            case 'Exit':
                console.log(chalk.yellow('Goodbye!'));
                break;
        }
    });

// Error handling
program.exitOverride();

try {
    program.parse();
} catch (err) {
    if (err.code === 'commander.help') {
        process.exit(0);
    }
    console.error(chalk.red('Error:'), err.message);
    process.exit(1);
}
`;
    }
}

export const cliGenerator = CLIGenerator.getInstance();
