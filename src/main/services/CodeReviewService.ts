/**
 * ðŸ”’ CodeReviewService
 * 
 * Automated code review:
 * - Quality, security, best practices
 */

import { EventEmitter } from 'events';

export class CodeReviewService extends EventEmitter {
    private static instance: CodeReviewService;
    private constructor() { super(); }
    static getInstance(): CodeReviewService {
        if (!CodeReviewService.instance) {
            CodeReviewService.instance = new CodeReviewService();
        }
        return CodeReviewService.instance;
    }

    generate(): string {
        return `// Code Review Service - Quality, security, best practices
// Generated by Shadow AI

class CodeReviewer {
    async review(code: string, language: string): Promise<ReviewResult> {
        const response = await llm.chat([{
            role: 'system',
            content: \`You are a senior code reviewer. Review the code for:
            1. Code quality and readability
            2. Security vulnerabilities
            3. Performance issues
            4. Best practices
            5. Potential bugs
            
            Return JSON: { score: 0-100, issues: [{ severity, line, message, suggestion }], summary }\`
        }, {
            role: 'user',
            content: \`Language: \${language}\\n\\n\${code}\`
        }]);
        
        return JSON.parse(response.content);
    }
    
    // Security-focused review
    async securityReview(code: string): Promise<SecurityIssue[]> {
        const response = await llm.chat([{
            role: 'system',
            content: \`Analyze this code for security vulnerabilities. Check for:
            - SQL injection
            - XSS
            - CSRF
            - Insecure deserialization
            - Hardcoded secrets
            - Path traversal
            - Command injection
            
            Return JSON array of issues with: { type, severity, line, description, fix }\`
        }, {
            role: 'user',
            content: code
        }]);
        
        return JSON.parse(response.content);
    }
    
    // Performance review
    async performanceReview(code: string): Promise<PerformanceIssue[]> {
        const response = await llm.chat([{
            role: 'system',
            content: \`Analyze this code for performance issues. Check for:
            - N+1 queries
            - Memory leaks
            - Unnecessary iterations
            - Missing caching opportunities
            - Blocking operations
            
            Return JSON array of issues with: { type, severity, line, description, optimization }\`
        }, {
            role: 'user',
            content: code
        }]);
        
        return JSON.parse(response.content);
    }
    
    // Review pull request
    async reviewPR(diff: string, context: string): Promise<PRReview> {
        const response = await llm.chat([{
            role: 'system',
            content: \`Review this pull request diff. Consider:
            - Does it solve the stated problem?
            - Are there any bugs?
            - Is the code maintainable?
            - Are there security concerns?
            
            Return JSON: { approved: boolean, comments: [{ file, line, type, message }], summary }\`
        }, {
            role: 'user',
            content: \`Context: \${context}\\n\\nDiff:\\n\${diff}\`
        }]);
        
        return JSON.parse(response.content);
    }
    
    // Check style guide compliance
    async checkStyleGuide(code: string, styleGuide: string): Promise<StyleIssue[]> {
        const response = await llm.chat([{
            role: 'system',
            content: \`Check if the code follows this style guide. Return JSON array of violations with: { rule, line, message }\`
        }, {
            role: 'user',
            content: \`Style Guide:\\n\${styleGuide}\\n\\nCode:\\n\${code}\`
        }]);
        
        return JSON.parse(response.content);
    }
    
    // Suggest improvements
    async suggestImprovements(code: string): Promise<Improvement[]> {
        const response = await llm.chat([{
            role: 'system',
            content: \`Suggest improvements for this code. Focus on:
            - Readability
            - Maintainability
            - Performance
            - Modern patterns
            
            Return JSON array with: { type, description, before, after }\`
        }, {
            role: 'user',
            content: code
        }]);
        
        return JSON.parse(response.content);
    }
}

export { CodeReviewer };
`;
    }
}

export const codeReviewService = CodeReviewService.getInstance();
