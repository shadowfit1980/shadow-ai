/**
 * âœ… Compliance Checker
 * 
 * Regulatory compliance:
 * - GDPR, HIPAA, SOC2, PCI-DSS
 */

import { EventEmitter } from 'events';

export class ComplianceChecker extends EventEmitter {
    private static instance: ComplianceChecker;

    private constructor() { super(); }

    static getInstance(): ComplianceChecker {
        if (!ComplianceChecker.instance) {
            ComplianceChecker.instance = new ComplianceChecker();
        }
        return ComplianceChecker.instance;
    }

    generate(): string {
        return `// Compliance Checker
// Generated by Shadow AI

/**
 * COMPLIANCE CHECKER
 * 
 * Automated compliance checking for GDPR, HIPAA, SOC2, PCI-DSS.
 */

interface ComplianceViolation {
    id: string;
    regulation: 'GDPR' | 'HIPAA' | 'SOC2' | 'PCI-DSS';
    requirement: string;
    severity: 'low' | 'medium' | 'high' | 'critical';
    description: string;
    location: { file: string; line?: number };
    remediation: string;
}

// === GDPR Checker ===
class GDPRChecker {
    async check(projectPath: string): Promise<ComplianceViolation[]> {
        const violations: ComplianceViolation[] = [];
        const files = await glob(\`\${projectPath}/**/*.{ts,tsx,js,jsx}\`);
        
        for (const file of files) {
            const content = await fs.readFile(file, 'utf-8');
            
            // Check for personal data without consent
            if (this.detectsPersonalData(content)) {
                if (!content.includes('consent') && !content.includes('gdpr')) {
                    violations.push({
                        id: crypto.randomUUID(),
                        regulation: 'GDPR',
                        requirement: 'Article 6 - Lawfulness of processing',
                        severity: 'high',
                        description: 'Personal data processed without apparent consent mechanism',
                        location: { file },
                        remediation: 'Implement consent management for personal data collection'
                    });
                }
            }
            
            // Check for data retention
            if (content.includes('userData') || content.includes('personalData')) {
                if (!content.includes('delete') && !content.includes('retention')) {
                    violations.push({
                        id: crypto.randomUUID(),
                        regulation: 'GDPR',
                        requirement: 'Article 17 - Right to erasure',
                        severity: 'medium',
                        description: 'No data deletion mechanism found for personal data',
                        location: { file },
                        remediation: 'Implement data deletion functionality (right to be forgotten)'
                    });
                }
            }
            
            // Check for data export
            if (content.includes('user') && content.includes('data')) {
                if (!content.includes('export') && !content.includes('download')) {
                    violations.push({
                        id: crypto.randomUUID(),
                        regulation: 'GDPR',
                        requirement: 'Article 20 - Right to data portability',
                        severity: 'medium',
                        description: 'No data export functionality found',
                        location: { file },
                        remediation: 'Implement user data export in machine-readable format'
                    });
                }
            }
        }
        
        return violations;
    }
    
    private detectsPersonalData(content: string): boolean {
        const personalDataPatterns = [
            'email', 'phone', 'address', 'name', 'birthday', 'ssn',
            'ipAddress', 'location', 'healthData', 'biometric'
        ];
        return personalDataPatterns.some(p => content.toLowerCase().includes(p));
    }
}

// === HIPAA Checker ===
class HIPAAChecker {
    async check(projectPath: string): Promise<ComplianceViolation[]> {
        const violations: ComplianceViolation[] = [];
        const files = await glob(\`\${projectPath}/**/*.{ts,tsx,js,jsx}\`);
        
        for (const file of files) {
            const content = await fs.readFile(file, 'utf-8');
            
            // Check for PHI encryption
            if (this.detectsPHI(content)) {
                if (!content.includes('encrypt') && !content.includes('crypto')) {
                    violations.push({
                        id: crypto.randomUUID(),
                        regulation: 'HIPAA',
                        requirement: 'Â§164.312(a)(2)(iv) - Encryption',
                        severity: 'critical',
                        description: 'PHI appears to be stored without encryption',
                        location: { file },
                        remediation: 'Encrypt all PHI at rest using AES-256 or equivalent'
                    });
                }
            }
            
            // Check for audit logging
            if (this.detectsPHI(content)) {
                if (!content.includes('audit') && !content.includes('log')) {
                    violations.push({
                        id: crypto.randomUUID(),
                        regulation: 'HIPAA',
                        requirement: 'Â§164.312(b) - Audit controls',
                        severity: 'high',
                        description: 'No audit logging for PHI access',
                        location: { file },
                        remediation: 'Implement audit logging for all PHI access and modifications'
                    });
                }
            }
        }
        
        return violations;
    }
    
    private detectsPHI(content: string): boolean {
        const phiPatterns = [
            'healthRecord', 'medicalHistory', 'diagnosis', 'prescription',
            'patientId', 'healthData', 'treatment', 'clinicalData'
        ];
        return phiPatterns.some(p => content.toLowerCase().includes(p.toLowerCase()));
    }
}

// === PCI-DSS Checker ===
class PCIDSSChecker {
    async check(projectPath: string): Promise<ComplianceViolation[]> {
        const violations: ComplianceViolation[] = [];
        const files = await glob(\`\${projectPath}/**/*.{ts,tsx,js,jsx}\`);
        
        for (const file of files) {
            const content = await fs.readFile(file, 'utf-8');
            
            // Check for card data storage
            if (content.match(/\\b\\d{13,16}\\b/) || content.includes('cardNumber')) {
                if (!content.includes('tokenize') && !content.includes('stripe')) {
                    violations.push({
                        id: crypto.randomUUID(),
                        regulation: 'PCI-DSS',
                        requirement: 'Requirement 3 - Protect stored cardholder data',
                        severity: 'critical',
                        description: 'Credit card data appears to be stored directly',
                        location: { file },
                        remediation: 'Use tokenization via Stripe/Braintree instead of storing card data'
                    });
                }
            }
            
            // Check for CVV storage
            if (content.includes('cvv') || content.includes('cvc') || content.includes('securityCode')) {
                violations.push({
                    id: crypto.randomUUID(),
                    regulation: 'PCI-DSS',
                    requirement: 'Requirement 3.2 - Do not store sensitive authentication data',
                    severity: 'critical',
                    description: 'CVV/CVC appears to be processed or stored',
                    location: { file },
                    remediation: 'Never store CVV/CVC data - use payment processor SDKs'
                });
            }
        }
        
        return violations;
    }
}

// === Main Compliance Service ===
class ComplianceService {
    private gdpr = new GDPRChecker();
    private hipaa = new HIPAAChecker();
    private pci = new PCIDSSChecker();
    
    async runFullAudit(projectPath: string): Promise<ComplianceReport> {
        console.log('ðŸ“‹ Running compliance audit...');
        
        const gdprViolations = await this.gdpr.check(projectPath);
        const hipaaViolations = await this.hipaa.check(projectPath);
        const pciViolations = await this.pci.check(projectPath);
        
        const allViolations = [...gdprViolations, ...hipaaViolations, ...pciViolations];
        
        return {
            timestamp: new Date(),
            totalViolations: allViolations.length,
            bySeverity: {
                critical: allViolations.filter(v => v.severity === 'critical').length,
                high: allViolations.filter(v => v.severity === 'high').length,
                medium: allViolations.filter(v => v.severity === 'medium').length,
                low: allViolations.filter(v => v.severity === 'low').length
            },
            byRegulation: {
                GDPR: gdprViolations.length,
                HIPAA: hipaaViolations.length,
                'PCI-DSS': pciViolations.length
            },
            violations: allViolations,
            passed: allViolations.filter(v => v.severity === 'critical').length === 0
        };
    }
}

export { GDPRChecker, HIPAAChecker, PCIDSSChecker, ComplianceService };
`;
    }
}

export const complianceChecker = ComplianceChecker.getInstance();
