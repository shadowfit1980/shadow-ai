/**
 * ðŸ“Š Data Exporter
 * 
 * Export data to various formats:
 * - CSV, Excel, JSON
 */

import { EventEmitter } from 'events';

export class DataExporter extends EventEmitter {
    private static instance: DataExporter;

    private constructor() { super(); }

    static getInstance(): DataExporter {
        if (!DataExporter.instance) {
            DataExporter.instance = new DataExporter();
        }
        return DataExporter.instance;
    }

    generate(): string {
        return `// Data Export Utilities
// Generated by Shadow AI

import ExcelJS from 'exceljs';
import { stringify } from 'csv-stringify/sync';
import { parse } from 'csv-parse/sync';
import archiver from 'archiver';
import { Readable } from 'stream';

interface ExportOptions {
    filename?: string;
    sheetName?: string;
    headers?: string[];
    columns?: { header: string; key: string; width?: number }[];
}

// === CSV Export ===
function toCSV(data: object[], options: { headers?: string[], delimiter?: string } = {}) {
    const { headers, delimiter = ',' } = options;
    
    if (data.length === 0) return '';
    
    const columns = headers || Object.keys(data[0]);
    
    return stringify(data, {
        header: true,
        columns,
        delimiter,
        quoted: true
    });
}

// Express middleware for CSV download
function csvDownload(res: any, data: object[], filename = 'export.csv') {
    const csv = toCSV(data);
    
    res.setHeader('Content-Type', 'text/csv');
    res.setHeader('Content-Disposition', \`attachment; filename="\${filename}"\`);
    res.send(csv);
}

// === Excel Export ===
async function toExcel(data: object[], options: ExportOptions = {}): Promise<Buffer> {
    const workbook = new ExcelJS.Workbook();
    workbook.creator = 'Shadow AI';
    workbook.created = new Date();
    
    const worksheet = workbook.addWorksheet(options.sheetName || 'Data');
    
    // Define columns
    if (options.columns) {
        worksheet.columns = options.columns;
    } else if (data.length > 0) {
        worksheet.columns = Object.keys(data[0]).map(key => ({
            header: key.charAt(0).toUpperCase() + key.slice(1),
            key,
            width: 15
        }));
    }
    
    // Style header row
    worksheet.getRow(1).font = { bold: true };
    worksheet.getRow(1).fill = {
        type: 'pattern',
        pattern: 'solid',
        fgColor: { argb: 'FF667EEA' }
    };
    worksheet.getRow(1).font = { bold: true, color: { argb: 'FFFFFFFF' } };
    
    // Add data rows
    data.forEach(item => {
        worksheet.addRow(item);
    });
    
    // Auto-filter
    if (data.length > 0) {
        worksheet.autoFilter = {
            from: { row: 1, column: 1 },
            to: { row: data.length + 1, column: Object.keys(data[0]).length }
        };
    }
    
    // Freeze header row
    worksheet.views = [{ state: 'frozen', ySplit: 1 }];
    
    return workbook.xlsx.writeBuffer() as Promise<Buffer>;
}

// Express middleware for Excel download
async function excelDownload(res: any, data: object[], filename = 'export.xlsx', options: ExportOptions = {}) {
    const buffer = await toExcel(data, options);
    
    res.setHeader('Content-Type', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
    res.setHeader('Content-Disposition', \`attachment; filename="\${filename}"\`);
    res.send(buffer);
}

// Multi-sheet Excel
async function toMultiSheetExcel(sheets: { name: string; data: object[] }[]): Promise<Buffer> {
    const workbook = new ExcelJS.Workbook();
    
    for (const sheet of sheets) {
        const worksheet = workbook.addWorksheet(sheet.name);
        
        if (sheet.data.length > 0) {
            worksheet.columns = Object.keys(sheet.data[0]).map(key => ({
                header: key,
                key,
                width: 15
            }));
            
            worksheet.getRow(1).font = { bold: true };
            sheet.data.forEach(item => worksheet.addRow(item));
        }
    }
    
    return workbook.xlsx.writeBuffer() as Promise<Buffer>;
}

// === JSON Export ===
function toJSON(data: any, pretty = true): string {
    return pretty ? JSON.stringify(data, null, 2) : JSON.stringify(data);
}

function jsonDownload(res: any, data: any, filename = 'export.json') {
    res.setHeader('Content-Type', 'application/json');
    res.setHeader('Content-Disposition', \`attachment; filename="\${filename}"\`);
    res.send(toJSON(data));
}

// === CSV Import ===
function parseCSV(content: string, options: { columns?: boolean | string[], delimiter?: string } = {}) {
    return parse(content, {
        columns: options.columns ?? true,
        skip_empty_lines: true,
        delimiter: options.delimiter || ',',
        trim: true
    });
}

// === ZIP Export ===
async function createZipArchive(files: { name: string; content: Buffer | string }[]): Promise<Buffer> {
    return new Promise((resolve, reject) => {
        const archive = archiver('zip', { zlib: { level: 9 } });
        const chunks: Buffer[] = [];
        
        archive.on('data', chunk => chunks.push(chunk));
        archive.on('end', () => resolve(Buffer.concat(chunks)));
        archive.on('error', reject);
        
        for (const file of files) {
            archive.append(file.content, { name: file.name });
        }
        
        archive.finalize();
    });
}

// Stream large datasets
function streamCSV(data: object[]): Readable {
    const readable = new Readable({ objectMode: true });
    
    data.forEach(row => readable.push(row));
    readable.push(null);
    
    return readable;
}

export { toCSV, csvDownload, toExcel, excelDownload, toMultiSheetExcel, toJSON, jsonDownload, parseCSV, createZipArchive, streamCSV };
`;
    }
}

export const dataExporter = DataExporter.getInstance();
