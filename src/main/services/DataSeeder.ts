/**
 * ðŸŒ± Data Seeder
 * 
 * Generate database seed data:
 * - Faker, realistic data
 */

import { EventEmitter } from 'events';

export class DataSeeder extends EventEmitter {
    private static instance: DataSeeder;

    private constructor() { super(); }

    static getInstance(): DataSeeder {
        if (!DataSeeder.instance) {
            DataSeeder.instance = new DataSeeder();
        }
        return DataSeeder.instance;
    }

    generate(): string {
        return `// Database Seeding
// Generated by Shadow AI

import { faker } from '@faker-js/faker';
import { PrismaClient } from '@prisma/client';
import bcrypt from 'bcryptjs';

const prisma = new PrismaClient();

// Configuration
const SEED_CONFIG = {
    users: 50,
    productsPerCategory: 20,
    ordersPerUser: 3,
    reviewsPerProduct: 5
};

// User factory
function createUser(role: 'ADMIN' | 'USER' = 'USER') {
    const firstName = faker.person.firstName();
    const lastName = faker.person.lastName();
    
    return {
        email: faker.internet.email({ firstName, lastName }).toLowerCase(),
        name: \`\${firstName} \${lastName}\`,
        password: bcrypt.hashSync('password123', 10),
        role,
        avatar: faker.image.avatar(),
        phone: faker.phone.number(),
        address: {
            create: {
                street: faker.location.streetAddress(),
                city: faker.location.city(),
                state: faker.location.state(),
                zipCode: faker.location.zipCode(),
                country: faker.location.country()
            }
        },
        createdAt: faker.date.past({ years: 2 }),
        updatedAt: faker.date.recent()
    };
}

// Product factory
function createProduct(categoryId: string) {
    const name = faker.commerce.productName();
    
    return {
        name,
        slug: faker.helpers.slugify(name).toLowerCase(),
        description: faker.commerce.productDescription(),
        price: parseFloat(faker.commerce.price({ min: 10, max: 500 })),
        comparePrice: parseFloat(faker.commerce.price({ min: 500, max: 800 })),
        sku: faker.string.alphanumeric(8).toUpperCase(),
        stock: faker.number.int({ min: 0, max: 100 }),
        images: Array.from({ length: 3 }, () => faker.image.urlPicsumPhotos({ width: 800, height: 800 })),
        categoryId,
        featured: faker.datatype.boolean({ probability: 0.2 }),
        rating: faker.number.float({ min: 3, max: 5, fractionDigits: 1 }),
        reviewCount: faker.number.int({ min: 0, max: 100 }),
        createdAt: faker.date.past({ years: 1 })
    };
}

// Order factory
function createOrder(userId: string, products: any[]) {
    const items = faker.helpers.arrayElements(products, { min: 1, max: 5 });
    const subtotal = items.reduce((sum, p) => sum + p.price, 0);
    const tax = subtotal * 0.1;
    
    return {
        userId,
        status: faker.helpers.arrayElement(['PENDING', 'PROCESSING', 'SHIPPED', 'DELIVERED', 'CANCELLED']),
        subtotal,
        tax,
        total: subtotal + tax,
        shippingAddress: {
            street: faker.location.streetAddress(),
            city: faker.location.city(),
            zipCode: faker.location.zipCode()
        },
        items: {
            create: items.map(p => ({
                productId: p.id,
                quantity: faker.number.int({ min: 1, max: 3 }),
                price: p.price
            }))
        },
        createdAt: faker.date.past({ years: 1 })
    };
}

// Review factory
function createReview(userId: string, productId: string) {
    return {
        userId,
        productId,
        rating: faker.number.int({ min: 1, max: 5 }),
        title: faker.lorem.sentence(),
        content: faker.lorem.paragraph(),
        helpful: faker.number.int({ min: 0, max: 50 }),
        verified: faker.datatype.boolean({ probability: 0.7 }),
        createdAt: faker.date.past({ years: 1 })
    };
}

// Main seed function
async function seed() {
    console.log('ðŸŒ± Starting database seed...');
    
    // Clear existing data
    await prisma.$transaction([
        prisma.review.deleteMany(),
        prisma.orderItem.deleteMany(),
        prisma.order.deleteMany(),
        prisma.product.deleteMany(),
        prisma.category.deleteMany(),
        prisma.address.deleteMany(),
        prisma.user.deleteMany()
    ]);
    console.log('âœ“ Cleared existing data');
    
    // Create admin user
    const admin = await prisma.user.create({
        data: createUser('ADMIN')
    });
    console.log('âœ“ Created admin user:', admin.email);
    
    // Create regular users
    const users = await Promise.all(
        Array.from({ length: SEED_CONFIG.users }, () =>
            prisma.user.create({ data: createUser() })
        )
    );
    console.log(\`âœ“ Created \${users.length} users\`);
    
    // Create categories
    const categoryNames = ['Electronics', 'Clothing', 'Home & Garden', 'Sports', 'Books'];
    const categories = await Promise.all(
        categoryNames.map(name =>
            prisma.category.create({
                data: {
                    name,
                    slug: name.toLowerCase().replace(/\\s+/g, '-'),
                    description: faker.lorem.sentence()
                }
            })
        )
    );
    console.log(\`âœ“ Created \${categories.length} categories\`);
    
    // Create products
    const products = [];
    for (const category of categories) {
        const categoryProducts = await Promise.all(
            Array.from({ length: SEED_CONFIG.productsPerCategory }, () =>
                prisma.product.create({ data: createProduct(category.id) })
            )
        );
        products.push(...categoryProducts);
    }
    console.log(\`âœ“ Created \${products.length} products\`);
    
    // Create orders
    let orderCount = 0;
    for (const user of users.slice(0, 20)) {
        for (let i = 0; i < SEED_CONFIG.ordersPerUser; i++) {
            await prisma.order.create({ data: createOrder(user.id, products) });
            orderCount++;
        }
    }
    console.log(\`âœ“ Created \${orderCount} orders\`);
    
    // Create reviews
    let reviewCount = 0;
    for (const product of products.slice(0, 30)) {
        const reviewers = faker.helpers.arrayElements(users, SEED_CONFIG.reviewsPerProduct);
        for (const user of reviewers) {
            await prisma.review.create({ data: createReview(user.id, product.id) });
            reviewCount++;
        }
    }
    console.log(\`âœ“ Created \${reviewCount} reviews\`);
    
    console.log('\\nâœ… Database seeded successfully!');
}

// Run with error handling
seed()
    .catch(e => {
        console.error('âŒ Seed failed:', e);
        process.exit(1);
    })
    .finally(() => prisma.$disconnect());

export { createUser, createProduct, createOrder, createReview, seed };
`;
    }
}

export const dataSeeder = DataSeeder.getInstance();
