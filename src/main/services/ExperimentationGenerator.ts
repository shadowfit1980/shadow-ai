/**
 * ðŸŽ¯ ExperimentationGenerator
 * 
 * Experimentation:
 * - A/B tests, multivariate, analytics
 */

import { EventEmitter } from 'events';

export class ExperimentationGenerator extends EventEmitter {
    private static instance: ExperimentationGenerator;
    private constructor() { super(); }
    static getInstance(): ExperimentationGenerator {
        if (!ExperimentationGenerator.instance) {
            ExperimentationGenerator.instance = new ExperimentationGenerator();
        }
        return ExperimentationGenerator.instance;
    }

    generate(): string {
        return `// Experimentation Generator - A/B tests, multivariate
// Generated by Shadow AI

// Experiment Service
class ExperimentService {
    async getVariant(experimentName: string, userId: string): Promise<string> {
        // Check if user already assigned
        const cached = await redis.get(\`exp:\${experimentName}:\${userId}\`);
        if (cached) return cached;
        
        // Assign variant based on hash
        const hash = this.hashUserId(userId, experimentName) % 100;
        const variant = hash < 50 ? 'control' : 'treatment';
        
        await redis.set(\`exp:\${experimentName}:\${userId}\`, variant);
        
        return variant;
    }
    
    private hashUserId(userId: string, salt: string): number {
        const str = userId + salt;
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
            hash = ((hash << 5) - hash) + str.charCodeAt(i);
            hash |= 0;
        }
        return Math.abs(hash);
    }
    
    async trackConversion(experimentName: string, userId: string) {
        const variant = await this.getVariant(experimentName, userId);
        await redis.incr(\`exp:\${experimentName}:\${variant}:conversions\`);
    }
    
    async trackImpression(experimentName: string, userId: string) {
        const variant = await this.getVariant(experimentName, userId);
        await redis.incr(\`exp:\${experimentName}:\${variant}:impressions\`);
    }
    
    async getResults(experimentName: string) {
        const [controlImpressions, controlConversions, treatmentImpressions, treatmentConversions] = await Promise.all([
            redis.get(\`exp:\${experimentName}:control:impressions\`),
            redis.get(\`exp:\${experimentName}:control:conversions\`),
            redis.get(\`exp:\${experimentName}:treatment:impressions\`),
            redis.get(\`exp:\${experimentName}:treatment:conversions\`)
        ]);
        
        return {
            control: {
                impressions: parseInt(controlImpressions || '0'),
                conversions: parseInt(controlConversions || '0'),
                rate: this.calculateRate(controlImpressions, controlConversions)
            },
            treatment: {
                impressions: parseInt(treatmentImpressions || '0'),
                conversions: parseInt(treatmentConversions || '0'),
                rate: this.calculateRate(treatmentImpressions, treatmentConversions)
            }
        };
    }
    
    private calculateRate(impressions: string | null, conversions: string | null): number {
        const imp = parseInt(impressions || '0');
        const conv = parseInt(conversions || '0');
        return imp > 0 ? (conv / imp) * 100 : 0;
    }
}

// React Hook
export function useExperiment(experimentName: string) {
    const [variant, setVariant] = useState<string | null>(null);
    const { user } = useUser();
    
    useEffect(() => {
        if (user) {
            getVariant(experimentName, user.id).then(setVariant);
        }
    }, [experimentName, user]);
    
    return variant;
}

export { ExperimentService, useExperiment };
`;
    }
}

export const experimentationGenerator = ExperimentationGenerator.getInstance();
