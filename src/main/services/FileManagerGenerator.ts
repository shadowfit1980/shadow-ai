/**
 * ðŸ“¤ FileManagerGenerator
 * 
 * File management:
 * - Upload, storage, preview, sharing
 */

import { EventEmitter } from 'events';

export class FileManagerGenerator extends EventEmitter {
    private static instance: FileManagerGenerator;

    private constructor() { super(); }

    static getInstance(): FileManagerGenerator {
        if (!FileManagerGenerator.instance) {
            FileManagerGenerator.instance = new FileManagerGenerator();
        }
        return FileManagerGenerator.instance;
    }

    generate(): string {
        return `// File Manager Generator
// Generated by Shadow AI

/**
 * FILE MANAGER GENERATOR
 * 
 * Complete file management with upload, storage, preview.
 */

// === File Upload Component ===
export function FileUpload({ onUpload, accept, maxSize, multiple }: FileUploadProps) {
    const [isDragging, setIsDragging] = useState(false);
    const [uploading, setUploading] = useState(false);
    const [progress, setProgress] = useState(0);
    
    const handleDrop = async (e: React.DragEvent) => {
        e.preventDefault();
        setIsDragging(false);
        
        const files = Array.from(e.dataTransfer.files);
        await uploadFiles(files);
    };
    
    const uploadFiles = async (files: File[]) => {
        setUploading(true);
        
        for (const file of files) {
            if (maxSize && file.size > maxSize) {
                toast.error(\`File \${file.name} exceeds max size\`);
                continue;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            
            const xhr = new XMLHttpRequest();
            xhr.upload.onprogress = (e) => {
                setProgress(Math.round((e.loaded / e.total) * 100));
            };
            
            xhr.onload = () => {
                const response = JSON.parse(xhr.responseText);
                onUpload(response);
            };
            
            xhr.open('POST', '/api/upload');
            xhr.send(formData);
        }
        
        setUploading(false);
        setProgress(0);
    };
    
    return (
        <div
            className={\`file-upload \${isDragging ? 'dragging' : ''}\`}
            onDragOver={(e) => { e.preventDefault(); setIsDragging(true); }}
            onDragLeave={() => setIsDragging(false)}
            onDrop={handleDrop}
        >
            <input
                type="file"
                accept={accept}
                multiple={multiple}
                onChange={(e) => uploadFiles(Array.from(e.target.files || []))}
            />
            
            {uploading ? (
                <div className="upload-progress">
                    <div className="progress-bar" style={{ width: \`\${progress}%\` }} />
                    <span>{progress}%</span>
                </div>
            ) : (
                <div className="upload-prompt">
                    <UploadIcon />
                    <p>Drag files here or click to upload</p>
                </div>
            )}
        </div>
    );
}

// === S3 Storage Integration ===
class S3StorageGenerator {
    generateUploadAPI(): string {
        return \`
import { S3Client, PutObjectCommand, GetObjectCommand } from '@aws-sdk/client-s3';
import { getSignedUrl } from '@aws-sdk/s3-request-presigner';

const s3 = new S3Client({ region: process.env.AWS_REGION });

export async function generatePresignedUploadUrl(key: string, contentType: string) {
    const command = new PutObjectCommand({
        Bucket: process.env.S3_BUCKET,
        Key: key,
        ContentType: contentType
    });
    
    const url = await getSignedUrl(s3, command, { expiresIn: 3600 });
    return { url, key };
}

export async function generatePresignedDownloadUrl(key: string) {
    const command = new GetObjectCommand({
        Bucket: process.env.S3_BUCKET,
        Key: key
    });
    
    return getSignedUrl(s3, command, { expiresIn: 3600 });
}

export async function uploadFile(file: Buffer, key: string, contentType: string) {
    await s3.send(new PutObjectCommand({
        Bucket: process.env.S3_BUCKET,
        Key: key,
        Body: file,
        ContentType: contentType
    }));
    
    return \\\`https://\\\${process.env.S3_BUCKET}.s3.\\\${process.env.AWS_REGION}.amazonaws.com/\\\${key}\\\`;
}
        \`;
    }
}

// === File Preview ===
class FilePreviewGenerator {
    generatePreview(): string {
        return \`
export function FilePreview({ file }: { file: FileRecord }) {
    const isImage = file.mimeType.startsWith('image/');
    const isVideo = file.mimeType.startsWith('video/');
    const isPDF = file.mimeType === 'application/pdf';
    const isAudio = file.mimeType.startsWith('audio/');
    
    if (isImage) {
        return <img src={file.url} alt={file.name} className="file-preview-image" />;
    }
    
    if (isVideo) {
        return (
            <video controls className="file-preview-video">
                <source src={file.url} type={file.mimeType} />
            </video>
        );
    }
    
    if (isPDF) {
        return (
            <iframe
                src={\\\`\\\${file.url}#view=FitH\\\`}
                className="file-preview-pdf"
            />
        );
    }
    
    if (isAudio) {
        return (
            <audio controls className="file-preview-audio">
                <source src={file.url} type={file.mimeType} />
            </audio>
        );
    }
    
    return (
        <div className="file-preview-generic">
            <FileIcon mimeType={file.mimeType} />
            <p>{file.name}</p>
        </div>
    );
}
        \`;
    }
}

export { FileUpload, S3StorageGenerator, FilePreviewGenerator };
`;
    }
}

export const fileManagerGenerator = FileManagerGenerator.getInstance();
