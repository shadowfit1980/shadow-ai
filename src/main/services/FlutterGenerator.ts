/**
 * ðŸ¦‹ Flutter Generator
 * 
 * Generate Flutter/Dart code:
 * - Widgets, state management, patterns
 */

import { EventEmitter } from 'events';

export class FlutterGenerator extends EventEmitter {
    private static instance: FlutterGenerator;

    private constructor() { super(); }

    static getInstance(): FlutterGenerator {
        if (!FlutterGenerator.instance) {
            FlutterGenerator.instance = new FlutterGenerator();
        }
        return FlutterGenerator.instance;
    }

    generateAppStructure(): string {
        return `// Flutter App Structure
// Generated by Shadow AI

// main.dart
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:go_router/go_router.dart';

import 'core/theme/app_theme.dart';
import 'features/auth/presentation/providers/auth_provider.dart';
import 'router/app_router.dart';

void main() {
  WidgetsFlutterBinding.ensureInitialized();
  runApp(const ProviderScope(child: MyApp()));
}

class MyApp extends ConsumerWidget {
  const MyApp({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final router = ref.watch(routerProvider);
    final themeMode = ref.watch(themeModeProvider);
    
    return MaterialApp.router(
      title: 'My App',
      theme: AppTheme.light,
      darkTheme: AppTheme.dark,
      themeMode: themeMode,
      routerConfig: router,
      debugShowCheckedModeBanner: false,
    );
  }
}

// router/app_router.dart
final routerProvider = Provider<GoRouter>((ref) {
  final authState = ref.watch(authStateProvider);
  
  return GoRouter(
    initialLocation: '/',
    redirect: (context, state) {
      final isLoggedIn = authState.isAuthenticated;
      final isLoggingIn = state.matchedLocation == '/login';
      
      if (!isLoggedIn && !isLoggingIn) return '/login';
      if (isLoggedIn && isLoggingIn) return '/';
      return null;
    },
    routes: [
      GoRoute(
        path: '/',
        builder: (context, state) => const HomeScreen(),
      ),
      GoRoute(
        path: '/login',
        builder: (context, state) => const LoginScreen(),
      ),
      GoRoute(
        path: '/profile',
        builder: (context, state) => const ProfileScreen(),
      ),
    ],
  );
});

// core/theme/app_theme.dart
class AppTheme {
  static final light = ThemeData(
    useMaterial3: true,
    colorScheme: ColorScheme.fromSeed(
      seedColor: Colors.blue,
      brightness: Brightness.light,
    ),
    appBarTheme: const AppBarTheme(
      centerTitle: true,
      elevation: 0,
    ),
    inputDecorationTheme: InputDecorationTheme(
      border: OutlineInputBorder(
        borderRadius: BorderRadius.circular(12),
      ),
      filled: true,
    ),
  );
  
  static final dark = ThemeData(
    useMaterial3: true,
    colorScheme: ColorScheme.fromSeed(
      seedColor: Colors.blue,
      brightness: Brightness.dark,
    ),
  );
}
`;
    }

    generateWidget(name: string): string {
        return `// ${name} Widget
// Generated by Shadow AI

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';

class ${name}Screen extends ConsumerStatefulWidget {
  const ${name}Screen({super.key});

  @override
  ConsumerState<${name}Screen> createState() => _${name}ScreenState();
}

class _${name}ScreenState extends ConsumerState<${name}Screen> {
  @override
  Widget build(BuildContext context) {
    final data = ref.watch(${name.toLowerCase()}Provider);
    
    return Scaffold(
      appBar: AppBar(
        title: const Text('${name}'),
        actions: [
          IconButton(
            icon: const Icon(Icons.refresh),
            onPressed: () => ref.refresh(${name.toLowerCase()}Provider),
          ),
        ],
      ),
      body: data.when(
        loading: () => const Center(child: CircularProgressIndicator()),
        error: (error, stack) => Center(
          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              Text('Error: \$error'),
              ElevatedButton(
                onPressed: () => ref.refresh(${name.toLowerCase()}Provider),
                child: const Text('Retry'),
              ),
            ],
          ),
        ),
        data: (items) => RefreshIndicator(
          onRefresh: () => ref.refresh(${name.toLowerCase()}Provider.future),
          child: ListView.builder(
            padding: const EdgeInsets.all(16),
            itemCount: items.length,
            itemBuilder: (context, index) {
              final item = items[index];
              return Card(
                child: ListTile(
                  title: Text(item.title),
                  subtitle: Text(item.description),
                  trailing: const Icon(Icons.chevron_right),
                  onTap: () => _onItemTap(item),
                ),
              );
            },
          ),
        ),
      ),
      floatingActionButton: FloatingActionButton(
        onPressed: _onAdd,
        child: const Icon(Icons.add),
      ),
    );
  }
  
  void _onItemTap(item) {
    // Navigate to detail
  }
  
  void _onAdd() {
    // Show add dialog
  }
}

// Provider
final ${name.toLowerCase()}Provider = FutureProvider.autoDispose((ref) async {
  final repository = ref.watch(repositoryProvider);
  return repository.getAll();
});
`;
    }

    generateRiverpodProviders(): string {
        return `// Riverpod Providers
// Generated by Shadow AI

import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:freezed_annotation/freezed_annotation.dart';

part 'providers.freezed.dart';

// State class with Freezed
@freezed
class AppState with _\$AppState {
  const factory AppState({
    @Default(false) bool isLoading,
    @Default(null) String? error,
    @Default([]) List<Item> items,
  }) = _AppState;
}

// StateNotifier
class AppStateNotifier extends StateNotifier<AppState> {
  AppStateNotifier(this._repository) : super(const AppState());
  
  final Repository _repository;
  
  Future<void> loadItems() async {
    state = state.copyWith(isLoading: true, error: null);
    
    try {
      final items = await _repository.getItems();
      state = state.copyWith(items: items, isLoading: false);
    } catch (e) {
      state = state.copyWith(error: e.toString(), isLoading: false);
    }
  }
  
  Future<void> addItem(Item item) async {
    final newItem = await _repository.create(item);
    state = state.copyWith(items: [...state.items, newItem]);
  }
  
  Future<void> removeItem(String id) async {
    await _repository.delete(id);
    state = state.copyWith(
      items: state.items.where((i) => i.id != id).toList(),
    );
  }
}

// Provider
final appStateProvider = StateNotifierProvider<AppStateNotifier, AppState>((ref) {
  return AppStateNotifier(ref.watch(repositoryProvider));
});

// AsyncNotifier (Riverpod 2.0+)
class ItemsNotifier extends AsyncNotifier<List<Item>> {
  @override
  Future<List<Item>> build() async {
    return ref.watch(repositoryProvider).getItems();
  }
  
  Future<void> add(Item item) async {
    state = const AsyncLoading();
    state = await AsyncValue.guard(() async {
      await ref.read(repositoryProvider).create(item);
      return ref.read(repositoryProvider).getItems();
    });
  }
}

final itemsProvider = AsyncNotifierProvider<ItemsNotifier, List<Item>>(() {
  return ItemsNotifier();
});
`;
    }

    generateRepository(): string {
        return `// Repository Pattern
// Generated by Shadow AI

import 'package:dio/dio.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';

abstract class Repository<T> {
  Future<List<T>> getAll();
  Future<T> getById(String id);
  Future<T> create(T item);
  Future<T> update(String id, T item);
  Future<void> delete(String id);
}

class ApiRepository implements Repository<Item> {
  final Dio _dio;
  final String _baseUrl;
  
  ApiRepository(this._dio, this._baseUrl);
  
  @override
  Future<List<Item>> getAll() async {
    final response = await _dio.get('\$_baseUrl/items');
    return (response.data as List).map((e) => Item.fromJson(e)).toList();
  }
  
  @override
  Future<Item> getById(String id) async {
    final response = await _dio.get('\$_baseUrl/items/\$id');
    return Item.fromJson(response.data);
  }
  
  @override
  Future<Item> create(Item item) async {
    final response = await _dio.post('\$_baseUrl/items', data: item.toJson());
    return Item.fromJson(response.data);
  }
  
  @override
  Future<Item> update(String id, Item item) async {
    final response = await _dio.put('\$_baseUrl/items/\$id', data: item.toJson());
    return Item.fromJson(response.data);
  }
  
  @override
  Future<void> delete(String id) async {
    await _dio.delete('\$_baseUrl/items/\$id');
  }
}

// Provider
final dioProvider = Provider((ref) {
  final dio = Dio(BaseOptions(
    connectTimeout: const Duration(seconds: 5),
    receiveTimeout: const Duration(seconds: 3),
  ));
  
  dio.interceptors.add(LogInterceptor());
  
  return dio;
});

final repositoryProvider = Provider((ref) {
  return ApiRepository(ref.watch(dioProvider), 'https://api.example.com');
});
`;
    }
}

export const flutterGenerator = FlutterGenerator.getInstance();
