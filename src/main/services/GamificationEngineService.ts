/**
 * ðŸŽ® GamificationEngineService
 * 
 * Developer gamification:
 * - XP, achievements, leaderboards
 */

import { EventEmitter } from 'events';

export class GamificationEngineService extends EventEmitter {
    private static instance: GamificationEngineService;
    private constructor() { super(); }
    static getInstance(): GamificationEngineService {
        if (!GamificationEngineService.instance) {
            GamificationEngineService.instance = new GamificationEngineService();
        }
        return GamificationEngineService.instance;
    }

    generate(): string {
        return `// Gamification Engine Service - XP and achievements
// Generated by Shadow AI

interface DeveloperProfile {
    id: string;
    name: string;
    level: number;
    xp: number;
    xpToNextLevel: number;
    achievements: Achievement[];
    streaks: Record<string, number>;
    stats: DeveloperStats;
}

interface Achievement {
    id: string;
    name: string;
    description: string;
    icon: string;
    rarity: 'common' | 'uncommon' | 'rare' | 'epic' | 'legendary';
    unlockedAt?: number;
    progress?: number;
    target?: number;
}

interface DeveloperStats {
    linesWritten: number;
    bugsFixed: number;
    testsWritten: number;
    codeReviews: number;
    documentsCreated: number;
    aiInteractions: number;
    commitsToday: number;
}

class GamificationEngine {
    private profiles: Map<string, DeveloperProfile> = new Map();
    
    private achievements: Achievement[] = [
        { id: 'first-commit', name: 'First Steps', description: 'Make your first commit', icon: 'ðŸ‘¶', rarity: 'common' },
        { id: 'bug-squasher', name: 'Bug Squasher', description: 'Fix 10 bugs', icon: 'ðŸ›', rarity: 'common', target: 10 },
        { id: 'test-writer', name: 'Test Master', description: 'Write 100 tests', icon: 'ðŸ§ª', rarity: 'uncommon', target: 100 },
        { id: 'streak-7', name: 'Week Warrior', description: 'Code for 7 days straight', icon: 'ðŸ”¥', rarity: 'uncommon', target: 7 },
        { id: 'streak-30', name: 'Monthly Master', description: 'Code for 30 days straight', icon: 'âš¡', rarity: 'rare', target: 30 },
        { id: 'ai-friend', name: 'AI Friend', description: '100 AI interactions', icon: 'ðŸ¤–', rarity: 'uncommon', target: 100 },
        { id: 'code-ninja', name: 'Code Ninja', description: '1000 lines in one day', icon: 'ðŸ¥·', rarity: 'rare', target: 1000 },
        { id: 'clean-code', name: 'Clean Coder', description: '0 linting errors for a week', icon: 'âœ¨', rarity: 'rare', target: 7 },
        { id: 'reviewer', name: 'Code Sage', description: 'Review 50 PRs', icon: 'ðŸ“–', rarity: 'uncommon', target: 50 },
        { id: 'mentor', name: 'Mentor', description: 'Help 10 teammates', icon: 'ðŸŽ“', rarity: 'rare', target: 10 },
        { id: 'architect', name: 'Architect', description: 'Design 5 systems', icon: 'ðŸ›ï¸', rarity: 'epic', target: 5 },
        { id: 'legend', name: 'Legend', description: 'Reach level 50', icon: 'ðŸ‘‘', rarity: 'legendary', target: 50 }
    ];
    
    // Get or create profile
    getProfile(userId: string): DeveloperProfile {
        if (!this.profiles.has(userId)) {
            this.profiles.set(userId, {
                id: userId,
                name: 'Developer',
                level: 1,
                xp: 0,
                xpToNextLevel: 100,
                achievements: [],
                streaks: { coding: 0, commits: 0, reviews: 0 },
                stats: {
                    linesWritten: 0,
                    bugsFixed: 0,
                    testsWritten: 0,
                    codeReviews: 0,
                    documentsCreated: 0,
                    aiInteractions: 0,
                    commitsToday: 0
                }
            });
        }
        return this.profiles.get(userId)!;
    }
    
    // Award XP
    awardXP(userId: string, amount: number, reason: string): XPAward {
        const profile = this.getProfile(userId);
        profile.xp += amount;
        
        const leveledUp = this.checkLevelUp(profile);
        
        this.emit('xp-awarded', { userId, amount, reason, newTotal: profile.xp, leveledUp });
        
        return { amount, newTotal: profile.xp, leveledUp };
    }
    
    private checkLevelUp(profile: DeveloperProfile): boolean {
        if (profile.xp >= profile.xpToNextLevel) {
            profile.level++;
            profile.xp -= profile.xpToNextLevel;
            profile.xpToNextLevel = Math.floor(profile.xpToNextLevel * 1.5);
            
            this.emit('level-up', { userId: profile.id, newLevel: profile.level });
            
            return true;
        }
        return false;
    }
    
    // Record activity
    recordActivity(userId: string, activity: ActivityType): void {
        const profile = this.getProfile(userId);
        
        const xpMap: Record<ActivityType, number> = {
            'commit': 10,
            'bug-fix': 25,
            'test-write': 15,
            'code-review': 20,
            'doc-create': 15,
            'ai-interaction': 5,
            'feature-complete': 50
        };
        
        const xp = xpMap[activity] || 5;
        this.awardXP(userId, xp, activity);
        
        // Update stats
        this.updateStats(profile, activity);
        
        // Check achievements
        this.checkAchievements(profile);
    }
    
    private updateStats(profile: DeveloperProfile, activity: ActivityType): void {
        switch (activity) {
            case 'commit':
                profile.stats.commitsToday++;
                break;
            case 'bug-fix':
                profile.stats.bugsFixed++;
                break;
            case 'test-write':
                profile.stats.testsWritten++;
                break;
            case 'code-review':
                profile.stats.codeReviews++;
                break;
            case 'ai-interaction':
                profile.stats.aiInteractions++;
                break;
        }
    }
    
    private checkAchievements(profile: DeveloperProfile): void {
        for (const achievement of this.achievements) {
            if (profile.achievements.find(a => a.id === achievement.id)) continue;
            
            let unlocked = false;
            
            switch (achievement.id) {
                case 'first-commit':
                    unlocked = profile.stats.commitsToday > 0;
                    break;
                case 'bug-squasher':
                    unlocked = profile.stats.bugsFixed >= (achievement.target || 10);
                    break;
                case 'test-writer':
                    unlocked = profile.stats.testsWritten >= (achievement.target || 100);
                    break;
                case 'ai-friend':
                    unlocked = profile.stats.aiInteractions >= (achievement.target || 100);
                    break;
                case 'legend':
                    unlocked = profile.level >= (achievement.target || 50);
                    break;
            }
            
            if (unlocked) {
                this.unlockAchievement(profile, achievement);
            }
        }
    }
    
    private unlockAchievement(profile: DeveloperProfile, achievement: Achievement): void {
        profile.achievements.push({
            ...achievement,
            unlockedAt: Date.now()
        });
        
        this.emit('achievement-unlocked', {
            userId: profile.id,
            achievement: achievement.name,
            rarity: achievement.rarity
        });
    }
    
    // Get leaderboard
    getLeaderboard(metric: 'xp' | 'level' | 'achievements'): LeaderboardEntry[] {
        const profiles = Array.from(this.profiles.values());
        
        return profiles
            .map(p => ({
                userId: p.id,
                name: p.name,
                value: metric === 'xp' ? p.xp : metric === 'level' ? p.level : p.achievements.length,
                level: p.level
            }))
            .sort((a, b) => b.value - a.value)
            .slice(0, 10)
            .map((entry, index) => ({ ...entry, rank: index + 1 }));
    }
    
    // Get available achievements
    getAvailableAchievements(): Achievement[] {
        return this.achievements;
    }
    
    // Update streak
    updateStreak(userId: string, streakType: string): void {
        const profile = this.getProfile(userId);
        profile.streaks[streakType] = (profile.streaks[streakType] || 0) + 1;
        
        // Bonus XP for streaks
        if (profile.streaks[streakType] % 7 === 0) {
            this.awardXP(userId, 50, \`\${streakType} streak bonus\`);
        }
    }
}

type ActivityType = 'commit' | 'bug-fix' | 'test-write' | 'code-review' | 'doc-create' | 'ai-interaction' | 'feature-complete';

export { GamificationEngine };
`;
    }
}

export const gamificationEngineService = GamificationEngineService.getInstance();
