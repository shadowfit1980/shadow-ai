/**
 * ðŸ”’ InputSanitizerGenerator
 * 
 * Input sanitization:
 * - XSS, SQL, validation
 */

import { EventEmitter } from 'events';

export class InputSanitizerGenerator extends EventEmitter {
    private static instance: InputSanitizerGenerator;
    private constructor() { super(); }
    static getInstance(): InputSanitizerGenerator {
        if (!InputSanitizerGenerator.instance) {
            InputSanitizerGenerator.instance = new InputSanitizerGenerator();
        }
        return InputSanitizerGenerator.instance;
    }

    generate(): string {
        return `// Input Sanitizer Generator - XSS, SQL, validation
// Generated by Shadow AI

import DOMPurify from 'isomorphic-dompurify';
import { z } from 'zod';

// HTML Sanitizer
function sanitizeHtml(dirty: string, options?: { allowedTags?: string[] }): string {
    return DOMPurify.sanitize(dirty, {
        ALLOWED_TAGS: options?.allowedTags || ['b', 'i', 'em', 'strong', 'a', 'p', 'br'],
        ALLOWED_ATTR: ['href', 'target']
    });
}

// SQL Injection Prevention
function escapeSql(value: string): string {
    return value.replace(/[\0\\x08\\x09\\x1a\\n\\r"'\\\\%]/g, (char) => {
        switch (char) {
            case '\\0': return '\\\\0';
            case '\\x08': return '\\\\b';
            case '\\x09': return '\\\\t';
            case '\\x1a': return '\\\\z';
            case '\\n': return '\\\\n';
            case '\\r': return '\\\\r';
            case "'": return "''";
            case '"': return '""';
            case '\\\\': return '\\\\\\\\';
            case '%': return '\\\\%';
            default: return char;
        }
    });
}

// Common Validators
const validators = {
    email: z.string().email(),
    url: z.string().url(),
    phone: z.string().regex(/^\\+?[1-9]\\d{1,14}$/),
    uuid: z.string().uuid(),
    slug: z.string().regex(/^[a-z0-9]+(?:-[a-z0-9]+)*$/),
    strongPassword: z.string()
        .min(8)
        .regex(/[A-Z]/, 'Must contain uppercase')
        .regex(/[a-z]/, 'Must contain lowercase')
        .regex(/[0-9]/, 'Must contain number')
        .regex(/[^a-zA-Z0-9]/, 'Must contain special character')
};

// Express Sanitization Middleware
function sanitizationMiddleware(options: { xss?: boolean; trim?: boolean; escape?: boolean }) {
    return (req: any, res: any, next: Function) => {
        const sanitize = (obj: any): any => {
            if (typeof obj === 'string') {
                let result = obj;
                if (options.trim) result = result.trim();
                if (options.xss) result = sanitizeHtml(result);
                return result;
            }
            if (Array.isArray(obj)) return obj.map(sanitize);
            if (typeof obj === 'object' && obj !== null) {
                return Object.fromEntries(
                    Object.entries(obj).map(([k, v]) => [k, sanitize(v)])
                );
            }
            return obj;
        };
        
        req.body = sanitize(req.body);
        req.query = sanitize(req.query);
        req.params = sanitize(req.params);
        
        next();
    };
}

// Zod Schema Factory
function createSchema<T extends z.ZodRawShape>(shape: T) {
    return z.object(shape).strict();
}

// Form Validation Hook
export function useFormValidation<T>(schema: z.ZodSchema<T>) {
    const [errors, setErrors] = useState<Record<string, string>>({});
    
    const validate = (data: unknown): T | null => {
        try {
            const result = schema.parse(data);
            setErrors({});
            return result;
        } catch (error) {
            if (error instanceof z.ZodError) {
                const newErrors: Record<string, string> = {};
                error.errors.forEach(e => {
                    newErrors[e.path.join('.')] = e.message;
                });
                setErrors(newErrors);
            }
            return null;
        }
    };
    
    return { errors, validate };
}

export { sanitizeHtml, escapeSql, validators, sanitizationMiddleware, createSchema, useFormValidation };
`;
    }
}

export const inputSanitizerGenerator = InputSanitizerGenerator.getInstance();
