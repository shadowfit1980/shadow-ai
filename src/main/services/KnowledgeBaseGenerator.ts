/**
 * üìÅ KnowledgeBaseGenerator
 * 
 * Knowledge base:
 * - Articles, search, categories
 */

import { EventEmitter } from 'events';

export class KnowledgeBaseGenerator extends EventEmitter {
    private static instance: KnowledgeBaseGenerator;
    private constructor() { super(); }
    static getInstance(): KnowledgeBaseGenerator {
        if (!KnowledgeBaseGenerator.instance) {
            KnowledgeBaseGenerator.instance = new KnowledgeBaseGenerator();
        }
        return KnowledgeBaseGenerator.instance;
    }

    generate(): string {
        return `// Knowledge Base Generator - Articles, search
// Generated by Shadow AI

// Article Schema
model Article {
    id         String   @id @default(cuid())
    title      String
    slug       String   @unique
    content    String
    excerpt    String?
    categoryId String
    category   Category @relation(fields: [categoryId], references: [id])
    tags       String[]
    status     ArticleStatus @default(DRAFT)
    views      Int      @default(0)
    helpful    Int      @default(0)
    notHelpful Int      @default(0)
    authorId   String
    publishedAt DateTime?
    createdAt  DateTime @default(now())
    updatedAt  DateTime @updatedAt
}

// Knowledge Base Service
class KnowledgeBaseService {
    async createArticle(data: CreateArticleData) {
        return prisma.article.create({
            data: {
                title: data.title,
                slug: this.slugify(data.title),
                content: data.content,
                excerpt: data.excerpt || this.generateExcerpt(data.content),
                categoryId: data.categoryId,
                tags: data.tags || [],
                authorId: data.authorId
            }
        });
    }
    
    async publishArticle(id: string) {
        return prisma.article.update({
            where: { id },
            data: { status: 'PUBLISHED', publishedAt: new Date() }
        });
    }
    
    async search(query: string) {
        return prisma.article.findMany({
            where: {
                status: 'PUBLISHED',
                OR: [
                    { title: { contains: query, mode: 'insensitive' } },
                    { content: { contains: query, mode: 'insensitive' } },
                    { tags: { hasSome: [query] } }
                ]
            },
            orderBy: { views: 'desc' }
        });
    }
    
    async trackView(id: string) {
        await prisma.article.update({
            where: { id },
            data: { views: { increment: 1 } }
        });
    }
    
    async rateHelpful(id: string, helpful: boolean) {
        await prisma.article.update({
            where: { id },
            data: helpful ? { helpful: { increment: 1 } } : { notHelpful: { increment: 1 } }
        });
    }
    
    async getPopularArticles(limit = 10) {
        return prisma.article.findMany({
            where: { status: 'PUBLISHED' },
            orderBy: { views: 'desc' },
            take: limit
        });
    }
    
    private slugify(text: string): string {
        return text.toLowerCase().replace(/\\s+/g, '-').replace(/[^a-z0-9-]/g, '');
    }
    
    private generateExcerpt(content: string, length = 200): string {
        const plain = content.replace(/<[^>]*>/g, '');
        return plain.slice(0, length) + (plain.length > length ? '...' : '');
    }
}

// Knowledge Base UI
export function KnowledgeBase() {
    const [searchQuery, setSearchQuery] = useState('');
    const [selectedCategory, setSelectedCategory] = useState<string | null>(null);
    
    const { data: categories } = useQuery(['kb-categories'], getCategories);
    const { data: articles } = useQuery(['kb-articles', searchQuery, selectedCategory], () => 
        searchArticles(searchQuery, selectedCategory)
    );
    
    return (
        <div className="knowledge-base">
            <div className="kb-header">
                <h1>Knowledge Base</h1>
                <SearchInput value={searchQuery} onChange={setSearchQuery} />
            </div>
            
            <div className="kb-layout">
                <aside className="kb-sidebar">
                    <h3>Categories</h3>
                    <CategoryList categories={categories} selected={selectedCategory} onSelect={setSelectedCategory} />
                </aside>
                
                <main className="kb-content">
                    {articles?.map(article => (
                        <ArticleCard key={article.id} article={article} />
                    ))}
                </main>
            </div>
        </div>
    );
}

export { KnowledgeBaseService, KnowledgeBase };
`;
    }
}

export const knowledgeBaseGenerator = KnowledgeBaseGenerator.getInstance();
