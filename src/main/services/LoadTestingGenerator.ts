/**
 * ðŸ“ˆ Load Testing Generator
 * 
 * Generate load tests:
 * - k6, Artillery
 */

import { EventEmitter } from 'events';

export class LoadTestingGenerator extends EventEmitter {
    private static instance: LoadTestingGenerator;

    private constructor() { super(); }

    static getInstance(): LoadTestingGenerator {
        if (!LoadTestingGenerator.instance) {
            LoadTestingGenerator.instance = new LoadTestingGenerator();
        }
        return LoadTestingGenerator.instance;
    }

    generateK6(): string {
        return `// k6 Load Test
// Generated by Shadow AI
// Run: k6 run load-test.js

import http from 'k6/http';
import { check, sleep, group } from 'k6';
import { Rate, Trend, Counter } from 'k6/metrics';

// Custom metrics
const errorRate = new Rate('errors');
const loginDuration = new Trend('login_duration');
const apiCalls = new Counter('api_calls');

// Test configuration
export const options = {
    // Stages for ramping up/down
    stages: [
        { duration: '30s', target: 10 },   // Ramp up to 10 users
        { duration: '1m', target: 50 },    // Ramp up to 50 users
        { duration: '2m', target: 50 },    // Stay at 50 users
        { duration: '30s', target: 100 },  // Spike to 100 users
        { duration: '1m', target: 100 },   // Stay at 100
        { duration: '30s', target: 0 }     // Ramp down
    ],
    
    // Thresholds for pass/fail
    thresholds: {
        http_req_duration: ['p(95)<500', 'p(99)<1000'], // 95% requests < 500ms
        http_req_failed: ['rate<0.01'],                  // Error rate < 1%
        errors: ['rate<0.05'],                           // Custom error rate < 5%
        login_duration: ['p(95)<2000']                   // Login < 2s
    }
};

const BASE_URL = __ENV.BASE_URL || 'http://localhost:3000';

// Setup - runs once per VU
export function setup() {
    const loginRes = http.post(\`\${BASE_URL}/api/auth/login\`, JSON.stringify({
        email: 'loadtest@example.com',
        password: 'testpassword'
    }), { headers: { 'Content-Type': 'application/json' } });

    return { token: loginRes.json('token') };
}

// Main test function
export default function(data) {
    const headers = {
        'Content-Type': 'application/json',
        'Authorization': \`Bearer \${data.token}\`
    };

    group('Homepage', () => {
        const res = http.get(\`\${BASE_URL}/\`);
        check(res, {
            'homepage status 200': (r) => r.status === 200,
            'homepage load time < 500ms': (r) => r.timings.duration < 500
        });
        apiCalls.add(1);
    });

    group('API - List Users', () => {
        const res = http.get(\`\${BASE_URL}/api/users\`, { headers });
        const success = check(res, {
            'users list status 200': (r) => r.status === 200,
            'users returned': (r) => r.json('length') > 0
        });
        errorRate.add(!success);
        apiCalls.add(1);
    });

    group('API - Create User', () => {
        const payload = JSON.stringify({
            name: \`User \${Date.now()}\`,
            email: \`user\${Date.now()}@test.com\`
        });
        
        const res = http.post(\`\${BASE_URL}/api/users\`, payload, { headers });
        check(res, {
            'create user status 201': (r) => r.status === 201
        });
        apiCalls.add(1);
    });

    group('API - Get Single User', () => {
        const res = http.get(\`\${BASE_URL}/api/users/1\`, { headers });
        check(res, {
            'get user status 200': (r) => r.status === 200,
            'user has id': (r) => r.json('id') !== undefined
        });
        apiCalls.add(1);
    });

    sleep(1); // Think time between iterations
}

// Teardown - runs once at end
export function teardown(data) {
    console.log('Load test complete');
}
`;
    }

    generateArtillery(): string {
        return `// Artillery Load Test
// Generated by Shadow AI
// Run: artillery run artillery.yml

# artillery.yml
config:
  target: "http://localhost:3000"
  phases:
    - duration: 60
      arrivalRate: 5
      name: "Warm up"
    - duration: 120
      arrivalRate: 20
      name: "Ramp up load"
    - duration: 60
      arrivalRate: 50
      name: "Sustained load"
    - duration: 30
      arrivalRate: 100
      name: "Spike"

  defaults:
    headers:
      Content-Type: "application/json"

  plugins:
    expect: {}

  variables:
    baseUrl: "http://localhost:3000"

  processor: "./functions.js"

scenarios:
  - name: "User Journey"
    weight: 70
    flow:
      - post:
          url: "/api/auth/login"
          json:
            email: "test@example.com"
            password: "password"
          capture:
            - json: "$.token"
              as: "authToken"
          expect:
            - statusCode: 200
            - hasProperty: "token"

      - get:
          url: "/api/users"
          headers:
            Authorization: "Bearer {{ authToken }}"
          expect:
            - statusCode: 200
            - contentType: json

      - think: 2

      - get:
          url: "/api/posts"
          headers:
            Authorization: "Bearer {{ authToken }}"
          capture:
            - json: "$[0].id"
              as: "postId"

      - get:
          url: "/api/posts/{{ postId }}"
          headers:
            Authorization: "Bearer {{ authToken }}"
          expect:
            - statusCode: 200

  - name: "API Health Check"
    weight: 30
    flow:
      - get:
          url: "/health"
          expect:
            - statusCode: 200

# functions.js (processor)
module.exports = {
  generateUser: function(context, events, done) {
    context.vars.email = \`user\${Date.now()}@test.com\`;
    context.vars.name = \`Test User \${Date.now()}\`;
    return done();
  },

  logResponse: function(requestParams, response, context, ee, next) {
    console.log(\`Status: \${response.statusCode}, URL: \${requestParams.url}\`);
    return next();
  }
};
`;
    }
}

export const loadTestingGenerator = LoadTestingGenerator.getInstance();
