/**
 * ❤️ Love2D Exporter
 * 
 * Export to Love2D (Lua):
 * - main.lua generation
 * - Lua code templates
 * - Love2D API wrappers
 */

import { EventEmitter } from 'events';

export class Love2DExporter extends EventEmitter {
    private static instance: Love2DExporter;

    private constructor() { super(); }

    static getInstance(): Love2DExporter {
        if (!Love2DExporter.instance) {
            Love2DExporter.instance = new Love2DExporter();
        }
        return Love2DExporter.instance;
    }

    exportToLove2D(gameDef: any): { files: any[] } {
        return {
            files: [
                { name: 'main.lua', content: this.generateMainLua(gameDef) },
                { name: 'player.lua', content: this.generatePlayerLua() },
                { name: 'conf.lua', content: this.generateConfLua(gameDef) }
            ]
        };
    }

    generateMainLua(gameDef: any): string {
        const name = gameDef?.name || 'My Game';
        return `-- ${name}
-- Generated by Shadow AI

require "player"

local player
local enemies = {}
local score = 0

function love.load()
    love.window.setTitle("${name}")
    love.graphics.setBackgroundColor(0.1, 0.1, 0.2)
    
    player = Player:new(400, 300)
    
    -- Spawn initial enemies
    for i = 1, 5 do
        spawnEnemy()
    end
end

function love.update(dt)
    -- Update player
    player:update(dt)
    
    -- Update enemies
    for i = #enemies, 1, -1 do
        local enemy = enemies[i]
        enemy:update(dt)
        
        -- Check collision with player
        if checkCollision(player, enemy) then
            player:takeDamage(10)
            table.remove(enemies, i)
            spawnEnemy()
        end
    end
    
    -- Check player bullets
    for i = #player.bullets, 1, -1 do
        local bullet = player.bullets[i]
        for j = #enemies, 1, -1 do
            if checkCollision(bullet, enemies[j]) then
                table.remove(enemies, j)
                table.remove(player.bullets, i)
                score = score + 10
                spawnEnemy()
                break
            end
        end
    end
end

function love.draw()
    -- Draw player
    player:draw()
    
    -- Draw enemies
    for _, enemy in ipairs(enemies) do
        enemy:draw()
    end
    
    -- Draw UI
    love.graphics.setColor(1, 1, 1)
    love.graphics.print("Score: " .. score, 10, 10)
    love.graphics.print("Health: " .. player.health, 10, 30)
end

function love.keypressed(key)
    if key == "space" then
        player:shoot()
    end
    if key == "escape" then
        love.event.quit()
    end
end

function spawnEnemy()
    local x = love.math.random(50, love.graphics.getWidth() - 50)
    local y = love.math.random(50, 200)
    table.insert(enemies, {
        x = x,
        y = y,
        width = 30,
        height = 30,
        speed = love.math.random(50, 150),
        direction = 1,
        update = function(self, dt)
            self.y = self.y + self.speed * dt
            if self.y > love.graphics.getHeight() then
                self.y = -30
                self.x = love.math.random(50, love.graphics.getWidth() - 50)
            end
        end,
        draw = function(self)
            love.graphics.setColor(1, 0, 0)
            love.graphics.rectangle("fill", self.x, self.y, self.width, self.height)
        end
    })
end

function checkCollision(a, b)
    return a.x < b.x + b.width and
           a.x + a.width > b.x and
           a.y < b.y + b.height and
           a.y + a.height > b.y
end
`;
    }

    generatePlayerLua(): string {
        return `-- Player class

Player = {}
Player.__index = Player

function Player:new(x, y)
    local self = setmetatable({}, Player)
    self.x = x
    self.y = y
    self.width = 40
    self.height = 40
    self.speed = 200
    self.health = 100
    self.bullets = {}
    self.shootCooldown = 0
    return self
end

function Player:update(dt)
    -- Movement
    if love.keyboard.isDown("left") or love.keyboard.isDown("a") then
        self.x = self.x - self.speed * dt
    end
    if love.keyboard.isDown("right") or love.keyboard.isDown("d") then
        self.x = self.x + self.speed * dt
    end
    if love.keyboard.isDown("up") or love.keyboard.isDown("w") then
        self.y = self.y - self.speed * dt
    end
    if love.keyboard.isDown("down") or love.keyboard.isDown("s") then
        self.y = self.y + self.speed * dt
    end
    
    -- Clamp to screen
    self.x = math.max(0, math.min(self.x, love.graphics.getWidth() - self.width))
    self.y = math.max(0, math.min(self.y, love.graphics.getHeight() - self.height))
    
    -- Update bullets
    for i = #self.bullets, 1, -1 do
        local bullet = self.bullets[i]
        bullet.y = bullet.y - bullet.speed * dt
        if bullet.y < -10 then
            table.remove(self.bullets, i)
        end
    end
    
    -- Cooldown
    self.shootCooldown = math.max(0, self.shootCooldown - dt)
end

function Player:draw()
    -- Draw player
    love.graphics.setColor(0, 1, 0)
    love.graphics.rectangle("fill", self.x, self.y, self.width, self.height)
    
    -- Draw bullets
    love.graphics.setColor(1, 1, 0)
    for _, bullet in ipairs(self.bullets) do
        love.graphics.rectangle("fill", bullet.x, bullet.y, bullet.width, bullet.height)
    end
end

function Player:shoot()
    if self.shootCooldown > 0 then return end
    
    table.insert(self.bullets, {
        x = self.x + self.width / 2 - 3,
        y = self.y,
        width = 6,
        height = 15,
        speed = 400
    })
    
    self.shootCooldown = 0.2
end

function Player:takeDamage(amount)
    self.health = self.health - amount
    if self.health <= 0 then
        -- Game over
        love.event.quit()
    end
end

return Player
`;
    }

    generateConfLua(gameDef: any): string {
        const name = gameDef?.name || 'My Game';
        return `-- Configuration for ${name}

function love.conf(t)
    t.title = "${name}"
    t.version = "11.4"
    t.window.width = 800
    t.window.height = 600
    t.window.resizable = false
    t.console = false
    
    -- Modules
    t.modules.audio = true
    t.modules.data = true
    t.modules.event = true
    t.modules.graphics = true
    t.modules.image = true
    t.modules.joystick = true
    t.modules.keyboard = true
    t.modules.math = true
    t.modules.mouse = true
    t.modules.physics = true
    t.modules.sound = true
    t.modules.system = true
    t.modules.timer = true
    t.modules.touch = true
    t.modules.video = true
    t.modules.window = true
end
`;
    }
}

export const love2DExporter = Love2DExporter.getInstance();
