/**
 * ðŸ§© Micro-Frontends Generator
 * 
 * Generate micro-frontend patterns:
 * - Module Federation
 */

import { EventEmitter } from 'events';

export class MicroFrontends extends EventEmitter {
    private static instance: MicroFrontends;

    private constructor() { super(); }

    static getInstance(): MicroFrontends {
        if (!MicroFrontends.instance) {
            MicroFrontends.instance = new MicroFrontends();
        }
        return MicroFrontends.instance;
    }

    generate(): string {
        return `// Micro-Frontends with Module Federation
// Generated by Shadow AI

// === Host Application (Shell) ===
// webpack.config.js
const ModuleFederationPlugin = require('webpack/lib/container/ModuleFederationPlugin');

module.exports = {
    plugins: [
        new ModuleFederationPlugin({
            name: 'host',
            remotes: {
                products: 'products@http://localhost:3001/remoteEntry.js',
                cart: 'cart@http://localhost:3002/remoteEntry.js',
                checkout: 'checkout@http://localhost:3003/remoteEntry.js'
            },
            shared: {
                react: { singleton: true, requiredVersion: '^18.0.0' },
                'react-dom': { singleton: true, requiredVersion: '^18.0.0' },
                'react-router-dom': { singleton: true }
            }
        })
    ]
};

// Host App.tsx
import React, { Suspense, lazy } from 'react';
import { BrowserRouter, Routes, Route } from 'react-router-dom';
import { ErrorBoundary } from './components/ErrorBoundary';
import Header from './components/Header';

// Lazy load remote modules
const ProductList = lazy(() => import('products/ProductList'));
const ProductDetail = lazy(() => import('products/ProductDetail'));
const Cart = lazy(() => import('cart/Cart'));
const Checkout = lazy(() => import('checkout/Checkout'));

function App() {
    return (
        <BrowserRouter>
            <Header />
            <Suspense fallback={<div>Loading...</div>}>
                <ErrorBoundary fallback={<div>Failed to load module</div>}>
                    <Routes>
                        <Route path="/" element={<ProductList />} />
                        <Route path="/products/:id" element={<ProductDetail />} />
                        <Route path="/cart" element={<Cart />} />
                        <Route path="/checkout" element={<Checkout />} />
                    </Routes>
                </ErrorBoundary>
            </Suspense>
        </BrowserRouter>
    );
}

// Dynamic remote loading
async function loadRemote(scope: string, module: string) {
    await __webpack_init_sharing__('default');
    const container = window[scope];
    await container.init(__webpack_share_scopes__.default);
    const factory = await container.get(module);
    return factory();
}

// === Remote Application (Products) ===
// webpack.config.js
module.exports = {
    plugins: [
        new ModuleFederationPlugin({
            name: 'products',
            filename: 'remoteEntry.js',
            exposes: {
                './ProductList': './src/components/ProductList',
                './ProductDetail': './src/components/ProductDetail',
                './ProductCard': './src/components/ProductCard'
            },
            shared: {
                react: { singleton: true, requiredVersion: '^18.0.0' },
                'react-dom': { singleton: true, requiredVersion: '^18.0.0' }
            }
        })
    ]
};

// ProductList.tsx
import React from 'react';
import { useProducts } from '../hooks/useProducts';
import ProductCard from './ProductCard';

export default function ProductList() {
    const { products, loading, error } = useProducts();

    if (loading) return <div>Loading products...</div>;
    if (error) return <div>Error: {error.message}</div>;

    return (
        <div className="product-grid">
            {products.map(product => (
                <ProductCard key={product.id} product={product} />
            ))}
        </div>
    );
}

// === Shared State (Cross-MFE Communication) ===
// Using Custom Events
const eventBus = {
    emit(event: string, data: any) {
        window.dispatchEvent(new CustomEvent(event, { detail: data }));
    },
    on(event: string, callback: (data: any) => void) {
        window.addEventListener(event, (e: CustomEvent) => callback(e.detail));
    },
    off(event: string, callback: (data: any) => void) {
        window.removeEventListener(event, callback);
    }
};

// Usage in Products MFE
function addToCart(product: Product) {
    eventBus.emit('cart:add', { product, quantity: 1 });
}

// Usage in Cart MFE
useEffect(() => {
    const handleAdd = (data) => {
        setItems(prev => [...prev, data]);
    };
    eventBus.on('cart:add', handleAdd);
    return () => eventBus.off('cart:add', handleAdd);
}, []);

// Using a Shared Store (Zustand)
// shared-store/index.ts
import { create } from 'zustand';

interface CartStore {
    items: CartItem[];
    addItem: (item: CartItem) => void;
    removeItem: (id: string) => void;
    clear: () => void;
}

export const useCartStore = create<CartStore>((set) => ({
    items: [],
    addItem: (item) => set((state) => ({ items: [...state.items, item] })),
    removeItem: (id) => set((state) => ({ items: state.items.filter(i => i.id !== id) })),
    clear: () => set({ items: [] })
}));

// Expose as shared module
// In both host and remote webpack configs:
shared: {
    '@myapp/shared-store': { singleton: true }
}

// === Next.js Module Federation ===
// next.config.js
const NextFederationPlugin = require('@module-federation/nextjs-mf');

module.exports = {
    webpack(config, options) {
        config.plugins.push(
            new NextFederationPlugin({
                name: 'host',
                filename: 'static/chunks/remoteEntry.js',
                remotes: {
                    products: \`products@\${process.env.PRODUCTS_URL}/_next/static/chunks/remoteEntry.js\`
                },
                shared: {}
            })
        );
        return config;
    }
};

// Dynamic import in Next.js
import dynamic from 'next/dynamic';

const RemoteProductList = dynamic(
    () => import('products/ProductList'),
    { ssr: false, loading: () => <p>Loading...</p> }
);

export { eventBus, useCartStore };
`;
    }
}

export const microFrontends = MicroFrontends.getInstance();
