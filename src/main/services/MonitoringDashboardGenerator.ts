/**
 * ðŸ“Š MonitoringDashboardGenerator
 * 
 * Monitoring:
 * - Metrics, alerts, dashboards
 */

import { EventEmitter } from 'events';

export class MonitoringDashboardGenerator extends EventEmitter {
    private static instance: MonitoringDashboardGenerator;
    private constructor() { super(); }
    static getInstance(): MonitoringDashboardGenerator {
        if (!MonitoringDashboardGenerator.instance) {
            MonitoringDashboardGenerator.instance = new MonitoringDashboardGenerator();
        }
        return MonitoringDashboardGenerator.instance;
    }

    generate(): string {
        return `// Monitoring Dashboard Generator - Metrics, alerts, dashboards
// Generated by Shadow AI

// Prometheus Metrics
import { Registry, Counter, Gauge, Histogram, Summary } from 'prom-client';

class MetricsService {
    private registry: Registry;
    
    httpRequestsTotal: Counter;
    httpRequestDuration: Histogram;
    activeConnections: Gauge;
    responseSize: Summary;
    
    constructor() {
        this.registry = new Registry();
        
        this.httpRequestsTotal = new Counter({
            name: 'http_requests_total',
            help: 'Total number of HTTP requests',
            labelNames: ['method', 'path', 'status'],
            registers: [this.registry]
        });
        
        this.httpRequestDuration = new Histogram({
            name: 'http_request_duration_seconds',
            help: 'HTTP request duration in seconds',
            labelNames: ['method', 'path'],
            buckets: [0.01, 0.05, 0.1, 0.5, 1, 2, 5],
            registers: [this.registry]
        });
        
        this.activeConnections = new Gauge({
            name: 'active_connections',
            help: 'Number of active connections',
            registers: [this.registry]
        });
        
        this.responseSize = new Summary({
            name: 'http_response_size_bytes',
            help: 'HTTP response size in bytes',
            labelNames: ['method', 'path'],
            registers: [this.registry]
        });
    }
    
    async getMetrics() {
        return this.registry.metrics();
    }
}

// Express Middleware for Metrics
function metricsMiddleware(metrics: MetricsService) {
    return (req: any, res: any, next: Function) => {
        const start = Date.now();
        metrics.activeConnections.inc();
        
        res.on('finish', () => {
            const duration = (Date.now() - start) / 1000;
            metrics.httpRequestsTotal.inc({
                method: req.method,
                path: req.route?.path || req.path,
                status: res.statusCode
            });
            metrics.httpRequestDuration.observe({
                method: req.method,
                path: req.route?.path || req.path
            }, duration);
            metrics.activeConnections.dec();
        });
        
        next();
    };
}

// Alert Configuration
interface AlertRule {
    name: string;
    query: string;
    threshold: number;
    duration: string;
    severity: 'warning' | 'critical';
    channels: string[];
}

const defaultAlerts: AlertRule[] = [
    {
        name: 'HighErrorRate',
        query: 'sum(rate(http_requests_total{status=~"5.."}[5m])) / sum(rate(http_requests_total[5m])) > 0.05',
        threshold: 0.05,
        duration: '5m',
        severity: 'critical',
        channels: ['slack', 'pagerduty']
    },
    {
        name: 'HighLatency',
        query: 'histogram_quantile(0.99, rate(http_request_duration_seconds_bucket[5m])) > 1',
        threshold: 1,
        duration: '5m',
        severity: 'warning',
        channels: ['slack']
    },
    {
        name: 'HighMemoryUsage',
        query: 'process_resident_memory_bytes / 1024 / 1024 > 512',
        threshold: 512,
        duration: '10m',
        severity: 'warning',
        channels: ['slack']
    }
];

// Dashboard Component
export function MonitoringDashboard() {
    const { data: metrics } = useQuery(['metrics'], fetchMetrics, { refetchInterval: 10000 });
    
    return (
        <div className="monitoring-dashboard">
            <h1>System Monitoring</h1>
            
            <div className="metrics-grid">
                <MetricCard title="Requests/sec" value={metrics?.requestsPerSecond} trend={metrics?.requestsTrend} />
                <MetricCard title="P99 Latency" value={metrics?.p99Latency} unit="ms" />
                <MetricCard title="Error Rate" value={metrics?.errorRate} unit="%" />
                <MetricCard title="Active Connections" value={metrics?.activeConnections} />
            </div>
            
            <div className="charts">
                <Chart title="Request Rate" data={metrics?.requestRateHistory} />
                <Chart title="Latency Distribution" data={metrics?.latencyHistory} />
            </div>
            
            <AlertsList alerts={metrics?.activeAlerts || []} />
        </div>
    );
}

export { MetricsService, metricsMiddleware, defaultAlerts, MonitoringDashboard };
`;
    }
}

export const monitoringDashboardGenerator = MonitoringDashboardGenerator.getInstance();
