/**
 * ðŸ”” NotificationCenter
 * 
 * In-app notifications:
 * - Toast, bell, inbox, preferences
 */

import { EventEmitter } from 'events';

export class NotificationCenter extends EventEmitter {
    private static instance: NotificationCenter;

    private constructor() { super(); }

    static getInstance(): NotificationCenter {
        if (!NotificationCenter.instance) {
            NotificationCenter.instance = new NotificationCenter();
        }
        return NotificationCenter.instance;
    }

    generate(): string {
        return `// Notification Center
// Generated by Shadow AI

/**
 * NOTIFICATION CENTER
 * 
 * In-app notifications with bell, inbox, preferences.
 */

interface Notification {
    id: string;
    type: 'info' | 'success' | 'warning' | 'error';
    title: string;
    message: string;
    read: boolean;
    actionUrl?: string;
    createdAt: Date;
}

// === Notification Bell Component ===
export function NotificationBell() {
    const [notifications, setNotifications] = useState<Notification[]>([]);
    const [isOpen, setIsOpen] = useState(false);
    const unreadCount = notifications.filter(n => !n.read).length;
    
    useEffect(() => {
        // Subscribe to real-time notifications
        const socket = io();
        socket.on('notification', (notification) => {
            setNotifications(prev => [notification, ...prev]);
            showToast(notification);
        });
        
        return () => socket.disconnect();
    }, []);
    
    const markAsRead = async (id: string) => {
        await fetch(\\\`/api/notifications/\\\${id}/read\\\`, { method: 'POST' });
        setNotifications(prev => prev.map(n => n.id === id ? { ...n, read: true } : n));
    };
    
    const markAllAsRead = async () => {
        await fetch('/api/notifications/read-all', { method: 'POST' });
        setNotifications(prev => prev.map(n => ({ ...n, read: true })));
    };
    
    return (
        <Popover open={isOpen} onOpenChange={setIsOpen}>
            <PopoverTrigger>
                <button className="notification-bell">
                    <BellIcon />
                    {unreadCount > 0 && <span className="badge">{unreadCount}</span>}
                </button>
            </PopoverTrigger>
            <PopoverContent>
                <div className="notification-panel">
                    <div className="panel-header">
                        <h3>Notifications</h3>
                        {unreadCount > 0 && (
                            <button onClick={markAllAsRead}>Mark all read</button>
                        )}
                    </div>
                    <div className="notification-list">
                        {notifications.length === 0 ? (
                            <p className="empty">No notifications</p>
                        ) : (
                            notifications.map(n => (
                                <NotificationItem
                                    key={n.id}
                                    notification={n}
                                    onRead={() => markAsRead(n.id)}
                                />
                            ))
                        )}
                    </div>
                </div>
            </PopoverContent>
        </Popover>
    );
}

// === Toast Notifications ===
export function useToast() {
    const [toasts, setToasts] = useState([]);
    
    const showToast = (options: ToastOptions) => {
        const id = crypto.randomUUID();
        const toast = { id, ...options };
        setToasts(prev => [...prev, toast]);
        
        setTimeout(() => {
            setToasts(prev => prev.filter(t => t.id !== id));
        }, options.duration || 5000);
    };
    
    const success = (message: string) => showToast({ type: 'success', message });
    const error = (message: string) => showToast({ type: 'error', message });
    const info = (message: string) => showToast({ type: 'info', message });
    const warning = (message: string) => showToast({ type: 'warning', message });
    
    return { toasts, showToast, success, error, info, warning };
}

export function ToastContainer({ toasts }: { toasts: Toast[] }) {
    return (
        <div className="toast-container">
            {toasts.map(toast => (
                <div key={toast.id} className={\\\`toast toast--\\\${toast.type}\\\`}>
                    <div className="toast-icon">{getIcon(toast.type)}</div>
                    <div className="toast-content">
                        {toast.title && <strong>{toast.title}</strong>}
                        <p>{toast.message}</p>
                    </div>
                    <button className="toast-close" onClick={() => dismissToast(toast.id)}>Ã—</button>
                </div>
            ))}
        </div>
    );
}

// === Notification Preferences ===
export function NotificationPreferences() {
    const [preferences, setPreferences] = useState({
        email: { marketing: true, updates: true, security: true },
        push: { all: true },
        inApp: { all: true }
    });
    
    const updatePreference = async (channel: string, type: string, value: boolean) => {
        await fetch('/api/notifications/preferences', {
            method: 'PATCH',
            body: JSON.stringify({ channel, type, value })
        });
        setPreferences(prev => ({
            ...prev,
            [channel]: { ...prev[channel], [type]: value }
        }));
    };
    
    return (
        <div className="notification-preferences">
            <h3>Notification Preferences</h3>
            
            <section>
                <h4>Email</h4>
                <Toggle label="Marketing" checked={preferences.email.marketing} onChange={(v) => updatePreference('email', 'marketing', v)} />
                <Toggle label="Product Updates" checked={preferences.email.updates} onChange={(v) => updatePreference('email', 'updates', v)} />
                <Toggle label="Security Alerts" checked={preferences.email.security} onChange={(v) => updatePreference('email', 'security', v)} disabled />
            </section>
            
            <section>
                <h4>Push Notifications</h4>
                <Toggle label="All notifications" checked={preferences.push.all} onChange={(v) => updatePreference('push', 'all', v)} />
            </section>
        </div>
    );
}
`;
    }
}

export const notificationCenter = NotificationCenter.getInstance();
