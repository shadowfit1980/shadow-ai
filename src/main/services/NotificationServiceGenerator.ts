/**
 * ðŸ”” Notification Service Generator
 * 
 * Generate notification systems:
 * - Push, FCM, APNs, email
 */

import { EventEmitter } from 'events';

export class NotificationServiceGenerator extends EventEmitter {
    private static instance: NotificationServiceGenerator;

    private constructor() { super(); }

    static getInstance(): NotificationServiceGenerator {
        if (!NotificationServiceGenerator.instance) {
            NotificationServiceGenerator.instance = new NotificationServiceGenerator();
        }
        return NotificationServiceGenerator.instance;
    }

    generate(): string {
        return `// Notification Service
// Generated by Shadow AI

import admin from 'firebase-admin';
import { ApnsClient } from 'apns2';
import nodemailer from 'nodemailer';

// Initialize Firebase Admin
admin.initializeApp({
    credential: admin.credential.cert({
        projectId: process.env.FIREBASE_PROJECT_ID,
        privateKey: process.env.FIREBASE_PRIVATE_KEY?.replace(/\\\\n/g, '\\n'),
        clientEmail: process.env.FIREBASE_CLIENT_EMAIL
    })
});

// Initialize APNs
const apnsClient = new ApnsClient({
    team: process.env.APNS_TEAM_ID,
    keyId: process.env.APNS_KEY_ID,
    signingKey: process.env.APNS_SIGNING_KEY,
    defaultTopic: process.env.APNS_BUNDLE_ID,
    host: process.env.NODE_ENV === 'production' ? 'api.push.apple.com' : 'api.sandbox.push.apple.com'
});

// Initialize email transporter
const emailTransporter = nodemailer.createTransport({
    host: process.env.SMTP_HOST,
    port: parseInt(process.env.SMTP_PORT || '587'),
    secure: process.env.SMTP_SECURE === 'true',
    auth: {
        user: process.env.SMTP_USER,
        pass: process.env.SMTP_PASS
    }
});

interface NotificationPayload {
    title: string;
    body: string;
    data?: Record<string, string>;
    imageUrl?: string;
    badge?: number;
    sound?: string;
}

// Send FCM notification (Android/Web)
async function sendFCMNotification(token: string, payload: NotificationPayload) {
    const message = {
        token,
        notification: {
            title: payload.title,
            body: payload.body,
            imageUrl: payload.imageUrl
        },
        data: payload.data,
        android: {
            priority: 'high' as const,
            notification: {
                sound: payload.sound || 'default',
                clickAction: 'OPEN_APP'
            }
        },
        webpush: {
            notification: {
                icon: '/icon.png',
                badge: '/badge.png'
            }
        }
    };

    try {
        const response = await admin.messaging().send(message);
        return { success: true, messageId: response };
    } catch (error: any) {
        console.error('FCM Error:', error);
        return { success: false, error: error.message };
    }
}

// Send to multiple devices
async function sendFCMMulticast(tokens: string[], payload: NotificationPayload) {
    const message = {
        tokens,
        notification: {
            title: payload.title,
            body: payload.body
        },
        data: payload.data
    };

    const response = await admin.messaging().sendEachForMulticast(message);
    
    return {
        successCount: response.successCount,
        failureCount: response.failureCount,
        responses: response.responses
    };
}

// Send to topic
async function sendToTopic(topic: string, payload: NotificationPayload) {
    const message = {
        topic,
        notification: {
            title: payload.title,
            body: payload.body
        },
        data: payload.data
    };

    return admin.messaging().send(message);
}

// Subscribe to topic
async function subscribeToTopic(tokens: string[], topic: string) {
    return admin.messaging().subscribeToTopic(tokens, topic);
}

// Send APNs notification (iOS)
async function sendAPNsNotification(deviceToken: string, payload: NotificationPayload) {
    const notification = {
        deviceToken,
        body: {
            aps: {
                alert: {
                    title: payload.title,
                    body: payload.body
                },
                badge: payload.badge,
                sound: payload.sound || 'default'
            },
            ...payload.data
        }
    };

    try {
        await apnsClient.send(notification);
        return { success: true };
    } catch (error: any) {
        console.error('APNs Error:', error);
        return { success: false, error: error.message };
    }
}

// Send email notification
async function sendEmailNotification(to: string, subject: string, html: string, text?: string) {
    try {
        const info = await emailTransporter.sendMail({
            from: process.env.EMAIL_FROM,
            to,
            subject,
            text: text || html.replace(/<[^>]*>/g, ''),
            html
        });

        return { success: true, messageId: info.messageId };
    } catch (error: any) {
        console.error('Email Error:', error);
        return { success: false, error: error.message };
    }
}

// Unified notification service
class NotificationService {
    async send(userId: string, payload: NotificationPayload) {
        const user = await getUserWithDevices(userId);
        const results = [];

        // Send push to all devices
        for (const device of user.devices) {
            if (device.platform === 'android' || device.platform === 'web') {
                results.push(await sendFCMNotification(device.token, payload));
            } else if (device.platform === 'ios') {
                results.push(await sendAPNsNotification(device.token, payload));
            }
        }

        // Optionally send email
        if (user.emailNotifications) {
            results.push(await sendEmailNotification(
                user.email,
                payload.title,
                \`<h1>\${payload.title}</h1><p>\${payload.body}</p>\`
            ));
        }

        return results;
    }

    async broadcast(topic: string, payload: NotificationPayload) {
        return sendToTopic(topic, payload);
    }
}

async function getUserWithDevices(userId: string) {
    // Fetch user and devices from database
    return { id: userId, email: '', devices: [], emailNotifications: true };
}

export const notificationService = new NotificationService();
export { sendFCMNotification, sendFCMMulticast, sendToTopic, sendAPNsNotification, sendEmailNotification };
`;
    }
}

export const notificationServiceGenerator = NotificationServiceGenerator.getInstance();
