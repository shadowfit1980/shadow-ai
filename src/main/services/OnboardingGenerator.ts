/**
 * ðŸ“± OnboardingGenerator
 * 
 * User onboarding:
 * - Tours, tooltips, checklists
 */

import { EventEmitter } from 'events';

export class OnboardingGenerator extends EventEmitter {
    private static instance: OnboardingGenerator;
    private constructor() { super(); }
    static getInstance(): OnboardingGenerator {
        if (!OnboardingGenerator.instance) {
            OnboardingGenerator.instance = new OnboardingGenerator();
        }
        return OnboardingGenerator.instance;
    }

    generate(): string {
        return `// Onboarding Generator - Tours, tooltips, checklists
// Generated by Shadow AI

// Product Tour
interface TourStep {
    id: string;
    target: string; // CSS selector
    title: string;
    content: string;
    placement?: 'top' | 'bottom' | 'left' | 'right';
    action?: () => void;
}

class ProductTour {
    private steps: TourStep[];
    private currentIndex = 0;
    
    constructor(steps: TourStep[]) {
        this.steps = steps;
    }
    
    start() {
        this.currentIndex = 0;
        this.showStep(0);
    }
    
    next() {
        if (this.currentIndex < this.steps.length - 1) {
            this.currentIndex++;
            this.showStep(this.currentIndex);
        } else {
            this.complete();
        }
    }
    
    previous() {
        if (this.currentIndex > 0) {
            this.currentIndex--;
            this.showStep(this.currentIndex);
        }
    }
    
    complete() {
        localStorage.setItem('tour_completed', 'true');
        this.hide();
    }
}

// React Tour Component
export function TourProvider({ steps, children }: { steps: TourStep[]; children: React.ReactNode }) {
    const [isOpen, setIsOpen] = useState(false);
    const [currentStep, setCurrentStep] = useState(0);
    
    const step = steps[currentStep];
    
    useEffect(() => {
        const completed = localStorage.getItem('tour_completed');
        if (!completed) {
            setIsOpen(true);
        }
    }, []);
    
    if (!isOpen || !step) return <>{children}</>;
    
    return (
        <>
            {children}
            <TourOverlay />
            <TourHighlight target={step.target} />
            <TourTooltip
                step={step}
                currentStep={currentStep}
                totalSteps={steps.length}
                onNext={() => setCurrentStep(s => Math.min(s + 1, steps.length - 1))}
                onPrevious={() => setCurrentStep(s => Math.max(s - 1, 0))}
                onSkip={() => { setIsOpen(false); localStorage.setItem('tour_completed', 'true'); }}
            />
        </>
    );
}

// Onboarding Checklist
export function OnboardingChecklist({ tasks }: { tasks: Task[] }) {
    const [completed, setCompleted] = useState<Set<string>>(new Set());
    
    const progress = (completed.size / tasks.length) * 100;
    
    return (
        <div className="onboarding-checklist">
            <div className="progress-bar">
                <div style={{ width: \`\${progress}%\` }} />
                <span>{completed.size} of {tasks.length} complete</span>
            </div>
            <ul>
                {tasks.map(task => (
                    <li key={task.id} className={completed.has(task.id) ? 'completed' : ''}>
                        <CheckIcon checked={completed.has(task.id)} />
                        <span>{task.title}</span>
                        {!completed.has(task.id) && (
                            <button onClick={() => task.action()}>Start</button>
                        )}
                    </li>
                ))}
            </ul>
        </div>
    );
}

// Tooltip Component
export function Tooltip({ target, content, show }: { target: string; content: string; show: boolean }) {
    const [position, setPosition] = useState({ top: 0, left: 0 });
    
    useEffect(() => {
        if (show) {
            const el = document.querySelector(target);
            if (el) {
                const rect = el.getBoundingClientRect();
                setPosition({ top: rect.bottom + 10, left: rect.left });
            }
        }
    }, [show, target]);
    
    if (!show) return null;
    
    return (
        <div className="tooltip" style={{ top: position.top, left: position.left }}>
            {content}
        </div>
    );
}

export { ProductTour, TourProvider, OnboardingChecklist, Tooltip };
`;
    }
}

export const onboardingGenerator = OnboardingGenerator.getInstance();
