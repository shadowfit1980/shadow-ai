/**
 * ðŸ“„ PDF Generator
 * 
 * Generate PDFs:
 * - Puppeteer, jsPDF
 */

import { EventEmitter } from 'events';

export class PDFGenerator extends EventEmitter {
    private static instance: PDFGenerator;

    private constructor() { super(); }

    static getInstance(): PDFGenerator {
        if (!PDFGenerator.instance) {
            PDFGenerator.instance = new PDFGenerator();
        }
        return PDFGenerator.instance;
    }

    generatePuppeteerPDF(): string {
        return `// PDF Generation with Puppeteer
// Generated by Shadow AI

import puppeteer from 'puppeteer';
import handlebars from 'handlebars';
import fs from 'fs/promises';

interface PDFOptions {
    format?: 'A4' | 'Letter' | 'Legal';
    landscape?: boolean;
    margin?: { top?: string; right?: string; bottom?: string; left?: string };
    headerTemplate?: string;
    footerTemplate?: string;
    displayHeaderFooter?: boolean;
}

// Generate PDF from HTML
async function generatePDFFromHTML(html: string, options: PDFOptions = {}): Promise<Buffer> {
    const browser = await puppeteer.launch({ headless: 'new' });
    const page = await browser.newPage();
    
    await page.setContent(html, { waitUntil: 'networkidle0' });
    
    const pdfBuffer = await page.pdf({
        format: options.format || 'A4',
        landscape: options.landscape || false,
        margin: options.margin || { top: '1cm', right: '1cm', bottom: '1cm', left: '1cm' },
        displayHeaderFooter: options.displayHeaderFooter || false,
        headerTemplate: options.headerTemplate || '',
        footerTemplate: options.footerTemplate || '<div style="font-size:10px;width:100%;text-align:center;"><span class="pageNumber"></span> / <span class="totalPages"></span></div>',
        printBackground: true
    });
    
    await browser.close();
    return pdfBuffer;
}

// Generate PDF from URL
async function generatePDFFromURL(url: string, options: PDFOptions = {}): Promise<Buffer> {
    const browser = await puppeteer.launch({ headless: 'new' });
    const page = await browser.newPage();
    
    await page.goto(url, { waitUntil: 'networkidle0' });
    
    const pdfBuffer = await page.pdf({
        format: options.format || 'A4',
        printBackground: true,
        margin: options.margin || { top: '1cm', right: '1cm', bottom: '1cm', left: '1cm' }
    });
    
    await browser.close();
    return pdfBuffer;
}

// Generate PDF from template
async function generatePDFFromTemplate(templatePath: string, data: object, options: PDFOptions = {}): Promise<Buffer> {
    const templateContent = await fs.readFile(templatePath, 'utf-8');
    const template = handlebars.compile(templateContent);
    const html = template(data);
    
    return generatePDFFromHTML(html, options);
}

// Invoice template
const invoiceTemplate = \`
<!DOCTYPE html>
<html>
<head>
    <style>
        body { font-family: Arial, sans-serif; padding: 40px; }
        .header { display: flex; justify-content: space-between; margin-bottom: 40px; }
        .logo { font-size: 24px; font-weight: bold; color: #667eea; }
        .invoice-info { text-align: right; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: #f5f5f5; }
        .total { font-size: 18px; font-weight: bold; text-align: right; margin-top: 20px; }
        .footer { margin-top: 40px; text-align: center; color: #666; }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">{{company}}</div>
        <div class="invoice-info">
            <h2>INVOICE</h2>
            <p>Invoice #: {{invoiceNumber}}</p>
            <p>Date: {{date}}</p>
        </div>
    </div>
    
    <div class="bill-to">
        <h3>Bill To:</h3>
        <p>{{customer.name}}</p>
        <p>{{customer.email}}</p>
        <p>{{customer.address}}</p>
    </div>
    
    <table>
        <thead>
            <tr>
                <th>Description</th>
                <th>Quantity</th>
                <th>Price</th>
                <th>Total</th>
            </tr>
        </thead>
        <tbody>
            {{#each items}}
            <tr>
                <td>{{description}}</td>
                <td>{{quantity}}</td>
                <td>\${{price}}</td>
                <td>\${{total}}</td>
            </tr>
            {{/each}}
        </tbody>
    </table>
    
    <div class="total">
        <p>Subtotal: \${{subtotal}}</p>
        <p>Tax ({{taxRate}}%): \${{tax}}</p>
        <p>Total: \${{total}}</p>
    </div>
    
    <div class="footer">
        <p>Thank you for your business!</p>
    </div>
</body>
</html>
\`;

// Generate invoice PDF
async function generateInvoice(invoiceData: any): Promise<Buffer> {
    const template = handlebars.compile(invoiceTemplate);
    const html = template(invoiceData);
    return generatePDFFromHTML(html);
}

export { generatePDFFromHTML, generatePDFFromURL, generatePDFFromTemplate, generateInvoice };
`;
    }
}

export const pdfGenerator = PDFGenerator.getInstance();
