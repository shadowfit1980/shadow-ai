/**
 * ðŸ“¦ Package Publishing Generator
 * 
 * Generate package publishing:
 * - npm, PyPI
 */

import { EventEmitter } from 'events';

export class PackagePublishing extends EventEmitter {
    private static instance: PackagePublishing;

    private constructor() { super(); }

    static getInstance(): PackagePublishing {
        if (!PackagePublishing.instance) {
            PackagePublishing.instance = new PackagePublishing();
        }
        return PackagePublishing.instance;
    }

    generateNpm(): string {
        return `// npm Package Publishing
// Generated by Shadow AI

// === package.json ===
{
    "name": "@myorg/mypackage",
    "version": "1.0.0",
    "description": "My awesome package",
    "main": "dist/index.js",
    "module": "dist/index.mjs",
    "types": "dist/index.d.ts",
    "exports": {
        ".": {
            "types": "./dist/index.d.ts",
            "import": "./dist/index.mjs",
            "require": "./dist/index.js"
        },
        "./utils": {
            "types": "./dist/utils.d.ts",
            "import": "./dist/utils.mjs",
            "require": "./dist/utils.js"
        }
    },
    "files": ["dist", "README.md", "LICENSE"],
    "scripts": {
        "build": "tsup src/index.ts --format cjs,esm --dts",
        "test": "vitest",
        "lint": "eslint src --ext .ts",
        "prepublishOnly": "npm run build && npm test",
        "release": "npm run build && changeset publish"
    },
    "keywords": ["typescript", "utility"],
    "author": "Your Name <you@example.com>",
    "license": "MIT",
    "repository": {
        "type": "git",
        "url": "https://github.com/myorg/mypackage.git"
    },
    "bugs": {
        "url": "https://github.com/myorg/mypackage/issues"
    },
    "homepage": "https://github.com/myorg/mypackage#readme",
    "engines": {
        "node": ">=18"
    },
    "publishConfig": {
        "access": "public"
    },
    "devDependencies": {
        "@changesets/cli": "^2.27.0",
        "tsup": "^8.0.0",
        "typescript": "^5.0.0",
        "vitest": "^1.0.0"
    },
    "peerDependencies": {
        "react": ">=17.0.0"
    },
    "peerDependenciesMeta": {
        "react": {
            "optional": true
        }
    }
}

// === tsup.config.ts ===
import { defineConfig } from 'tsup';

export default defineConfig({
    entry: ['src/index.ts', 'src/utils.ts'],
    format: ['cjs', 'esm'],
    dts: true,
    splitting: false,
    sourcemap: true,
    clean: true,
    treeshake: true,
    minify: true,
    external: ['react', 'react-dom'],
    esbuildOptions(options) {
        options.banner = {
            js: '"use client";' // For React Server Components
        };
    }
});

// === .changeset/config.json ===
{
    "$schema": "https://unpkg.com/@changesets/config/schema.json",
    "changelog": "@changesets/cli/changelog",
    "commit": false,
    "fixed": [],
    "linked": [],
    "access": "public",
    "baseBranch": "main",
    "updateInternalDependencies": "patch"
}

// === GitHub Actions (.github/workflows/publish.yml) ===
name: Publish
on:
  push:
    branches: [main]

concurrency: \${{ github.workflow }}-\${{ github.ref }}

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: https://registry.npmjs.org

      - run: npm ci
      - run: npm test
      - run: npm run build

      - name: Create Release PR or Publish
        uses: changesets/action@v1
        with:
          publish: npm run release
        env:
          GITHUB_TOKEN: \${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: \${{ secrets.NPM_TOKEN }}

// === .npmrc ===
//registry.npmjs.org/:_authToken=\${NPM_TOKEN}
@myorg:registry=https://registry.npmjs.org/

// === Commands ===
# Create changeset
npx changeset

# Version packages
npx changeset version

# Publish
npx changeset publish

# Or manually
npm publish --access public
`;
    }

    generatePyPI(): string {
        return `# PyPI Package Publishing
# Generated by Shadow AI

# === pyproject.toml ===
[build-system]
requires = ["hatchling"]
build-backend = "hatchling.build"

[project]
name = "mypackage"
version = "1.0.0"
description = "My awesome Python package"
readme = "README.md"
license = "MIT"
requires-python = ">=3.8"
authors = [{ name = "Your Name", email = "you@example.com" }]
keywords = ["utility", "tools"]
classifiers = [
    "Development Status :: 4 - Beta",
    "Intended Audience :: Developers",
    "License :: OSI Approved :: MIT License",
    "Programming Language :: Python :: 3",
    "Programming Language :: Python :: 3.8",
    "Programming Language :: Python :: 3.9",
    "Programming Language :: Python :: 3.10",
    "Programming Language :: Python :: 3.11",
    "Programming Language :: Python :: 3.12",
]
dependencies = [
    "requests>=2.28.0",
    "pydantic>=2.0.0",
]

[project.optional-dependencies]
dev = [
    "pytest>=7.0.0",
    "pytest-cov>=4.0.0",
    "ruff>=0.1.0",
    "mypy>=1.0.0",
]

[project.urls]
Homepage = "https://github.com/myorg/mypackage"
Documentation = "https://mypackage.readthedocs.io"
Repository = "https://github.com/myorg/mypackage.git"
Issues = "https://github.com/myorg/mypackage/issues"

[project.scripts]
mypackage = "mypackage.cli:main"

[tool.hatch.build.targets.wheel]
packages = ["src/mypackage"]

[tool.hatch.build.targets.sdist]
include = ["src/mypackage", "tests", "README.md", "LICENSE"]

[tool.ruff]
line-length = 100
select = ["E", "F", "I", "N", "W"]

[tool.pytest.ini_options]
testpaths = ["tests"]
addopts = "--cov=mypackage --cov-report=term-missing"

[tool.mypy]
python_version = "3.8"
strict = true

# === Project Structure ===
# src/mypackage/__init__.py
from .core import MyClass, my_function

__version__ = "1.0.0"
__all__ = ["MyClass", "my_function"]

# === GitHub Actions (.github/workflows/publish.yml) ===
name: Publish to PyPI
on:
  release:
    types: [published]

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install build twine

      - name: Build
        run: python -m build

      - name: Publish to PyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: \${{ secrets.PYPI_TOKEN }}
        run: twine upload dist/*

# === Commands ===
# Build
python -m build

# Check package
twine check dist/*

# Upload to TestPyPI
twine upload --repository testpypi dist/*

# Upload to PyPI
twine upload dist/*
`;
    }
}

export const packagePublishing = PackagePublishing.getInstance();
