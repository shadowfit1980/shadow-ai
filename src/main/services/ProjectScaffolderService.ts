/**
 * ðŸš€ ProjectScaffolderService
 * 
 * Project scaffolding:
 * - Templates, generators, CLI
 */

import { EventEmitter } from 'events';

export class ProjectScaffolderService extends EventEmitter {
    private static instance: ProjectScaffolderService;
    private constructor() { super(); }
    static getInstance(): ProjectScaffolderService {
        if (!ProjectScaffolderService.instance) {
            ProjectScaffolderService.instance = new ProjectScaffolderService();
        }
        return ProjectScaffolderService.instance;
    }

    generate(): string {
        return `// Project Scaffolder Service - Templates, generators
// Generated by Shadow AI

class ProjectScaffolder {
    private templates: Map<string, ProjectTemplate> = new Map([
        ['react-app', {
            name: 'React App',
            description: 'React with TypeScript, Vite, Tailwind',
            command: 'npm create vite@latest {{name}} -- --template react-ts',
            postSetup: ['cd {{name}}', 'npm install', 'npm install -D tailwindcss postcss autoprefixer', 'npx tailwindcss init -p']
        }],
        ['next-app', {
            name: 'Next.js App',
            description: 'Next.js with TypeScript, Tailwind',
            command: 'npx create-next-app@latest {{name}} --typescript --tailwind --eslint --app --src-dir',
            postSetup: []
        }],
        ['express-api', {
            name: 'Express API',
            description: 'Express with TypeScript, Prisma',
            files: {
                'package.json': \`{
    "name": "{{name}}",
    "type": "module",
    "scripts": {
        "dev": "tsx watch src/index.ts",
        "build": "tsc",
        "start": "node dist/index.js"
    }
}\`,
                'src/index.ts': \`import express from 'express';
const app = express();
app.use(express.json());
app.get('/health', (req, res) => res.json({ status: 'ok' }));
app.listen(3000, () => console.log('Server running on port 3000'));\`
            }
        }]
    ]);
    
    // Create project from template
    async create(templateName: string, projectName: string, options: Record<string, any> = {}): Promise<void> {
        const template = this.templates.get(templateName);
        if (!template) throw new Error(\`Template not found: \${templateName}\`);
        
        if (template.command) {
            const command = template.command.replace(/\\{\\{name\\}\\}/g, projectName);
            await execAsync(command);
        }
        
        if (template.files) {
            for (const [filePath, content] of Object.entries(template.files)) {
                const fullPath = path.join(projectName, filePath);
                const renderedContent = content.replace(/\\{\\{name\\}\\}/g, projectName);
                
                await fs.mkdir(path.dirname(fullPath), { recursive: true });
                await fs.writeFile(fullPath, renderedContent);
            }
        }
        
        for (const cmd of template.postSetup || []) {
            const rendered = cmd.replace(/\\{\\{name\\}\\}/g, projectName);
            await execAsync(rendered);
        }
    }
    
    // Generate component
    async generateComponent(name: string, type: 'react' | 'vue' | 'svelte'): Promise<string> {
        const templates = {
            react: \`import React from 'react';

interface \${name}Props {
    // Add props here
}

export function \${name}({ }: \${name}Props) {
    return (
        <div className="\${name.toLowerCase()}">
            <h1>\${name}</h1>
        </div>
    );
}\`,
            vue: \`<template>
    <div class="\${name.toLowerCase()}">
        <h1>\${name}</h1>
    </div>
</template>

<script setup lang="ts">
// Add props and logic here
</script>\`,
            svelte: \`<script lang="ts">
    // Add props and logic here
</script>

<div class="\${name.toLowerCase()}">
    <h1>\${name}</h1>
</div>\`
        };
        
        return templates[type];
    }
    
    // Generate API route
    async generateAPIRoute(name: string, methods: string[]): Promise<string> {
        const handlers = methods.map(m => \`
export async function \${m.toUpperCase()}(req: Request) {
    // Handle \${m.toUpperCase()} request
    return Response.json({ message: '\${name} \${m}' });
}\`).join('\\n');
        
        return handlers;
    }
    
    // Generate model
    async generateModel(name: string, fields: { name: string; type: string }[]): Promise<string> {
        const prismaModel = \`model \${name} {
    id        String   @id @default(cuid())
    \${fields.map(f => \`\${f.name}    \${f.type}\`).join('\\n    ')}
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
}\`;
        
        return prismaModel;
    }
    
    // List available templates
    list(): ProjectTemplate[] {
        return Array.from(this.templates.values());
    }
}

export { ProjectScaffolder };
`;
    }
}

export const projectScaffolderService = ProjectScaffolderService.getInstance();
