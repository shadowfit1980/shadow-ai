/**
 * ðŸ“± React Native Generator
 * 
 * Generate React Native code:
 * - Navigation, screens, native modules
 */

import { EventEmitter } from 'events';

export class ReactNativeGenerator extends EventEmitter {
    private static instance: ReactNativeGenerator;

    private constructor() { super(); }

    static getInstance(): ReactNativeGenerator {
        if (!ReactNativeGenerator.instance) {
            ReactNativeGenerator.instance = new ReactNativeGenerator();
        }
        return ReactNativeGenerator.instance;
    }

    generateAppStructure(): string {
        return `// React Native App Structure
// Generated by Shadow AI

// App.tsx
import React from 'react';
import { NavigationContainer } from '@react-navigation/native';
import { createNativeStackNavigator } from '@react-navigation/native-stack';
import { createBottomTabNavigator } from '@react-navigation/bottom-tabs';
import { QueryClient, QueryClientProvider } from '@tanstack/react-query';
import { SafeAreaProvider } from 'react-native-safe-area-context';

import { AuthProvider, useAuth } from './contexts/AuthContext';
import { ThemeProvider } from './contexts/ThemeContext';

// Screens
import { HomeScreen } from './screens/HomeScreen';
import { ProfileScreen } from './screens/ProfileScreen';
import { LoginScreen } from './screens/LoginScreen';
import { SettingsScreen } from './screens/SettingsScreen';

const Stack = createNativeStackNavigator();
const Tab = createBottomTabNavigator();
const queryClient = new QueryClient();

function MainTabs() {
    return (
        <Tab.Navigator screenOptions={{ headerShown: false }}>
            <Tab.Screen name="Home" component={HomeScreen} />
            <Tab.Screen name="Profile" component={ProfileScreen} />
            <Tab.Screen name="Settings" component={SettingsScreen} />
        </Tab.Navigator>
    );
}

function RootNavigator() {
    const { isAuthenticated, isLoading } = useAuth();
    
    if (isLoading) {
        return <SplashScreen />;
    }
    
    return (
        <Stack.Navigator screenOptions={{ headerShown: false }}>
            {isAuthenticated ? (
                <Stack.Screen name="Main" component={MainTabs} />
            ) : (
                <Stack.Screen name="Login" component={LoginScreen} />
            )}
        </Stack.Navigator>
    );
}

export default function App() {
    return (
        <SafeAreaProvider>
            <QueryClientProvider client={queryClient}>
                <ThemeProvider>
                    <AuthProvider>
                        <NavigationContainer>
                            <RootNavigator />
                        </NavigationContainer>
                    </AuthProvider>
                </ThemeProvider>
            </QueryClientProvider>
        </SafeAreaProvider>
    );
}
`;
    }

    generateScreen(name: string): string {
        return `// ${name}Screen.tsx
import React from 'react';
import { View, Text, StyleSheet, ScrollView, RefreshControl } from 'react-native';
import { SafeAreaView } from 'react-native-safe-area-context';
import { useQuery } from '@tanstack/react-query';

import { Header } from '../components/Header';
import { LoadingSpinner } from '../components/LoadingSpinner';
import { ErrorMessage } from '../components/ErrorMessage';
import { api } from '../services/api';

export function ${name}Screen({ navigation }) {
    const { data, isLoading, error, refetch, isRefetching } = useQuery({
        queryKey: ['${name.toLowerCase()}'],
        queryFn: () => api.get${name}()
    });

    if (isLoading) return <LoadingSpinner />;
    if (error) return <ErrorMessage message={error.message} onRetry={refetch} />;

    return (
        <SafeAreaView style={styles.container}>
            <Header title="${name}" />
            
            <ScrollView 
                style={styles.content}
                refreshControl={
                    <RefreshControl refreshing={isRefetching} onRefresh={refetch} />
                }
            >
                {data?.map((item) => (
                    <View key={item.id} style={styles.item}>
                        <Text style={styles.title}>{item.title}</Text>
                    </View>
                ))}
            </ScrollView>
        </SafeAreaView>
    );
}

const styles = StyleSheet.create({
    container: {
        flex: 1,
        backgroundColor: '#fff',
    },
    content: {
        flex: 1,
        padding: 16,
    },
    item: {
        padding: 16,
        marginBottom: 12,
        backgroundColor: '#f5f5f5',
        borderRadius: 8,
    },
    title: {
        fontSize: 16,
        fontWeight: '600',
    },
});
`;
    }

    generateHooks(): string {
        return `// React Native Hooks
// Generated by Shadow AI

import { useState, useEffect, useCallback } from 'react';
import { AppState, Keyboard, Dimensions, Platform } from 'react-native';
import AsyncStorage from '@react-native-async-storage/async-storage';
import NetInfo from '@react-native-community/netinfo';

// App State Hook
export function useAppState() {
    const [appState, setAppState] = useState(AppState.currentState);
    
    useEffect(() => {
        const sub = AppState.addEventListener('change', setAppState);
        return () => sub.remove();
    }, []);
    
    return {
        appState,
        isActive: appState === 'active',
        isBackground: appState === 'background',
    };
}

// Network Hook
export function useNetwork() {
    const [isConnected, setIsConnected] = useState(true);
    const [connectionType, setConnectionType] = useState<string | null>(null);
    
    useEffect(() => {
        return NetInfo.addEventListener(state => {
            setIsConnected(state.isConnected ?? false);
            setConnectionType(state.type);
        });
    }, []);
    
    return { isConnected, connectionType };
}

// Keyboard Hook
export function useKeyboard() {
    const [isVisible, setIsVisible] = useState(false);
    const [height, setHeight] = useState(0);
    
    useEffect(() => {
        const showEvent = Platform.OS === 'ios' ? 'keyboardWillShow' : 'keyboardDidShow';
        const hideEvent = Platform.OS === 'ios' ? 'keyboardWillHide' : 'keyboardDidHide';
        
        const showSub = Keyboard.addListener(showEvent, (e) => {
            setIsVisible(true);
            setHeight(e.endCoordinates.height);
        });
        
        const hideSub = Keyboard.addListener(hideEvent, () => {
            setIsVisible(false);
            setHeight(0);
        });
        
        return () => {
            showSub.remove();
            hideSub.remove();
        };
    }, []);
    
    return { isVisible, height, dismiss: Keyboard.dismiss };
}

// Dimensions Hook
export function useDimensions() {
    const [dimensions, setDimensions] = useState(Dimensions.get('window'));
    
    useEffect(() => {
        const sub = Dimensions.addEventListener('change', ({ window }) => {
            setDimensions(window);
        });
        return () => sub.remove();
    }, []);
    
    return {
        width: dimensions.width,
        height: dimensions.height,
        isPortrait: dimensions.height > dimensions.width,
    };
}

// Storage Hook
export function useAsyncStorage<T>(key: string, initialValue: T) {
    const [value, setValue] = useState<T>(initialValue);
    const [loading, setLoading] = useState(true);
    
    useEffect(() => {
        AsyncStorage.getItem(key)
            .then(stored => {
                if (stored) setValue(JSON.parse(stored));
            })
            .finally(() => setLoading(false));
    }, [key]);
    
    const set = useCallback(async (newValue: T) => {
        setValue(newValue);
        await AsyncStorage.setItem(key, JSON.stringify(newValue));
    }, [key]);
    
    const remove = useCallback(async () => {
        setValue(initialValue);
        await AsyncStorage.removeItem(key);
    }, [key, initialValue]);
    
    return { value, set, remove, loading };
}
`;
    }

    generateComponents(): string {
        return `// React Native Components
// Generated by Shadow AI

import React from 'react';
import { View, Text, TouchableOpacity, StyleSheet, ActivityIndicator } from 'react-native';

// Button Component
export function Button({ title, onPress, variant = 'primary', loading, disabled }) {
    return (
        <TouchableOpacity
            style={[styles.button, styles[variant], disabled && styles.disabled]}
            onPress={onPress}
            disabled={loading || disabled}
        >
            {loading ? (
                <ActivityIndicator color="#fff" />
            ) : (
                <Text style={[styles.buttonText, styles[\`\${variant}Text\`]]}>{title}</Text>
            )}
        </TouchableOpacity>
    );
}

// Card Component
export function Card({ title, children, onPress }) {
    const Wrapper = onPress ? TouchableOpacity : View;
    
    return (
        <Wrapper style={styles.card} onPress={onPress}>
            {title && <Text style={styles.cardTitle}>{title}</Text>}
            {children}
        </Wrapper>
    );
}

// Input Component
export function Input({ label, error, ...props }) {
    return (
        <View style={styles.inputContainer}>
            {label && <Text style={styles.label}>{label}</Text>}
            <TextInput
                style={[styles.input, error && styles.inputError]}
                placeholderTextColor="#999"
                {...props}
            />
            {error && <Text style={styles.errorText}>{error}</Text>}
        </View>
    );
}

const styles = StyleSheet.create({
    button: {
        padding: 16,
        borderRadius: 8,
        alignItems: 'center',
    },
    primary: {
        backgroundColor: '#007AFF',
    },
    secondary: {
        backgroundColor: '#f5f5f5',
    },
    disabled: {
        opacity: 0.5,
    },
    buttonText: {
        fontSize: 16,
        fontWeight: '600',
    },
    primaryText: {
        color: '#fff',
    },
    secondaryText: {
        color: '#333',
    },
    card: {
        padding: 16,
        backgroundColor: '#fff',
        borderRadius: 12,
        shadowColor: '#000',
        shadowOffset: { width: 0, height: 2 },
        shadowOpacity: 0.1,
        shadowRadius: 8,
        elevation: 3,
    },
    cardTitle: {
        fontSize: 18,
        fontWeight: '600',
        marginBottom: 8,
    },
    inputContainer: {
        marginBottom: 16,
    },
    label: {
        fontSize: 14,
        fontWeight: '500',
        marginBottom: 8,
    },
    input: {
        borderWidth: 1,
        borderColor: '#ddd',
        borderRadius: 8,
        padding: 12,
        fontSize: 16,
    },
    inputError: {
        borderColor: '#ff3b30',
    },
    errorText: {
        color: '#ff3b30',
        fontSize: 12,
        marginTop: 4,
    },
});
`;
    }
}

export const reactNativeGenerator = ReactNativeGenerator.getInstance();
