/**
 * ðŸª£ S3StorageGenerator
 * 
 * S3-compatible storage:
 * - Upload, download, presigned URLs
 */

import { EventEmitter } from 'events';

export class S3StorageGenerator extends EventEmitter {
    private static instance: S3StorageGenerator;
    private constructor() { super(); }
    static getInstance(): S3StorageGenerator {
        if (!S3StorageGenerator.instance) {
            S3StorageGenerator.instance = new S3StorageGenerator();
        }
        return S3StorageGenerator.instance;
    }

    generate(): string {
        return `// S3 Storage Generator - Upload, download, presigned URLs
// Generated by Shadow AI

import { S3Client, PutObjectCommand, GetObjectCommand, DeleteObjectCommand, ListObjectsV2Command } from '@aws-sdk/client-s3';
import { getSignedUrl } from '@aws-sdk/s3-request-presigner';

class S3StorageService {
    private client: S3Client;
    private bucket: string;
    
    constructor() {
        this.client = new S3Client({
            region: process.env.AWS_REGION,
            credentials: {
                accessKeyId: process.env.AWS_ACCESS_KEY_ID!,
                secretAccessKey: process.env.AWS_SECRET_ACCESS_KEY!
            }
        });
        this.bucket = process.env.S3_BUCKET!;
    }
    
    async upload(key: string, body: Buffer, contentType: string) {
        await this.client.send(new PutObjectCommand({
            Bucket: this.bucket,
            Key: key,
            Body: body,
            ContentType: contentType
        }));
        
        return { key, url: this.getPublicUrl(key) };
    }
    
    async getPresignedUploadUrl(key: string, contentType: string, expiresIn = 3600) {
        const command = new PutObjectCommand({
            Bucket: this.bucket,
            Key: key,
            ContentType: contentType
        });
        
        return getSignedUrl(this.client, command, { expiresIn });
    }
    
    async getPresignedDownloadUrl(key: string, expiresIn = 3600) {
        const command = new GetObjectCommand({
            Bucket: this.bucket,
            Key: key
        });
        
        return getSignedUrl(this.client, command, { expiresIn });
    }
    
    async delete(key: string) {
        await this.client.send(new DeleteObjectCommand({
            Bucket: this.bucket,
            Key: key
        }));
    }
    
    async list(prefix?: string) {
        const response = await this.client.send(new ListObjectsV2Command({
            Bucket: this.bucket,
            Prefix: prefix
        }));
        
        return response.Contents?.map(obj => ({
            key: obj.Key,
            size: obj.Size,
            lastModified: obj.LastModified
        })) || [];
    }
    
    private getPublicUrl(key: string) {
        return \`https://\${this.bucket}.s3.\${process.env.AWS_REGION}.amazonaws.com/\${key}\`;
    }
}

// React Upload Hook
export function useFileUpload() {
    const [uploading, setUploading] = useState(false);
    const [progress, setProgress] = useState(0);
    
    const upload = async (file: File) => {
        setUploading(true);
        setProgress(0);
        
        const { url } = await getPresignedUploadUrl(file.name, file.type);
        
        await fetch(url, {
            method: 'PUT',
            body: file,
            headers: { 'Content-Type': file.type }
        });
        
        setProgress(100);
        setUploading(false);
        
        return { key: file.name };
    };
    
    return { upload, uploading, progress };
}

export { S3StorageService, useFileUpload };
`;
    }
}

export const s3StorageGenerator = S3StorageGenerator.getInstance();
