/**
 * üåê Static Site Generator
 * 
 * Generate static sites:
 * - Astro, 11ty
 */

import { EventEmitter } from 'events';

export type SSGFramework = 'astro' | 'eleventy';

export class SSGGenerator extends EventEmitter {
    private static instance: SSGGenerator;

    private constructor() { super(); }

    static getInstance(): SSGGenerator {
        if (!SSGGenerator.instance) {
            SSGGenerator.instance = new SSGGenerator();
        }
        return SSGGenerator.instance;
    }

    getFrameworks(): SSGFramework[] {
        return ['astro', 'eleventy'];
    }

    generate(framework: SSGFramework): string {
        switch (framework) {
            case 'astro': return this.generateAstro();
            case 'eleventy': return this.generateEleventy();
            default: return '';
        }
    }

    private generateAstro(): string {
        return `// Astro Static Site
// Generated by Shadow AI

// astro.config.mjs
import { defineConfig } from 'astro/config';
import react from '@astrojs/react';
import tailwind from '@astrojs/tailwind';
import mdx from '@astrojs/mdx';
import sitemap from '@astrojs/sitemap';

export default defineConfig({
    site: 'https://example.com',
    integrations: [react(), tailwind(), mdx(), sitemap()],
    output: 'static',
    build: {
        inlineStylesheets: 'auto'
    },
    markdown: {
        shikiConfig: { theme: 'github-dark' }
    }
});

// src/layouts/BaseLayout.astro
---
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import '../styles/global.css';

interface Props {
    title: string;
    description?: string;
}

const { title, description = 'My Astro Site' } = Astro.props;
---

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content={description}>
    <title>{title}</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
</head>
<body>
    <Header />
    <main>
        <slot />
    </main>
    <Footer />
</body>
</html>

// src/pages/index.astro
---
import BaseLayout from '../layouts/BaseLayout.astro';
import Hero from '../components/Hero.astro';
import { getCollection } from 'astro:content';

const posts = await getCollection('blog');
const recentPosts = posts.sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf()).slice(0, 3);
---

<BaseLayout title="Home">
    <Hero />
    
    <section class="posts">
        <h2>Recent Posts</h2>
        <ul>
            {recentPosts.map(post => (
                <li>
                    <a href={\`/blog/\${post.slug}\`}>
                        <h3>{post.data.title}</h3>
                        <time>{post.data.date.toLocaleDateString()}</time>
                    </a>
                </li>
            ))}
        </ul>
    </section>
</BaseLayout>

// src/pages/blog/[...slug].astro
---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';

export async function getStaticPaths() {
    const posts = await getCollection('blog');
    return posts.map(post => ({
        params: { slug: post.slug },
        props: { post }
    }));
}

const { post } = Astro.props;
const { Content } = await post.render();
---

<BaseLayout title={post.data.title}>
    <article>
        <h1>{post.data.title}</h1>
        <time>{post.data.date.toLocaleDateString()}</time>
        <Content />
    </article>
</BaseLayout>

// src/content/config.ts
import { defineCollection, z } from 'astro:content';

const blog = defineCollection({
    type: 'content',
    schema: z.object({
        title: z.string(),
        description: z.string(),
        date: z.date(),
        author: z.string().optional(),
        tags: z.array(z.string()).default([])
    })
});

export const collections = { blog };

// src/components/Hero.astro
---
---

<section class="hero">
    <h1>Welcome to My Site</h1>
    <p>Built with Astro</p>
    <a href="/about" class="cta">Learn More</a>
</section>

<style>
    .hero {
        text-align: center;
        padding: 4rem 2rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    h1 { font-size: 3rem; margin-bottom: 1rem; }
    .cta {
        display: inline-block;
        padding: 0.75rem 1.5rem;
        background: white;
        color: #667eea;
        border-radius: 0.5rem;
        text-decoration: none;
    }
</style>
`;
    }

    private generateEleventy(): string {
        return `// Eleventy (11ty) Static Site
// Generated by Shadow AI

// .eleventy.js
module.exports = function(eleventyConfig) {
    // Copy static assets
    eleventyConfig.addPassthroughCopy("src/assets");
    eleventyConfig.addPassthroughCopy("src/css");
    
    // Watch for changes
    eleventyConfig.addWatchTarget("src/css/");
    
    // Collections
    eleventyConfig.addCollection("posts", function(collectionApi) {
        return collectionApi.getFilteredByGlob("src/posts/*.md").reverse();
    });
    
    eleventyConfig.addCollection("tagList", function(collectionApi) {
        const tagSet = new Set();
        collectionApi.getAll().forEach(item => {
            (item.data.tags || []).forEach(tag => tagSet.add(tag));
        });
        return [...tagSet].sort();
    });
    
    // Filters
    eleventyConfig.addFilter("dateFormat", (date, format) => {
        return new Date(date).toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
    });
    
    eleventyConfig.addFilter("limit", (arr, limit) => arr.slice(0, limit));
    
    eleventyConfig.addFilter("excerpt", (content, length = 150) => {
        const text = content.replace(/<[^>]*>/g, '');
        return text.length > length ? text.slice(0, length) + '...' : text;
    });
    
    // Shortcodes
    eleventyConfig.addShortcode("year", () => new Date().getFullYear().toString());
    
    eleventyConfig.addPairedShortcode("callout", function(content, type = "info") {
        return \`<div class="callout callout-\${type}">\${content}</div>\`;
    });
    
    // Markdown config
    const markdownIt = require("markdown-it");
    const md = markdownIt({ html: true, linkify: true });
    eleventyConfig.setLibrary("md", md);
    
    return {
        dir: {
            input: "src",
            output: "_site",
            includes: "_includes",
            layouts: "_layouts",
            data: "_data"
        },
        templateFormats: ["md", "njk", "html"],
        markdownTemplateEngine: "njk",
        htmlTemplateEngine: "njk"
    };
};

// src/_layouts/base.njk
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="{{ description or metadata.description }}">
    <title>{{ title }} | {{ metadata.title }}</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    {% include "header.njk" %}
    
    <main>
        {{ content | safe }}
    </main>
    
    {% include "footer.njk" %}
</body>
</html>

// src/_layouts/post.njk
---
layout: base.njk
---

<article class="post">
    <header>
        <h1>{{ title }}</h1>
        <time datetime="{{ date | dateFormat }}">{{ date | dateFormat }}</time>
        {% if tags %}
        <div class="tags">
            {% for tag in tags %}
            <a href="/tags/{{ tag | slugify }}/">#{{ tag }}</a>
            {% endfor %}
        </div>
        {% endif %}
    </header>
    
    {{ content | safe }}
</article>

// src/_data/metadata.js
module.exports = {
    title: "My 11ty Site",
    description: "A static site built with Eleventy",
    url: "https://example.com",
    author: {
        name: "Your Name",
        email: "you@example.com"
    }
};

// src/index.njk
---
layout: base.njk
title: Home
---

<section class="hero">
    <h1>Welcome to {{ metadata.title }}</h1>
    <p>{{ metadata.description }}</p>
</section>

<section class="posts">
    <h2>Recent Posts</h2>
    {% for post in collections.posts | limit(3) %}
    <article class="post-card">
        <h3><a href="{{ post.url }}">{{ post.data.title }}</a></h3>
        <time>{{ post.date | dateFormat }}</time>
        <p>{{ post.templateContent | excerpt }}</p>
    </article>
    {% endfor %}
</section>
`;
    }
}

export const ssgGenerator = SSGGenerator.getInstance();
