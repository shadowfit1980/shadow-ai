/**
 * ‚è∞ Scheduler Generator
 * 
 * Generate job scheduling:
 * - Cron, Agenda, node-cron
 */

import { EventEmitter } from 'events';

export class SchedulerGenerator extends EventEmitter {
    private static instance: SchedulerGenerator;

    private constructor() { super(); }

    static getInstance(): SchedulerGenerator {
        if (!SchedulerGenerator.instance) {
            SchedulerGenerator.instance = new SchedulerGenerator();
        }
        return SchedulerGenerator.instance;
    }

    generate(): string {
        return `// Job Scheduling
// Generated by Shadow AI

import cron from 'node-cron';
import { Agenda } from 'agenda';

// === Simple Cron Jobs ===
// Cron Expression: second minute hour day month weekday
// * * * * * * = every second
// */5 * * * * = every 5 minutes
// 0 0 * * * = every day at midnight
// 0 9 * * 1 = every Monday at 9am

const jobs = new Map<string, cron.ScheduledTask>();

function scheduleJob(name: string, expression: string, handler: () => void | Promise<void>) {
    if (!cron.validate(expression)) {
        throw new Error(\`Invalid cron expression: \${expression}\`);
    }

    const task = cron.schedule(expression, async () => {
        console.log(\`Running job: \${name}\`);
        try {
            await handler();
        } catch (error) {
            console.error(\`Job \${name} failed:\`, error);
        }
    });

    jobs.set(name, task);
    return task;
}

function stopJob(name: string) {
    const task = jobs.get(name);
    if (task) {
        task.stop();
        jobs.delete(name);
    }
}

// Common schedules
const schedules = {
    everyMinute: '* * * * *',
    every5Minutes: '*/5 * * * *',
    every15Minutes: '*/15 * * * *',
    everyHour: '0 * * * *',
    everyDay: '0 0 * * *',
    everyDayAt9am: '0 9 * * *',
    everyMonday: '0 0 * * 1',
    everyMonth: '0 0 1 * *',
    weekdays: '0 9 * * 1-5'
};

// Usage
scheduleJob('cleanup-sessions', schedules.everyHour, async () => {
    await db.session.deleteMany({ where: { expiresAt: { lt: new Date() } } });
});

scheduleJob('daily-report', schedules.everyDayAt9am, async () => {
    const stats = await generateDailyStats();
    await sendEmail({ to: 'admin@example.com', subject: 'Daily Report', html: stats });
});

scheduleJob('sync-data', schedules.every15Minutes, async () => {
    await syncExternalData();
});

// === Agenda (Persistent Jobs with MongoDB) ===
const agenda = new Agenda({
    db: { address: process.env.MONGODB_URI!, collection: 'agendaJobs' },
    processEvery: '30 seconds',
    maxConcurrency: 20
});

// Define jobs
agenda.define('send-email', async (job) => {
    const { to, subject, body } = job.attrs.data;
    await sendEmail({ to, subject, html: body });
});

agenda.define('process-payment', { priority: 'high', concurrency: 5 }, async (job) => {
    const { orderId } = job.attrs.data;
    await processPayment(orderId);
});

agenda.define('generate-report', { lockLifetime: 10 * 60 * 1000 }, async (job) => {
    const { type, userId } = job.attrs.data;
    const report = await generateReport(type);
    await saveReport(userId, report);
});

// Schedule recurring jobs
async function setupRecurringJobs() {
    await agenda.every('1 hour', 'cleanup-expired-tokens');
    await agenda.every('0 9 * * *', 'daily-digest'); // 9am daily
    await agenda.every('0 0 * * 0', 'weekly-report'); // Sunday midnight
}

// Schedule one-time jobs
async function scheduleEmail(to: string, subject: string, body: string, sendAt: Date) {
    await agenda.schedule(sendAt, 'send-email', { to, subject, body });
}

async function schedulePayment(orderId: string, processAt: Date) {
    await agenda.schedule(processAt, 'process-payment', { orderId });
}

// Immediately run job
async function runNow(orderId: string) {
    await agenda.now('process-payment', { orderId });
}

// Event handlers
agenda.on('ready', async () => {
    console.log('Agenda connected to MongoDB');
    await setupRecurringJobs();
    await agenda.start();
});

agenda.on('start', (job) => {
    console.log(\`Job \${job.attrs.name} starting\`);
});

agenda.on('complete', (job) => {
    console.log(\`Job \${job.attrs.name} completed\`);
});

agenda.on('fail', (err, job) => {
    console.error(\`Job \${job.attrs.name} failed:\`, err);
});

// Graceful shutdown
async function gracefulShutdown() {
    await agenda.stop();
    process.exit(0);
}

process.on('SIGTERM', gracefulShutdown);
process.on('SIGINT', gracefulShutdown);

// === Job Dashboard (API) ===
import express from 'express';
const router = express.Router();

router.get('/jobs', async (req, res) => {
    const jobs = await agenda.jobs({});
    res.json(jobs.map(j => ({
        name: j.attrs.name,
        data: j.attrs.data,
        nextRunAt: j.attrs.nextRunAt,
        lastRunAt: j.attrs.lastRunAt,
        failCount: j.attrs.failCount
    })));
});

router.post('/jobs/:name/run', async (req, res) => {
    await agenda.now(req.params.name, req.body);
    res.json({ message: 'Job scheduled' });
});

router.delete('/jobs/:id', async (req, res) => {
    await agenda.cancel({ _id: req.params.id });
    res.json({ message: 'Job cancelled' });
});

export { scheduleJob, stopJob, schedules, agenda, scheduleEmail, schedulePayment, runNow };
`;
    }
}

export const schedulerGenerator = SchedulerGenerator.getInstance();
