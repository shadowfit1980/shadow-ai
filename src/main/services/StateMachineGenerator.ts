/**
 * ðŸ—ƒï¸ StateMachineGenerator
 * 
 * State machines:
 * - XState, workflows, transitions
 */

import { EventEmitter } from 'events';

export class StateMachineGenerator extends EventEmitter {
    private static instance: StateMachineGenerator;
    private constructor() { super(); }
    static getInstance(): StateMachineGenerator {
        if (!StateMachineGenerator.instance) {
            StateMachineGenerator.instance = new StateMachineGenerator();
        }
        return StateMachineGenerator.instance;
    }

    generate(): string {
        return `// State Machine Generator - XState, workflows
// Generated by Shadow AI

import { createMachine, interpret, assign } from 'xstate';

// Order State Machine
const orderMachine = createMachine({
    id: 'order',
    initial: 'pending',
    context: { items: [], total: 0, paymentId: null },
    states: {
        pending: {
            on: {
                SUBMIT: { target: 'processing', actions: 'setPaymentId' }
            }
        },
        processing: {
            on: {
                PAYMENT_SUCCESS: 'paid',
                PAYMENT_FAILED: 'pending'
            }
        },
        paid: {
            on: {
                SHIP: 'shipped',
                CANCEL: 'cancelled'
            }
        },
        shipped: {
            on: {
                DELIVER: 'delivered',
                RETURN_REQUESTED: 'return_pending'
            }
        },
        delivered: {
            type: 'final'
        },
        return_pending: {
            on: {
                APPROVE_RETURN: 'returned',
                REJECT_RETURN: 'shipped'
            }
        },
        returned: {
            type: 'final'
        },
        cancelled: {
            type: 'final'
        }
    }
}, {
    actions: {
        setPaymentId: assign({ paymentId: (_, event) => event.paymentId })
    }
});

// Auth State Machine
const authMachine = createMachine({
    id: 'auth',
    initial: 'unauthenticated',
    context: { user: null, error: null },
    states: {
        unauthenticated: {
            on: { LOGIN: 'authenticating' }
        },
        authenticating: {
            invoke: {
                src: 'authenticate',
                onDone: { target: 'authenticated', actions: 'setUser' },
                onError: { target: 'unauthenticated', actions: 'setError' }
            }
        },
        authenticated: {
            on: { LOGOUT: 'unauthenticated' }
        }
    }
});

// React Hook for State Machines
import { useMachine } from '@xstate/react';

export function useOrderMachine() {
    const [state, send] = useMachine(orderMachine);
    
    return {
        state: state.value,
        context: state.context,
        submit: (paymentId: string) => send({ type: 'SUBMIT', paymentId }),
        ship: () => send('SHIP'),
        deliver: () => send('DELIVER'),
        cancel: () => send('CANCEL')
    };
}

// Workflow Engine
class WorkflowEngine {
    private machines: Map<string, any> = new Map();
    
    register(id: string, machine: any) {
        this.machines.set(id, machine);
    }
    
    start(id: string, initialContext?: any) {
        const machine = this.machines.get(id);
        if (!machine) throw new Error(\`Machine \${id} not found\`);
        
        return interpret(machine.withContext({ ...machine.context, ...initialContext })).start();
    }
}

export { orderMachine, authMachine, useOrderMachine, WorkflowEngine };
`;
    }
}

export const stateMachineGenerator = StateMachineGenerator.getInstance();
