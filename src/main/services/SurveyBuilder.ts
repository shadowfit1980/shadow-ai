/**
 * ðŸ“‹ SurveyBuilder
 * 
 * Survey/form builder:
 * - Questions, logic, responses
 */

import { EventEmitter } from 'events';

export class SurveyBuilder extends EventEmitter {
    private static instance: SurveyBuilder;

    private constructor() { super(); }

    static getInstance(): SurveyBuilder {
        if (!SurveyBuilder.instance) {
            SurveyBuilder.instance = new SurveyBuilder();
        }
        return SurveyBuilder.instance;
    }

    generate(): string {
        return `// Survey Builder
// Generated by Shadow AI

/**
 * SURVEY BUILDER
 * 
 * Build surveys with drag-drop, logic, analytics.
 */

interface Survey {
    id: string;
    title: string;
    description?: string;
    questions: Question[];
    settings: SurveySettings;
}

interface Question {
    id: string;
    type: QuestionType;
    title: string;
    description?: string;
    required: boolean;
    options?: string[];
    logic?: ConditionalLogic;
}

type QuestionType = 'text' | 'textarea' | 'radio' | 'checkbox' | 'select' | 'rating' | 'nps' | 'matrix';

// === Survey Renderer ===
export function SurveyRenderer({ survey, onSubmit }: { survey: Survey; onSubmit: (responses: any) => void }) {
    const [currentIndex, setCurrentIndex] = useState(0);
    const [responses, setResponses] = useState<Record<string, any>>({});
    
    const currentQuestion = survey.questions[currentIndex];
    const visibleQuestions = survey.questions.filter(q => isQuestionVisible(q, responses));
    
    const handleAnswer = (questionId: string, value: any) => {
        setResponses({ ...responses, [questionId]: value });
    };
    
    const handleNext = () => {
        if (currentIndex < visibleQuestions.length - 1) {
            setCurrentIndex(currentIndex + 1);
        } else {
            onSubmit(responses);
        }
    };
    
    const handlePrevious = () => {
        if (currentIndex > 0) {
            setCurrentIndex(currentIndex - 1);
        }
    };
    
    return (
        <div className="survey">
            <div className="progress-bar">
                <div style={{ width: \`\${((currentIndex + 1) / visibleQuestions.length) * 100}%\` }} />
            </div>
            
            <QuestionRenderer
                question={currentQuestion}
                value={responses[currentQuestion.id]}
                onChange={(value) => handleAnswer(currentQuestion.id, value)}
            />
            
            <div className="navigation">
                {currentIndex > 0 && (
                    <button onClick={handlePrevious}>Previous</button>
                )}
                <button onClick={handleNext} disabled={currentQuestion.required && !responses[currentQuestion.id]}>
                    {currentIndex < visibleQuestions.length - 1 ? 'Next' : 'Submit'}
                </button>
            </div>
        </div>
    );
}

// === Question Types ===
function QuestionRenderer({ question, value, onChange }: QuestionRendererProps) {
    switch (question.type) {
        case 'text':
            return <input type="text" value={value || ''} onChange={(e) => onChange(e.target.value)} />;
        
        case 'textarea':
            return <textarea value={value || ''} onChange={(e) => onChange(e.target.value)} />;
        
        case 'radio':
            return (
                <div className="radio-group">
                    {question.options?.map(option => (
                        <label key={option}>
                            <input
                                type="radio"
                                checked={value === option}
                                onChange={() => onChange(option)}
                            />
                            {option}
                        </label>
                    ))}
                </div>
            );
        
        case 'checkbox':
            return (
                <div className="checkbox-group">
                    {question.options?.map(option => (
                        <label key={option}>
                            <input
                                type="checkbox"
                                checked={(value || []).includes(option)}
                                onChange={(e) => {
                                    const newValue = e.target.checked
                                        ? [...(value || []), option]
                                        : (value || []).filter((v: string) => v !== option);
                                    onChange(newValue);
                                }}
                            />
                            {option}
                        </label>
                    ))}
                </div>
            );
        
        case 'rating':
            return (
                <div className="rating">
                    {[1, 2, 3, 4, 5].map(n => (
                        <button
                            key={n}
                            className={value >= n ? 'active' : ''}
                            onClick={() => onChange(n)}
                        >
                            â˜…
                        </button>
                    ))}
                </div>
            );
        
        case 'nps':
            return (
                <div className="nps">
                    {[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10].map(n => (
                        <button
                            key={n}
                            className={value === n ? 'active' : ''}
                            onClick={() => onChange(n)}
                        >
                            {n}
                        </button>
                    ))}
                    <div className="nps-labels">
                        <span>Not likely</span>
                        <span>Very likely</span>
                    </div>
                </div>
            );
        
        default:
            return null;
    }
}

// === Conditional Logic ===
function isQuestionVisible(question: Question, responses: Record<string, any>): boolean {
    if (!question.logic) return true;
    
    const { condition, questionId, value } = question.logic;
    const answer = responses[questionId];
    
    switch (condition) {
        case 'equals': return answer === value;
        case 'not_equals': return answer !== value;
        case 'contains': return answer?.includes(value);
        case 'greater_than': return answer > value;
        case 'less_than': return answer < value;
        default: return true;
    }
}

export { SurveyRenderer, QuestionRenderer, isQuestionVisible };
`;
    }
}

export const surveyBuilder = SurveyBuilder.getInstance();
