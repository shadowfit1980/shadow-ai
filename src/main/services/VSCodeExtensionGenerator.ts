/**
 * ðŸ’» VS Code Extension Generator
 * 
 * Generate VS Code extensions:
 * - Commands, providers, views
 */

import { EventEmitter } from 'events';

export class VSCodeExtensionGenerator extends EventEmitter {
    private static instance: VSCodeExtensionGenerator;

    private constructor() { super(); }

    static getInstance(): VSCodeExtensionGenerator {
        if (!VSCodeExtensionGenerator.instance) {
            VSCodeExtensionGenerator.instance = new VSCodeExtensionGenerator();
        }
        return VSCodeExtensionGenerator.instance;
    }

    generatePackageJson(): string {
        return `// package.json for VS Code Extension
// Generated by Shadow AI

{
    "name": "my-extension",
    "displayName": "My Extension",
    "description": "A powerful VS Code extension",
    "version": "0.1.0",
    "publisher": "your-publisher",
    "engines": { "vscode": "^1.85.0" },
    "categories": ["Other", "Snippets", "Linters"],
    "keywords": ["productivity", "tools"],
    
    "activationEvents": [
        "onLanguage:typescript",
        "onCommand:myExtension.activate",
        "workspaceContains:**/package.json"
    ],
    
    "main": "./dist/extension.js",
    
    "contributes": {
        "commands": [
            {
                "command": "myExtension.helloWorld",
                "title": "Hello World",
                "category": "My Extension",
                "icon": "$(rocket)"
            },
            {
                "command": "myExtension.analyze",
                "title": "Analyze File",
                "category": "My Extension"
            }
        ],
        
        "keybindings": [
            {
                "command": "myExtension.helloWorld",
                "key": "ctrl+shift+h",
                "when": "editorTextFocus"
            }
        ],
        
        "menus": {
            "editor/context": [
                { "command": "myExtension.analyze", "group": "myExtension" }
            ],
            "explorer/context": [
                { "command": "myExtension.analyze", "group": "myExtension" }
            ]
        },
        
        "configuration": {
            "title": "My Extension",
            "properties": {
                "myExtension.enabled": {
                    "type": "boolean",
                    "default": true,
                    "description": "Enable the extension"
                },
                "myExtension.autoSave": {
                    "type": "boolean",
                    "default": false
                },
                "myExtension.maxItems": {
                    "type": "number",
                    "default": 100,
                    "minimum": 1,
                    "maximum": 1000
                }
            }
        },
        
        "views": {
            "explorer": [
                {
                    "id": "myExtensionView",
                    "name": "My Extension",
                    "contextualTitle": "My Data"
                }
            ]
        },
        
        "viewsContainers": {
            "activitybar": [
                {
                    "id": "myExtensionContainer",
                    "title": "My Extension",
                    "icon": "resources/icon.svg"
                }
            ]
        },
        
        "languages": [
            {
                "id": "myLanguage",
                "extensions": [".myext"],
                "configuration": "./language-configuration.json"
            }
        ],
        
        "snippets": [
            {
                "language": "typescript",
                "path": "./snippets/typescript.json"
            }
        ]
    },
    
    "scripts": {
        "vscode:prepublish": "npm run build",
        "build": "esbuild ./src/extension.ts --bundle --outfile=dist/extension.js --external:vscode --format=cjs --platform=node",
        "watch": "npm run build -- --watch",
        "test": "node ./out/test/runTest.js"
    },
    
    "devDependencies": {
        "@types/vscode": "^1.85.0",
        "@types/node": "^20.0.0",
        "esbuild": "^0.19.0",
        "typescript": "^5.3.0"
    }
}`;
    }

    generateExtension(): string {
        return `// extension.ts
// Generated by Shadow AI

import * as vscode from 'vscode';

export function activate(context: vscode.ExtensionContext) {
    console.log('Extension "my-extension" is now active!');

    // Hello World Command
    const helloWorld = vscode.commands.registerCommand('myExtension.helloWorld', () => {
        vscode.window.showInformationMessage('Hello from My Extension!');
    });

    // Analyze File Command
    const analyze = vscode.commands.registerCommand('myExtension.analyze', async (uri?: vscode.Uri) => {
        const editor = vscode.window.activeTextEditor;
        const fileUri = uri || editor?.document.uri;
        
        if (!fileUri) {
            vscode.window.showWarningMessage('No file selected');
            return;
        }

        await vscode.window.withProgress({
            location: vscode.ProgressLocation.Notification,
            title: 'Analyzing file...',
            cancellable: true
        }, async (progress, token) => {
            progress.report({ increment: 0 });
            
            // Your analysis logic
            await new Promise(resolve => setTimeout(resolve, 1000));
            progress.report({ increment: 50, message: 'Processing...' });
            
            await new Promise(resolve => setTimeout(resolve, 1000));
            progress.report({ increment: 100 });
            
            vscode.window.showInformationMessage('Analysis complete!');
        });
    });

    // Status Bar Item
    const statusBarItem = vscode.window.createStatusBarItem(vscode.StatusBarAlignment.Right, 100);
    statusBarItem.text = '$(rocket) My Extension';
    statusBarItem.command = 'myExtension.helloWorld';
    statusBarItem.tooltip = 'Click to run My Extension';
    statusBarItem.show();

    // Configuration Change Listener
    vscode.workspace.onDidChangeConfiguration(e => {
        if (e.affectsConfiguration('myExtension')) {
            const config = vscode.workspace.getConfiguration('myExtension');
            const enabled = config.get<boolean>('enabled');
            statusBarItem.text = enabled ? '$(rocket) Active' : '$(circle-slash) Disabled';
        }
    });

    // Document Change Listener
    vscode.workspace.onDidChangeTextDocument(e => {
        if (e.contentChanges.length > 0) {
            // Handle document changes
        }
    });

    // File System Watcher
    const watcher = vscode.workspace.createFileSystemWatcher('**/*.ts');
    watcher.onDidChange(uri => console.log('File changed:', uri.fsPath));
    watcher.onDidCreate(uri => console.log('File created:', uri.fsPath));
    watcher.onDidDelete(uri => console.log('File deleted:', uri.fsPath));

    // Tree View Provider
    const treeDataProvider = new MyTreeDataProvider();
    vscode.window.registerTreeDataProvider('myExtensionView', treeDataProvider);
    vscode.commands.registerCommand('myExtension.refreshTree', () => treeDataProvider.refresh());

    // Completion Provider
    const completionProvider = vscode.languages.registerCompletionItemProvider(
        'typescript',
        {
            provideCompletionItems(document, position) {
                const items: vscode.CompletionItem[] = [];
                
                const snippet = new vscode.CompletionItem('mySnippet', vscode.CompletionItemKind.Snippet);
                snippet.insertText = new vscode.SnippetString('console.log($1);');
                snippet.documentation = 'Insert a console.log statement';
                items.push(snippet);
                
                return items;
            }
        },
        '.' // Trigger on dot
    );

    // Hover Provider
    const hoverProvider = vscode.languages.registerHoverProvider('typescript', {
        provideHover(document, position) {
            const range = document.getWordRangeAtPosition(position);
            const word = document.getText(range);
            
            if (word === 'myFunction') {
                return new vscode.Hover(['**myFunction**', 'A custom function']);
            }
        }
    });

    // Code Action Provider
    const codeActionProvider = vscode.languages.registerCodeActionsProvider('typescript', {
        provideCodeActions(document, range, context) {
            const actions: vscode.CodeAction[] = [];
            
            const action = new vscode.CodeAction('Extract to function', vscode.CodeActionKind.RefactorExtract);
            action.command = { command: 'myExtension.extract', title: 'Extract' };
            actions.push(action);
            
            return actions;
        }
    });

    // Register all disposables
    context.subscriptions.push(
        helloWorld, analyze, statusBarItem, watcher,
        completionProvider, hoverProvider, codeActionProvider
    );
}

export function deactivate() {
    console.log('Extension deactivated');
}

// Tree Data Provider
class MyTreeDataProvider implements vscode.TreeDataProvider<TreeItem> {
    private _onDidChangeTreeData = new vscode.EventEmitter<TreeItem | undefined>();
    readonly onDidChangeTreeData = this._onDidChangeTreeData.event;

    refresh() {
        this._onDidChangeTreeData.fire(undefined);
    }

    getTreeItem(element: TreeItem) {
        return element;
    }

    getChildren(element?: TreeItem): TreeItem[] {
        if (!element) {
            return [
                new TreeItem('Item 1', vscode.TreeItemCollapsibleState.Collapsed),
                new TreeItem('Item 2', vscode.TreeItemCollapsibleState.None)
            ];
        }
        return [new TreeItem('Child', vscode.TreeItemCollapsibleState.None)];
    }
}

class TreeItem extends vscode.TreeItem {
    constructor(label: string, collapsibleState: vscode.TreeItemCollapsibleState) {
        super(label, collapsibleState);
        this.tooltip = \`\${this.label} - My item\`;
        this.contextValue = 'myItem';
    }
}`;
    }
}

export const vscodeExtensionGenerator = VSCodeExtensionGenerator.getInstance();
