/**
 * ðŸ“¸ Visual Regression Testing Generator
 * 
 * Generate visual testing:
 * - Percy, Chromatic, Playwright
 */

import { EventEmitter } from 'events';

export class VisualRegressionTesting extends EventEmitter {
    private static instance: VisualRegressionTesting;

    private constructor() { super(); }

    static getInstance(): VisualRegressionTesting {
        if (!VisualRegressionTesting.instance) {
            VisualRegressionTesting.instance = new VisualRegressionTesting();
        }
        return VisualRegressionTesting.instance;
    }

    generate(): string {
        return `// Visual Regression Testing
// Generated by Shadow AI

// === Percy with Playwright ===
import { test, expect } from '@playwright/test';
import percySnapshot from '@percy/playwright';

test.describe('Visual Regression Tests', () => {
    test('homepage visual test', async ({ page }) => {
        await page.goto('/');
        await page.waitForLoadState('networkidle');
        
        // Take Percy snapshot
        await percySnapshot(page, 'Homepage');
    });

    test('responsive visual test', async ({ page }) => {
        await page.goto('/');
        
        // Desktop
        await page.setViewportSize({ width: 1920, height: 1080 });
        await percySnapshot(page, 'Homepage - Desktop');
        
        // Tablet
        await page.setViewportSize({ width: 768, height: 1024 });
        await percySnapshot(page, 'Homepage - Tablet');
        
        // Mobile
        await page.setViewportSize({ width: 375, height: 667 });
        await percySnapshot(page, 'Homepage - Mobile');
    });

    test('component states', async ({ page }) => {
        await page.goto('/components/button');
        
        // Default state
        await percySnapshot(page, 'Button - Default');
        
        // Hover state
        await page.hover('.button');
        await percySnapshot(page, 'Button - Hover');
        
        // Focus state
        await page.focus('.button');
        await percySnapshot(page, 'Button - Focus');
        
        // Disabled state
        await page.click('[data-testid="toggle-disabled"]');
        await percySnapshot(page, 'Button - Disabled');
    });

    test('dark mode', async ({ page }) => {
        await page.goto('/');
        
        // Light mode
        await percySnapshot(page, 'Homepage - Light Mode');
        
        // Toggle dark mode
        await page.click('[data-testid="theme-toggle"]');
        await page.waitForTimeout(300); // Wait for transition
        
        // Dark mode
        await percySnapshot(page, 'Homepage - Dark Mode');
    });
});

// === Playwright Screenshot Comparison ===
import { test, expect } from '@playwright/test';

test.describe('Playwright Visual Tests', () => {
    test('page screenshot', async ({ page }) => {
        await page.goto('/');
        await expect(page).toHaveScreenshot('homepage.png', {
            fullPage: true,
            animations: 'disabled'
        });
    });

    test('element screenshot', async ({ page }) => {
        await page.goto('/dashboard');
        const chart = page.locator('.chart-container');
        
        await expect(chart).toHaveScreenshot('dashboard-chart.png', {
            threshold: 0.2 // Allow 20% pixel difference
        });
    });

    test('with mask', async ({ page }) => {
        await page.goto('/profile');
        await expect(page).toHaveScreenshot('profile.png', {
            mask: [
                page.locator('.avatar'), // Mask dynamic avatar
                page.locator('.timestamp') // Mask timestamps
            ]
        });
    });
});

// playwright.config.ts
import { defineConfig } from '@playwright/test';

export default defineConfig({
    expect: {
        toHaveScreenshot: {
            maxDiffPixels: 100,
            maxDiffPixelRatio: 0.01,
            threshold: 0.2
        }
    },
    snapshotDir: './visual-snapshots',
    updateSnapshots: process.env.UPDATE_SNAPSHOTS ? 'all' : 'missing'
});

// === Chromatic (Storybook) ===
// package.json scripts
{
    "scripts": {
        "chromatic": "npx chromatic --project-token=$CHROMATIC_TOKEN"
    }
}

// .github/workflows/chromatic.yml
/*
name: Chromatic
on: push
jobs:
  chromatic:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - run: npm ci
      - uses: chromaui/action@latest
        with:
          projectToken: \${{ secrets.CHROMATIC_TOKEN }}
          exitOnceUploaded: true
          onlyChanged: true
*/

// === Custom Screenshot Comparison ===
import pixelmatch from 'pixelmatch';
import { PNG } from 'pngjs';
import fs from 'fs';

async function compareScreenshots(
    baselinePath: string,
    currentPath: string,
    diffPath: string
): Promise<{ match: boolean; diffPixels: number; percentage: number }> {
    const baseline = PNG.sync.read(fs.readFileSync(baselinePath));
    const current = PNG.sync.read(fs.readFileSync(currentPath));
    
    const { width, height } = baseline;
    const diff = new PNG({ width, height });
    
    const diffPixels = pixelmatch(
        baseline.data,
        current.data,
        diff.data,
        width,
        height,
        { threshold: 0.1, includeAA: false }
    );
    
    fs.writeFileSync(diffPath, PNG.sync.write(diff));
    
    const totalPixels = width * height;
    const percentage = (diffPixels / totalPixels) * 100;
    
    return {
        match: diffPixels === 0,
        diffPixels,
        percentage: Math.round(percentage * 100) / 100
    };
}

export { compareScreenshots };
`;
    }
}

export const visualRegressionTesting = VisualRegressionTesting.getInstance();
